<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d7377">
    <meta name="description" content="RegistraTe - Sistema integral de gesti√≥n educativa para docentes">
    <title>RegistraTe - Sistema de Gesti√≥n Educativa</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiUmVnaXN0cmFUZSIsInNob3J0X25hbWUiOiJSZWdpc3RyYVRlIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMwZDczNzciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ2NpcmNsZSBjeD0nNTAnIGN5PSc1MCcgcj0nNDUnIGZpbGw9JyMwZDczNzcnLzUzRSUzQ3RleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzQ1JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOTQlOUUlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIifSx7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgNTEyIDUxMiclM0UlM0NjaXJjbGUgY3g9JzI1NicgY3k9JzI1Nicgcj0nMjQwJyBmaWxsPScjMGQ3Mzc3Jy8lM0UlM0N0ZXh0IHg9JzI1NicgeT0nMzMwJyBmb250LXNpemU9JzI0MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnJTNBJUYwJTlGJTk0JTlFJTNFL3RleHQlM0UlM0Mvc3ZnJTNFIiwic2l6ZXMiOiI1MTJ4NTEyIn1dfQ==">
    
    <!-- CDNs necesarios -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        :root {
            --primary: #0d7377;
            --primary-dark: #095c5f;
            --secondary: #14919b;
            --accent: #3fbac2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --purple: #6f42c1;
            --pink: #e83e8c;
            --orange: #fd7e14;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius: 10px;
            --radius-lg: 16px;
        }
        
        body {
            background: #f0f2f5;
            color: var(--gray-800);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--gray-200); }
        ::-webkit-scrollbar-thumb { background: var(--gray-400); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gray-500); }
        
        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .login-screen::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
        }
        
        .login-box {
            background: white;
            border-radius: var(--radius-lg);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo { text-align: center; margin-bottom: 30px; }
        .logo-icon {
            width: 90px; height: 90px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            box-shadow: 0 10px 30px rgba(13, 115, 119, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .logo h1 { font-size: 32px; color: var(--primary); font-weight: 800; margin-bottom: 5px; letter-spacing: -0.5px; }
        .logo p { color: var(--gray-600); font-size: 14px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--gray-700); font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 15px;
            transition: all 0.2s;
            background: white;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 115, 119, 0.1);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .btn {
            width: 100%; padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(13, 115, 119, 0.4); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); margin-top: 10px; }
        .btn-secondary:hover { background: var(--gray-100); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: var(--gray-900); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-small { padding: 8px 16px; font-size: 13px; width: auto; display: inline-flex; }
        .btn-ghost { background: transparent; border: 1px solid var(--gray-300); color: var(--gray-700); }
        .btn-ghost:hover { background: var(--gray-100); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-brand { display: flex; align-items: center; gap: 12px; cursor: pointer; transition: opacity 0.2s; }
        .header-brand:hover { opacity: 0.9; }
        .header-brand .icon {
            width: 40px; height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header-brand h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        
        .notification-bell {
            position: relative;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
        }
        .notification-bell:hover { background: rgba(255,255,255,0.2); }
        .notification-badge {
            position: absolute;
            top: -2px; right: -2px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            width: 18px; height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary);
        }
        
        .header-user { display: flex; align-items: center; gap: 12px; }
        .user-info { text-align: right; }
        .user-name { font-size: 14px; font-weight: 600; }
        .user-role { font-size: 12px; opacity: 0.8; }
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: var(--radius);
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.25); }
        
        /* Navigation */
        .nav {
            background: var(--primary);
            padding: 0 24px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .nav::-webkit-scrollbar { display: none; }
        .nav-content { display: flex; gap: 4px; min-width: max-content; }
        .nav-item {
            padding: 14px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .nav-item:hover, .nav-item.active {
            color: white;
            border-bottom-color: #fff;
            background: rgba(255,255,255,0.05);
        }
        
        /* Main Content */
        .main { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
        }
        .page-header-title h2 { font-size: 28px; color: var(--gray-800); font-weight: 700; letter-spacing: -0.5px; }
        .page-header p { color: var(--gray-600); margin-top: 4px; font-size: 15px; }
        .page-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* Cards y Grid */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-lg); }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }
        .card-title { font-size: 18px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px; }
        
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        
        @media (max-width: 1024px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        
        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow);
        }
        .stat-icon {
            width: 48px; height: 48px;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .stat-info h4 { font-size: 24px; font-weight: 700; color: var(--gray-800); }
        .stat-info p { font-size: 13px; color: var(--gray-600); }
        
        /* Secciones Grid */
        .secciones-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 24px; }
        .seccion-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .seccion-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        .seccion-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .seccion-card h3 { font-size: 20px; color: var(--gray-800); margin-bottom: 12px; font-weight: 700; }
        .seccion-info {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .seccion-info strong { color: var(--gray-700); min-width: 80px; }
        
        .btn-ver-est {
            display: inline-flex;
            margin: 16px 0;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
            gap: 6px;
        }
        .btn-ver-est:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .periodos-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-700);
            margin: 20px 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .periodo-item { margin-bottom: 16px; padding: 12px; background: var(--gray-100); border-radius: var(--radius); }
        .periodo-nombre {
            font-size: 14px;
            color: var(--gray-700);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        .periodo-nombre::before { content: "‚Ä¢"; color: var(--primary); font-size: 20px; }
        .botones-evaluacion { display: flex; flex-wrap: wrap; gap: 6px; }
        .btn-eval {
            padding: 6px 12px;
            border: none;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .btn-eval:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-trabajo { background: var(--purple); color: white; }
        .btn-tareas { background: #20c997; color: white; }
        .btn-pruebas { background: var(--success); color: white; }
        .btn-asistencia { background: var(--warning); color: var(--gray-900); }
        .btn-reporte { background: var(--danger); color: white; }
        .btn-proyecto { background: var(--info); color: white; }
        .btn-bitacora { background: var(--orange); color: white; }
        
        /* Filtros */
        .filtros-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }
        .filtro-item { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px; }
        .filtro-item label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filtro-item select, .filtro-item input {
            padding: 10px 14px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            transition: all 0.2s;
        }
        .filtro-item select:focus, .filtro-item input:focus { outline: none; border-color: var(--primary); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--gray-100);
            padding: 6px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            width: fit-content;
        }
        .tab {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }
        .tab.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }
        .tab:hover:not(.active) { color: var(--gray-800); }
        
        /* Tablas */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th {
            background: var(--gray-100);
            padding: 16px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-300);
            white-space: nowrap;
        }
        td { padding: 14px 12px; border-bottom: 1px solid var(--gray-200); vertical-align: middle; }
        tr:hover { background: #f8f9fa; }
        .table-actions { display: flex; gap: 6px; }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            gap: 4px;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-primary { background: #e3f2fd; color: #1976d2; }
        
        /* Inputs de notas */
        .nota-input {
            width: 70px;
            padding: 8px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            text-align: center;
            font-weight: 700;
            font-size: 15px;
            transition: all 0.2s;
        }
        .nota-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(13, 115, 119, 0.1); }
        .nota-input.saved { border-color: var(--success); background: #f0fff4; }
        .nota-input.error { border-color: var(--danger); background: #fff5f5; }
        .nota-input.saving { border-color: var(--warning); background: #fffdf5; }
        .save-status { font-size: 16px; margin-left: 4px; }
        
        /* Indicadores de Logro */
        .indicadores-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .indicadores-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .indicadores-header h3 { font-size: 18px; color: var(--gray-800); font-weight: 700; }
        .indicador-card {
            background: var(--gray-100);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
            transition: all 0.2s;
        }
        .indicador-card:hover { transform: translateX(4px); box-shadow: var(--shadow); }
        .indicador-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .indicador-titulo { font-weight: 700; color: var(--gray-800); font-size: 15px; flex: 1; padding-right: 12px; }
        .indicador-porcentaje {
            background: var(--primary);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }
        .indicador-descripcion { color: var(--gray-600); font-size: 14px; margin-bottom: 16px; line-height: 1.6; }
        .indicador-meta { display: flex; gap: 16px; font-size: 13px; color: var(--gray-600); margin-bottom: 12px; }
        .indicador-acciones { display: flex; gap: 8px; }
        
        /* Horario - Grilla */
        .horario-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            overflow-x: auto;
            box-shadow: var(--shadow);
        }
        .horario-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 8px; min-width: 800px; }
        .horario-header {
            background: var(--gray-100);
            padding: 16px;
            text-align: center;
            font-weight: 700;
            color: var(--gray-700);
            border-radius: var(--radius);
            font-size: 14px;
        }
        .horario-leccion {
            background: var(--gray-100);
            padding: 16px;
            text-align: center;
            font-weight: 700;
            color: var(--gray-600);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .horario-celda {
            padding: 12px;
            border-radius: var(--radius);
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }
        .horario-celda:hover { transform: scale(1.02); box-shadow: var(--shadow-lg); z-index: 10; }
        .horario-celda.vacio { background: #f8f9fa; border: 2px dashed var(--gray-300); color: var(--gray-400); }
        .horario-celda.vacio:hover { background: var(--gray-100); border-color: var(--primary); color: var(--primary); }
        .horario-celda.matematicas { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
        .horario-celda.ciencias { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .horario-celda.espanol { background: #e3f2fd; color: #1565c0; border-color: #90caf9; }
        .horario-celda.sociales { background: #fff3e0; color: #ef6c00; border-color: #ffcc80; }
        .horario-celda.ingles { background: #f3e5f5; color: #6a1b9a; border-color: #ce93d8; }
        .horario-celda.civica { background: #fce4ec; color: #c2185b; border-color: #f48fb1; }
        .horario-materia { font-weight: 700; font-size: 13px; margin-bottom: 4px; line-height: 1.3; }
        .horario-seccion { font-size: 11px; opacity: 0.9; font-weight: 600; }
        .horario-inst { font-size: 10px; opacity: 0.8; margin-top: 4px; }
        
        /* Asistencia - Calendario */
        .calendario-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .calendario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendario-mes { font-size: 20px; font-weight: 700; color: var(--gray-800); }
        .calendario-nav { display: flex; gap: 8px; }
        .calendario-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .calendario-dia-header {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--gray-600);
            text-transform: uppercase;
            padding: 8px;
        }
        .calendario-dia {
            aspect-ratio: 1;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: white;
        }
        .calendario-dia:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow); }
        .calendario-dia.hoy { border-color: var(--primary); background: #e3f2fd; }
        .calendario-dia.completo { border-color: var(--success); background: #f0fff4; }
        .calendario-dia.incompleto { border-color: var(--danger); background: #fff5f5; }
        .calendario-dia.feriado { background: var(--gray-100); opacity: 0.5; cursor: not-allowed; }
        .calendario-dia-numero { font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .calendario-dia-estado { font-size: 20px; margin-top: 4px; }
        
        /* Tarjetas de Lecciones */
        .lecciones-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 24px; }
        .leccion-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .leccion-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: var(--primary);
        }
        .leccion-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .leccion-card.completada { border-color: var(--success); }
        .leccion-card.completada::before { background: var(--success); }
        .leccion-card.seleccionada { border-color: var(--info); background: #f0f9ff; }
        .leccion-card.seleccionada::before { background: var(--info); }
        .leccion-numero { font-size: 16px; font-weight: 700; color: var(--gray-800); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .leccion-info { color: var(--gray-600); font-size: 14px; margin-bottom: 4px; }
        .leccion-estado {
            position: absolute;
            top: 12px; right: 12px;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .leccion-estado.completo { background: var(--success); color: white; }
        .leccion-estado.incompleto { background: var(--danger); color: white; }
        .leccion-acciones { display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200); }
        
        /* Lista de Asistencia */
        .asistencia-lista { background: white; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow); }
        .asistencia-estudiante {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            transition: background 0.2s;
        }
        .asistencia-estudiante:hover { background: var(--gray-100); }
        .asistencia-estudiante:last-child { border-bottom: none; }
        .estudiante-info { display: flex; align-items: center; gap: 12px; }
        .estudiante-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        .estudiante-nombre { font-weight: 600; color: var(--gray-800); }
        .estudiante-acs { font-size: 12px; color: var(--orange); font-weight: 600; margin-top: 2px; }
        .asistencia-opciones { display: flex; gap: 8px; }
        .asistencia-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .asistencia-btn:hover { border-color: var(--primary); color: var(--primary); }
        .asistencia-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .asistencia-btn.presente.active { background: var(--success); border-color: var(--success); }
        .asistencia-btn.ausente-j.active { background: var(--warning); border-color: var(--warning); color: var(--gray-900); }
        .asistencia-btn.ausente-i.active { background: var(--danger); border-color: var(--danger); }
        .asistencia-btn.tardanza.active { background: var(--info); border-color: var(--info); }
        
        /* Bit√°coras */
        .bitacora-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--info);
            transition: all 0.2s;
        }
        .bitacora-card:hover { transform: translateX(4px); }
        .bitacora-card.recordatorio { border-left-color: var(--warning); background: #fffdf5; }
        .bitacora-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .bitacora-titulo { font-size: 16px; font-weight: 700; color: var(--gray-800); display: flex; align-items: center; gap: 8px; }
        .bitacora-fecha { color: var(--gray-500); font-size: 13px; display: flex; align-items: center; gap: 4px; }
        .bitacora-contenido { color: var(--gray-700); line-height: 1.8; font-size: 15px; margin-bottom: 16px; }
        .bitacora-meta { display: flex; gap: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200); flex-wrap: wrap; }
        .bitacora-meta-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--gray-600); }
        .bitacora-acciones { display: flex; gap: 8px; margin-top: 16px; }
        
        /* Reportes Oficiales */
        .reporte-oficial {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            padding: 60px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: var(--radius-lg);
        }
        .reporte-membrete {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }
        .reporte-logo-mep { display: flex; align-items: center; gap: 16px; }
        .reporte-logo-mep .escudo {
            width: 60px; height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
        }
        .reporte-logo-mep h4 { font-size: 14px; color: var(--gray-700); line-height: 1.4; }
        .reporte-inst { text-align: right; }
        .reporte-inst h4 { font-size: 14px; color: var(--gray-700); }
        .reporte-titulo { text-align: center; margin: 40px 0; }
        .reporte-titulo h2 { font-size: 20px; color: var(--gray-800); margin-bottom: 10px; }
        .reporte-titulo p { color: var(--gray-600); font-size: 14px; }
        .reporte-tabla { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .reporte-tabla th, .reporte-tabla td {
            border: 1px solid var(--gray-400);
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }
        .reporte-tabla th { background: var(--gray-100); font-weight: 700; }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlide 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .modal-lg { max-width: 900px; }
        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-50);
        }
        .modal-header h3 { font-size: 18px; color: var(--gray-800); font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .modal-close {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--gray-200);
            color: var(--gray-600);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover { background: var(--gray-300); color: var(--gray-800); }
        .modal-body { padding: 24px; overflow-y: auto; max-height: 60vh; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--gray-200); display: flex; gap: 12px; justify-content: flex-end; background: var(--gray-50); }
        
        /* Formularios */
        .form-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--gray-200); }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .form-section-title { font-size: 14px; font-weight: 700; color: var(--gray-800); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .form-check { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 0; }
        .form-check input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
        .form-check label { cursor: pointer; font-size: 14px; color: var(--gray-700); }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .toast {
            background: white;
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--info); }
        .toast.warning { border-left-color: var(--warning); }
        .toast-icon { font-size: 20px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; color: var(--gray-800); font-size: 14px; }
        .toast-message { color: var(--gray-600); font-size: 13px; margin-top: 2px; }
        
        /* Alertas MEP */
        .alert-mep {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .alert-mep.error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .alert-mep.success { background: #d4edda; border-color: #28a745; color: #155724; }
        
        /* Utilidades */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-6 { margin-top: 24px; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--gray-500); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 18px; color: var(--gray-700); margin-bottom: 8px; }
        .empty-state p { font-size: 14px; max-width: 400px; margin: 0 auto; }
        
        /* Loading */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main { padding: 16px; }
            .secciones-grid { grid-template-columns: 1fr; }
            .header-top { padding: 12px 16px; }
            .header-brand h1 { font-size: 18px; }
            .nav { padding: 0 16px; }
            .login-box { padding: 24px; }
            .reporte-oficial { padding: 24px; }
            .calendario-grid { gap: 8px; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        /* Estudiantes ACS */
        .fila-acs { background: #fff3e0 !important; border-left: 3px solid var(--orange); }
        .fila-acs:hover { background: #ffe0b2 !important; }
        
        /* Estados de validaci√≥n */
        .validacion-ok { color: var(--success); font-weight: 600; }
        .validacion-error { color: var(--danger); font-weight: 600; }
        .validacion-warning { color: var(--warning); font-weight: 600; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">
                <div class="logo-icon">üìö</div>
                <h1>RegistraTe</h1>
                <p>Sistema Integral de Gesti√≥n Educativa</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Correo electr√≥nico</label>
                    <input type="email" id="loginEmail" placeholder="profesor@escuela.edu" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span>üöÄ</span> Iniciar Sesi√≥n
                </button>
                <button type="button" class="btn btn-secondary" onclick="app.register()">
                    <span>‚ú®</span> Crear cuenta gratis
                </button>
            </form>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                <button type="button" class="btn btn-ghost" onclick="app.installPWA()" id="installBtn" style="display: none;">
                    <span>üì±</span> Instalar aplicaci√≥n
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 20px; color: var(--gray-500); font-size: 13px;">
                Versi√≥n 2.0 - Optimizado para docentes MEP 2026
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="header-brand" onclick="app.navigate('inicio')">
                    <div class="icon">üìö</div>
                    <h1>RegistraTe</h1>
                </div>
                <div class="header-actions">
                    <div class="notification-bell" onclick="app.showNotifications()">
                        üîî
                        <span class="notification-badge" id="notifBadge" style="display: none;">0</span>
                    </div>
                    <div class="header-user">
                        <div class="user-info">
                            <div class="user-name" id="userName">Docente</div>
                            <div class="user-role">Profesor/a</div>
                        </div>
                        <button class="btn-logout" onclick="app.logout()">Salir</button>
                    </div>
                </div>
            </div>
            <nav class="nav">
                <div class="nav-content">
                    <a class="nav-item active" data-page="inicio" onclick="app.navigate('inicio')">üè† Inicio</a>
                    <a class="nav-item" data-page="instituciones" onclick="app.navigate('instituciones')">üèõÔ∏è Instituciones</a>
                    <a class="nav-item" data-page="secciones" onclick="app.navigate('secciones')">üë• Secciones</a>
                    <a class="nav-item" data-page="asignaturas" onclick="app.navigate('asignaturas')">üìñ Asignaturas</a>
                    <a class="nav-item" data-page="horario" onclick="app.navigate('horario')">üìÖ Horario</a>
                    <a class="nav-item" data-page="bitacora" onclick="app.navigate('bitacora')">üìù Bit√°cora</a>
                    <a class="nav-item" data-page="asistencia" onclick="app.navigate('asistencia')">‚úì Asistencia</a>
                    <a class="nav-item" data-page="evaluaciones" onclick="app.navigate('evaluaciones')">üìä Evaluaciones</a>
                    <a class="nav-item" data-page="reportes" onclick="app.navigate('reportes')">üìà Reportes</a>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Inicio / Dashboard -->
            <div class="page active" id="page-inicio">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Panel de Control</h2>
                        <p>Bienvenido a tu espacio de gesti√≥n educativa MEP 2026</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary btn-small" onclick="app.syncData()">
                            <span>üîÑ</span> Sincronizar
                        </button>
                    </div>
                </div>
                
                <div class="grid-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-icon">üèõÔ∏è</div>
                        <div class="stat-info">
                            <h4 id="statInstituciones">0</h4>
                            <p>Instituciones</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--success), #20c997);">üë•</div>
                        <div class="stat-info">
                            <h4 id="statSecciones">0</h4>
                            <p>Secciones</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning), #ffa726);">üìñ</div>
                        <div class="stat-info">
                            <h4 id="statAsignaturas">0</h4>
                            <p>Asignaturas</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--purple), #9c27b0);">üéì</div>
                        <div class="stat-info">
                            <h4 id="statEstudiantes">0</h4>
                            <p>Estudiantes</p>
                        </div>
                    </div>
                </div>
                
                <div class="secciones-grid" id="dashboardSecciones">
                    <!-- Secciones se cargan din√°micamente -->
                </div>
            </div>

            <!-- Instituciones -->
            <div class="page" id="page-instituciones">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Mis Instituciones</h2>
                        <p>Gestiona los centros educativos donde impartes clases (M√°ximo 3)</p>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="app.openModal('nuevaInstitucion')" id="btnNuevaInstitucion">
                        <span>‚ûï</span> Nueva Instituci√≥n
                    </button>
                </div>
                
                <div class="grid-3" id="listaInstituciones">
                    <!-- Instituciones se cargan aqu√≠ -->
                </div>
            </div>

            <!-- Secciones -->
            <div class="page" id="page-secciones">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Mis Secciones</h2>
                        <p>Gestiona tus grupos y per√≠odos acad√©micos</p>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="app.openModal('nuevaSeccion')">
                        <span>‚ûï</span> Nueva Secci√≥n
                    </button>
                </div>
                
                <div class="secciones-grid" id="listaSecciones">
                    <!-- Secciones se cargan aqu√≠ -->
                </div>
            </div>

            <!-- Asignaturas -->
            <div class="page" id="page-asignaturas">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Asignaturas</h2>
                        <p>Configura materias, porcentajes de evaluaci√≥n y reglas MEP</p>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="app.openModal('nuevaAsignatura')">
                        <span>‚ûï</span> Nueva Asignatura
                    </button>
                </div>
                
                <div class="filtros-bar">
                    <div class="filtro-item">
                        <label>Filtrar por Secci√≥n</label>
                        <select id="filtroAsignaturaSeccion" onchange="app.renderAsignaturas()">
                            <option value="">Todas las secciones</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid-2" id="listaAsignaturas">
                    <!-- Asignaturas se cargan aqu√≠ -->
                </div>
            </div>

            <!-- Horario -->
            <div class="page" id="page-horario">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Horario de Clases</h2>
                        <p>Planificaci√≥n semanal y configuraci√≥n de lecciones</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-ghost btn-small" onclick="app.openModal('configHorario')">
                            ‚öôÔ∏è Configuraci√≥n
                        </button>
                        <button class="btn btn-primary btn-small" onclick="app.openModal('agregarLeccionHorario')">
                            <span>‚ûï</span> Agregar clase
                        </button>
                    </div>
                </div>
                
                <div class="card mb-6">
                    <div class="form-check">
                        <input type="checkbox" id="mostrarInstitucionHorario" onchange="app.renderHorario()">
                        <label for="mostrarInstitucionHorario">Mostrar nombre de instituci√≥n en las celdas</label>
                    </div>
                </div>
                
                <div class="horario-container">
                    <div class="horario-grid" id="horarioGrid">
                        <!-- Horario se genera din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Bit√°cora -->
            <div class="page" id="page-bitacora">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Bit√°cora de Clases</h2>
                        <p>Registro de actividades y recordatorios MEP</p>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="app.openModal('nuevaBitacora')">
                        <span>‚ûï</span> Nueva Entrada
                    </button>
                </div>
                
                <div class="filtros-bar">
                    <div class="filtro-item">
                        <label>Buscar contenido</label>
                        <input type="text" id="buscarBitacora" placeholder="Palabra clave..." onkeyup="app.renderBitacora()">
                    </div>
                    <div class="filtro-item">
                        <label>Filtrar por Asignatura</label>
                        <select id="filtroBitacoraAsignatura" onchange="app.renderBitacora()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-ghost btn-small" onclick="app.descargarBitacoras()">
                            üìù Descargar Word
                        </button>
                    </div>
                </div>
                
                <div id="listaBitacoras">
                    <!-- Bit√°coras se cargan aqu√≠ -->
                </div>
            </div>

            <!-- Asistencia -->
            <div class="page" id="page-asistencia">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Control de Asistencia</h2>
                        <p>Registro diario y reportes de asistencia MEP 2026</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-warning btn-small" onclick="app.modoRegistroAsistencia()">
                            üü° Registro de Asistencia
                        </button>
                        <button class="btn btn-info btn-small" onclick="app.modoReporteAsistencia()">
                            üîµ Reporte de Asistencia
                        </button>
                    </div>
                </div>
                
                <!-- Modo Registro -->
                <div id="modoRegistroAsistencia">
                    <div class="calendario-container">
                        <div class="calendario-header">
                            <button class="btn btn-ghost btn-small" onclick="app.cambiarMes(-1)">‚Üê Anterior</button>
                            <div class="calendario-mes" id="calendarioMes">Enero 2025</div>
                            <button class="btn btn-ghost btn-small" onclick="app.cambiarMes(1)">Siguiente ‚Üí</button>
                        </div>
                        <div class="calendario-grid" id="calendarioGrid">
                            <!-- Calendario se genera din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="card" id="panelRegistroAsistencia" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                üìã Registro del <span id="fechaSeleccionadaTexto">--</span>
                            </div>
                        </div>
                        
                        <div class="filtros-bar" style="margin-bottom: 20px;">
                            <div class="filtro-item">
                                <label>Secci√≥n *</label>
                                <select id="asistenciaSeccion" onchange="app.cargarAsignaturasAsistencia()">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="filtro-item">
                                <label>Asignatura</label>
                                <select id="asistenciaAsignatura" onchange="app.cargarLeccionesDia()">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="filtro-item">
                                <label>Lecci√≥n *</label>
                                <select id="asistenciaLeccion" onchange="app.cargarListaAsistencia()">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="listaAsistenciaEstudiantes" style="display: none;">
                            <!-- Lista de estudiantes para pasar lista -->
                        </div>
                    </div>
                </div>
                
                <!-- Modo Reporte -->
                <div id="modoReporteAsistencia" style="display: none;">
                    <div class="filtros-bar">
                        <div class="filtro-item">
                            <label>Per√≠odo</label>
                            <select id="reporteAsistenciaPeriodo" onchange="app.renderReporteAsistencia()">
                                <option value="I">I Per√≠odo</option>
                                <option value="II">II Per√≠odo</option>
                                <option value="III">III Per√≠odo</option>
                            </select>
                        </div>
                        <div class="filtro-item">
                            <label>Asignatura *</label>
                            <select id="reporteAsistenciaAsignatura" onchange="app.renderReporteAsistencia()">
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="filtro-item">
                            <label>Buscar estudiante</label>
                            <input type="text" id="buscarReporteAsistencia" placeholder="Nombre..." onkeyup="app.renderReporteAsistencia()">
                        </div>
                        <div class="filtro-item" style="display: flex; align-items: flex-end; gap: 8px;">
                            <button class="btn btn-ghost btn-small" onclick="app.descargarReporteAsistencia('excel')">üìä Excel</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="tablaReporteAsistencia">
                            <thead>
                                <tr>
                                    <th>ID SEA</th>
                                    <th>Estudiante</th>
                                    <th>Aus. Justificadas</th>
                                    <th>Tardanzas</th>
                                    <th>Aus. por Tardanza</th>
                                    <th>Aus. Injustificadas</th>
                                    <th>Total Aus. Injust.</th>
                                    <th>% Asistencia</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Evaluaciones -->
            <div class="page" id="page-evaluaciones">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Evaluaciones</h2>
                        <p>Gesti√≥n de trabajo cotidiano, tareas, pruebas y proyectos MEP</p>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="app.cambiarTabEvaluacion('trabajo', this)">üìã Trabajo Cotidiano</button>
                    <button class="tab" onclick="app.cambiarTabEvaluacion('tareas', this)">üìö Tareas</button>
                    <button class="tab" onclick="app.cambiarTabEvaluacion('pruebas', this)">üìù Pruebas</button>
                    <button class="tab" onclick="app.cambiarTabEvaluacion('proyecto', this)">üéØ Proyecto</button>
                </div>
                
                <div class="filtros-bar">
                    <div class="filtro-item">
                        <label>Asignatura *</label>
                        <select id="evalAsignatura" onchange="app.cargarEvaluacion()">
                            <option value="">Seleccionar asignatura...</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Per√≠odo *</label>
                        <select id="evalPeriodo" onchange="app.cargarEvaluacion()">
                            <option value="I">I Per√≠odo</option>
                            <option value="II">II Per√≠odo</option>
                            <option value="III">III Per√≠odo</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary btn-small" onclick="app.openModal('configEvaluacion')">
                            ‚öôÔ∏è Configurar
                        </button>
                    </div>
                </div>
                
                <div id="alertasMEP" class="alert-mep" style="display: none;"></div>
                
                <!-- Contenido din√°mico de evaluaciones -->
                <div id="contenidoEvaluacion">
                    <!-- Se carga seg√∫n el tab seleccionado -->
                </div>
            </div>

            <!-- Reportes -->
            <div class="page" id="page-reportes">
                <div class="page-header">
                    <div class="page-header-title">
                        <h2>Reportes y Estad√≠sticas</h2>
                        <p>Generaci√≥n de informes oficiales MEP y an√°lisis de rendimiento</p>
                    </div>
                </div>
                
                <div class="grid-2 mb-6">
                    <div class="card" style="cursor: pointer;" onclick="app.openModal('reportePeriodo')">
                        <div class="card-title">üìä Reporte por Per√≠odo (SEA)</div>
                        <p style="color: var(--gray-600); font-size: 14px; margin-top: 8px;">
                            Genera CSV compatible con el sistema SEA del MEP
                        </p>
                    </div>
                    <div class="card" style="cursor: pointer;" onclick="app.openModal('reporteAnual')">
                        <div class="card-title">üìà Reporte Anual</div>
                        <p style="color: var(--gray-600); font-size: 14px; margin-top: 8px;">
                            Visualiza notas finales y desglose por per√≠odo
                        </p>
                    </div>
                    <div class="card" style="cursor: pointer;" onclick="app.openModal('reporteIndividual')">
                        <div class="card-title">üë§ Reporte Individual</div>
                        <p style="color: var(--gray-600); font-size: 14px; margin-top: 8px;">
                            Informe personalizado en PDF por estudiante
                        </p>
                    </div>
                    <div class="card" style="cursor: pointer;" onclick="app.openModal('reporteEximidos')">
                        <div class="card-title">‚úÖ Reporte de Eximidos</div>
                        <p style="color: var(--gray-600); font-size: 14px; margin-top: 8px;">
                            Identifica estudiantes que cumplen condici√≥n de eximici√≥n
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nueva Instituci√≥n -->
    <div class="modal-overlay" id="modalNuevaInstitucion">
        <div class="modal">
            <div class="modal-header">
                <h3>üèõÔ∏è Nueva Instituci√≥n</h3>
                <button class="modal-close" onclick="app.closeModal('nuevaInstitucion')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre de la Instituci√≥n *</label>
                    <input type="text" id="instNombre" placeholder="Ej: Escuela Rep√∫blica de Francia" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Direcci√≥n Regional</label>
                        <input type="text" id="instRegional" placeholder="Ej: Direcci√≥n Regional de Lim√≥n">
                    </div>
                    <div class="form-group">
                        <label>Circuito Escolar</label>
                        <input type="text" id="instCircuito" placeholder="Ej: Circuito 10">
                    </div>
                </div>
                <div class="form-group">
                    <label>C√≥digo de Instituci√≥n (MEP)</label>
                    <input type="text" id="instCodigo" placeholder="Ej: 50601234">
                </div>
                <div class="form-group">
                    <label>Logo de la Instituci√≥n</label>
                    <input type="file" id="instLogo" accept="image/*" onchange="app.procesarLogoInstitucion(this)">
                    <small style="color: var(--gray-600);">Formato JPG o PNG recomendado</small>
                    <img id="previewLogo" style="max-width: 100px; margin-top: 10px; display: none; border-radius: var(--radius);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('nuevaInstitucion')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarInstitucion()">Guardar Instituci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Secci√≥n -->
    <div class="modal-overlay" id="modalNuevaSeccion">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>‚ûï Nueva Secci√≥n</h3>
                <button class="modal-close" onclick="app.closeModal('nuevaSeccion')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-section-title">üìã Informaci√≥n General</div>
                    <div class="form-group">
                        <label>Instituci√≥n *</label>
                        <select id="secInstitucion" required>
                            <option value="">Seleccionar instituci√≥n...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de Secci√≥n *</label>
                            <input type="text" id="secNombre" placeholder="Ej: 10-1, 6-2, 11B" required>
                        </div>
                        <div class="form-group">
                            <label>A√±o Lectivo *</label>
                            <input type="number" id="secAnio" value="2025" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de Per√≠odos *</label>
                        <select id="secNumPeriodos" onchange="app.generarCamposPeriodos()" required>
                            <option value="1">1 Per√≠odo (CINDEA)</option>
                            <option value="2">2 Per√≠odos</option>
                            <option value="3" selected>3 Per√≠odos</option>
                            <option value="4">4 Per√≠odos</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">üìÖ Configuraci√≥n de Per√≠odos</div>
                    <div id="camposPeriodos">
                        <!-- Se generan din√°micamente -->
                    </div>
                    <div id="validacionPeriodos" style="margin-top: 12px; font-size: 14px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('nuevaSeccion')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarSeccion()" id="btnGuardarSeccion">Guardar Secci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Asignatura -->
    <div class="modal-overlay" id="modalNuevaAsignatura">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üìñ Nueva Asignatura</h3>
                <button class="modal-close" onclick="app.closeModal('nuevaAsignatura')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-section-title">üìã Informaci√≥n B√°sica</div>
                    <div class="form-group">
                        <label>Secci√≥n *</label>
                        <select id="asigSeccion" required onchange="app.actualizarSelectPeriodos()">
                            <option value="">Seleccionar secci√≥n...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nombre de la Asignatura *</label>
                        <input type="text" id="asigNombre" placeholder="Ej: Matem√°ticas" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">üìä Componentes de Evaluaci√≥n (deben sumar 100%)</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Trabajo Cotidiano (%)</label>
                            <input type="number" id="asigPCTrabajo" placeholder="0" min="0" max="100" onchange="app.validarPorcentajesAsignatura()">
                        </div>
                        <div class="form-group">
                            <label>Tareas (%)</label>
                            <input type="number" id="asigPCTareas" placeholder="0" min="0" max="100" onchange="app.validarPorcentajesAsignatura()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Pruebas (%)</label>
                            <input type="number" id="asigPCPruebas" placeholder="0" min="0" max="100" onchange="app.validarPorcentajesAsignatura()">
                        </div>
                        <div class="form-group">
                            <label>Asistencia (%)</label>
                            <input type="number" id="asigPCAsistencia" placeholder="0" min="0" max="100" onchange="app.validarPorcentajesAsignatura()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Proyecto (%)</label>
                            <input type="number" id="asigPCProyecto" placeholder="0" min="0" max="100" onchange="app.validarPorcentajesAsignatura()">
                        </div>
                        <div class="form-group">
                            <label style="color: var(--primary); font-weight: 700;">Total: <span id="totalPorcentajeAsignatura">0</span>%</label>
                            <div id="validacionPorcentaje" style="font-size: 13px; margin-top: 4px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">‚öôÔ∏è Configuraci√≥n Adicional</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Puntos por Indicador (Trabajo Cotidiano)</label>
                            <input type="number" id="asigPuntosIndicador" value="3" min="1">
                        </div>
                        <div class="form-group">
                            <label>Tardanzas para 1 Ausencia</label>
                            <input type="number" id="asigTardanzasAusencia" value="2" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nota M√≠nima para Aprobar *</label>
                        <input type="number" id="asigNotaMinima" value="70" min="0" max="100" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('nuevaAsignatura')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarAsignatura()" id="btnGuardarAsignatura">Guardar Asignatura</button>
            </div>
        </div>
    </div>

    <!-- Modal Estudiantes -->
    <div class="modal-overlay" id="modalEstudiantes">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üéì Gesti√≥n de Estudiantes</h3>
                <button class="modal-close" onclick="app.closeModal('estudiantes')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab active" onclick="app.cambiarTabEstudiantes('lista', this)">üìã Lista</button>
                    <button class="tab" onclick="app.cambiarTabEstudiantes('agregar', this)">‚ûï Agregar</button>
                    <button class="tab" onclick="app.cambiarTabEstudiantes('excel', this)">üìä Importar Excel</button>
                </div>
                
                <div id="tabListaEstudiantes">
                    <div class="filtros-bar" style="padding: 12px;">
                        <input type="text" id="buscarEstudiante" placeholder="Buscar por nombre o ID SEA..." onkeyup="app.renderEstudiantesModal()" style="flex: 1; padding: 8px; border: 1px solid var(--gray-300); border-radius: var(--radius);">
                    </div>
                    <div class="table-container">
                        <table id="tablaEstudiantesModal">
                            <thead>
                                <tr>
                                    <th>ID SEA</th>
                                    <th>Nombre</th>
                                    <th>Adecuaci√≥n</th>
                                    <th>Contacto</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="tabAgregarEstudiante" style="display: none;">
                    <div class="form-group">
                        <label>N√∫mero de Identificaci√≥n (SEA) *</label>
                        <input type="text" id="estId" placeholder="Ej: 123456789" required>
                        <small style="color: var(--gray-600);">Ingrese exactamente como aparece en el SEA</small>
                    </div>
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="estNombre" placeholder="Ej: Mar√≠a Jos√© Gonz√°lez" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Encargado 1</label>
                            <input type="text" id="estEncargado1" placeholder="Nombre">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono 1</label>
                            <input type="tel" id="estTel1" placeholder="0000-0000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Encargado 2</label>
                            <input type="text" id="estEncargado2" placeholder="Nombre">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono 2</label>
                            <input type="tel" id="estTel2" placeholder="0000-0000">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Nacimiento</label>
                            <input type="date" id="estCumple">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Adecuaci√≥n *</label>
                            <select id="estAdecuacion" required>
                                <option value="ninguna">No presenta</option>
                                <option value="acceso">Adecuaci√≥n de acceso</option>
                                <option value="acs">Adecuaci√≥n Curricular Significativa (ACS)</option>
                                <option value="no_significativa">Adecuaci√≥n curricular no significativa</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="campoDetalleACS" style="display: none;">
                        <label>Detalle de la ACS</label>
                        <input type="text" id="estDetalleACS" placeholder="Ej: Dislexia, TDAH, etc.">
                    </div>
                    <button class="btn btn-primary" onclick="app.guardarEstudiante()" style="margin-top: 10px;">
                        Guardar Estudiante
                    </button>
                </div>
                
                <div id="tabExcelEstudiantes" style="display: none;">
                    <div style="background: #e3f2fd; padding: 16px; border-radius: var(--radius); margin-bottom: 20px;">
                        <strong>üí° Instrucciones:</strong>
                        <ol style="margin-top: 8px; padding-left: 20px; font-size: 14px; color: var(--gray-700);">
                            <li>Descarga la plantilla con los estudiantes actuales</li>
                            <li>Modifica o agrega informaci√≥n en Excel</li>
                            <li>Sube el archivo actualizado</li>
                            <li>El sistema sincronizar√° autom√°ticamente (ID SEA es clave √∫nica)</li>
                        </ol>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-ghost" onclick="app.descargarPlantillaExcel()">
                            üì• Descargar Plantilla Excel
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Subir archivo actualizado</label>
                        <input type="file" id="uploadExcel" accept=".xlsx,.xls" onchange="app.procesarExcelEstudiantes(this)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('estudiantes')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Bit√°cora -->
    <div class="modal-overlay" id="modalNuevaBitacora">
        <div class="modal">
            <div class="modal-header">
                <h3>üìù Nueva Bit√°cora</h3>
                <button class="modal-close" onclick="app.closeModal('nuevaBitacora')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Asignatura *</label>
                    <select id="bitAsignatura" required>
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de la clase *</label>
                    <input type="date" id="bitFecha" required>
                </div>
                <div class="form-group">
                    <label>Contenido / Actividades realizadas *</label>
                    <textarea id="bitContenido" rows="5" placeholder="Describa lo trabajado en clase..." required></textarea>
                </div>
                <div class="form-check">
                    <input type="checkbox" id="bitRecordatorio" onchange="app.toggleRecordatorio()">
                    <label for="bitRecordatorio">Programar recordatorio para pr√≥xima clase</label>
                </div>
                <div class="form-group" id="campoFechaRecordatorio" style="display: none;">
                    <label>Fecha del recordatorio</label>
                    <input type="date" id="bitFechaRecordatorio">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('nuevaBitacora')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarBitacora()">Guardar Bit√°cora</button>
            </div>
        </div>
    </div>

    <!-- Modal Configuraci√≥n Horario -->
    <div class="modal-overlay" id="modalConfigHorario">
        <div class="modal">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configuraci√≥n del Horario</h3>
                <button class="modal-close" onclick="app.closeModal('configHorario')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>M√°ximo de lecciones por d√≠a</label>
                    <input type="number" id="configMaxLecciones" value="7" min="1" max="20">
                    <small style="color: var(--gray-600);">Para modo unidocente (hasta 6 grados), calcular: lecciones reales √ó 6</small>
                </div>
                <div class="form-check" style="margin-top: 16px;">
                    <input type="checkbox" id="configUnidocente">
                    <label for="configUnidocente">Activar modo unidocente (requiere soporte)</label>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: var(--radius); margin-top: 16px; font-size: 13px;">
                    <strong>‚ÑπÔ∏è Modo Unidocente:</strong> Permite registrar asistencia de m√∫ltiples grados simult√°neamente. Contacte soporte para activaci√≥n.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('configHorario')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarConfigHorario()">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Lecci√≥n al Horario -->
    <div class="modal-overlay" id="modalAgregarLeccionHorario">
        <div class="modal">
            <div class="modal-header">
                <h3>‚ûï Agregar Clase al Horario</h3>
                <button class="modal-close" onclick="app.closeModal('agregarLeccionHorario')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Asignatura *</label>
                    <select id="horarioAsignatura" required>
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>D√≠a *</label>
                        <select id="horarioDia" required>
                            <option value="1">Lunes</option>
                            <option value="2">Martes</option>
                            <option value="3">Mi√©rcoles</option>
                            <option value="4">Jueves</option>
                            <option value="5">Viernes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lecci√≥n *</label>
                        <select id="horarioLeccionNum" required>
                            <!-- Se genera din√°micamente seg√∫n config -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('agregarLeccionHorario')">Cancelar</button>
                <button class="btn btn-primary btn-small" onclick="app.guardarLeccionHorario()">Agregar al Horario</button>
            </div>
        </div>
    </div>

    <!-- Modal Configuraci√≥n Evaluaci√≥n -->
    <div class="modal-overlay" id="modalConfigEvaluacion">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>‚öôÔ∏è Configurar Evaluaci√≥n</h3>
                <button class="modal-close" onclick="app.closeModal('configEvaluacion')">√ó</button>
            </div>
            <div class="modal-body" id="bodyConfigEvaluacion">
                <!-- Contenido din√°mico seg√∫n tipo de evaluaci√≥n -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('configEvaluacion')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reporte Per√≠odo SEA -->
    <div class="modal-overlay" id="modalReportePeriodo">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üìä Reporte por Per√≠odo (SEA)</h3>
                <button class="modal-close" onclick="app.closeModal('reportePeriodo')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filtros-bar" style="padding: 0; box-shadow: none; margin-bottom: 20px;">
                    <div class="filtro-item">
                        <label>Per√≠odo</label>
                        <select id="repPeriodoPeriodo">
                            <option value="I">I Per√≠odo</option>
                            <option value="II">II Per√≠odo</option>
                            <option value="III">III Per√≠odo</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Asignatura</label>
                        <select id="repPeriodoAsignatura">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary btn-small" onclick="app.generarReportePeriodo()">Generar</button>
                    </div>
                </div>
                
                <div id="contenidoReportePeriodo">
                    <div class="empty-state">
                        <p>Seleccione per√≠odo y asignatura para generar el reporte</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.descargarCSVPeriodo()" id="btnDescargarCSV" style="display: none;">üìÑ Descargar CSV SEA</button>
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('reportePeriodo')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reporte Anual -->
    <div class="modal-overlay" id="modalReporteAnual">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üìà Reporte Anual</h3>
                <button class="modal-close" onclick="app.closeModal('reporteAnual')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filtros-bar" style="padding: 0; box-shadow: none; margin-bottom: 20px;">
                    <div class="filtro-item">
                        <label>Asignatura</label>
                        <select id="repAnualAsignatura">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Filtro</label>
                        <select id="repAnualFiltro">
                            <option value="todos">Todos los estudiantes</option>
                            <option value="aprobados">Aprobados</option>
                            <option value="reprobados">Reprobados</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary btn-small" onclick="app.generarReporteAnual()">Generar</button>
                    </div>
                </div>
                
                <div id="contenidoReporteAnual">
                    <div class="empty-state">
                        <p>Seleccione asignatura para generar el reporte anual</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.descargarExcelAnual()" id="btnDescargarExcelAnual" style="display: none;">üìä Descargar Excel</button>
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('reporteAnual')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reporte Individual -->
    <div class="modal-overlay" id="modalReporteIndividual">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üë§ Reporte Individual</h3>
                <button class="modal-close" onclick="app.closeModal('reporteIndividual')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filtros-bar" style="padding: 0; box-shadow: none; margin-bottom: 20px;">
                    <div class="filtro-item">
                        <label>Asignatura</label>
                        <select id="repIndAsignatura" onchange="app.cargarEstudiantesReporteIndividual()">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Estudiante</label>
                        <select id="repIndEstudiante">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary btn-small" onclick="app.generarReporteIndividual()">Generar PDF</button>
                    </div>
                </div>
                
                <div id="previewReporteIndividual">
                    <div class="empty-state">
                        <p>Seleccione asignatura y estudiante para generar el reporte</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('reporteIndividual')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Reporte Eximidos -->
    <div class="modal-overlay" id="modalReporteEximidos">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>‚úÖ Reporte de Eximidos</h3>
                <button class="modal-close" onclick="app.closeModal('reporteEximidos')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filtros-bar" style="padding: 0; box-shadow: none; margin-bottom: 20px;">
                    <div class="filtro-item">
                        <label>Asignatura</label>
                        <select id="repEximAsignatura">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="filtro-item" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary btn-small" onclick="app.generarReporteEximidos()">Generar</button>
                    </div>
                </div>
                
                <div id="contenidoReporteEximidos">
                    <div class="empty-state">
                        <p>Seleccione asignatura para identificar estudiantes eximidos</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-small" onclick="app.closeModal('reporteEximidos')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==========================================
        // REGISTRATE - Sistema Completo de Gesti√≥n Educativa MEP 2026
        // ==========================================
        
        const app = {
            data: {
                user: null,
                instituciones: [],
                secciones: [],
                asignaturas: [],
                estudiantes: [],
                horario: [],
                bitacoras: [],
                asistencias: [],
                evaluaciones: {
                    indicadores: [],
                    tareas: [],
                    pruebas: [],
                    proyectos: [],
                    notas: {} // { estudianteId: { indicadorId: puntos, tareaId: puntos, ... } }
                },
                config: {
                    maxLecciones: 7,
                    unidocente: false,
                    mostrarInstitucionHorario: false
                },
                current: {
                    seccionId: null,
                    asignaturaId: null,
                    periodo: 'I',
                    fechaAsistencia: new Date().toISOString().split('T')[0],
                    tabEvaluacion: 'trabajo',
                    mesCalendario: new Date(),
                    editingId: null
                }
            },

            init() {
                this.cargarDatosEjemplo();
                this.setupEventListeners();
                this.checkPWA();
                this.actualizarNotificaciones();
                
                // Verificar si hay sesi√≥n guardada
                const savedUser = localStorage.getItem('registrate_user');
                if (savedUser) {
                    this.data.user = JSON.parse(savedUser);
                    this.showApp();
                }
            },

            setupEventListeners() {
                // Form login
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login();
                });

                // Cerrar modales al hacer click fuera
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });

                // Cambio en adecuaci√≥n para mostrar/ocultar detalle ACS
                document.getElementById('estAdecuacion')?.addEventListener('change', (e) => {
                    const campo = document.getElementById('campoDetalleACS');
                    if (campo) {
                        campo.style.display = e.target.value === 'acs' ? 'block' : 'none';
                    }
                });
            },

            // ==========================================
            // DATOS DE EJEMPLO / INICIALIZACI√ìN
            // ==========================================
            cargarDatosEjemplo() {
                // Instituciones
                this.data.instituciones = [
                    {
                        id: 'inst_1',
                        nombre: 'Escuela Rep√∫blica de Francia',
                        regional: 'Direcci√≥n Regional de Lim√≥n',
                        circuito: 'Circuito 10',
                        codigo: '50601234',
                        logo: null
                    }
                ];

                // Secciones con per√≠odos configurados (40-30-30)
                this.data.secciones = [
                    {
                        id: 'sec_1',
                        institucionId: 'inst_1',
                        nombre: '6-2',
                        anio: 2025,
                        periodos: [
                            { id: 'p1', nombre: 'I Periodo', inicio: '2025-02-03', fin: '2025-04-30', porcentaje: 40 },
                            { id: 'p2', nombre: 'II Periodo', inicio: '2025-05-01', fin: '2025-07-31', porcentaje: 30 },
                            { id: 'p3', nombre: 'III Periodo', inicio: '2025-08-01', fin: '2025-11-15', porcentaje: 30 }
                        ]
                    },
                    {
                        id: 'sec_2',
                        institucionId: 'inst_1',
                        nombre: '6-3',
                        anio: 2025,
                        periodos: [
                            { id: 'p1', nombre: 'I Periodo', inicio: '2025-02-03', fin: '2025-04-30', porcentaje: 40 },
                            { id: 'p2', nombre: 'II Periodo', inicio: '2025-05-01', fin: '2025-07-31', porcentaje: 30 },
                            { id: 'p3', nombre: 'III Periodo', inicio: '2025-08-01', fin: '2025-11-15', porcentaje: 30 }
                        ]
                    },
                    {
                        id: 'sec_3',
                        institucionId: 'inst_1',
                        nombre: '10-1',
                        anio: 2025,
                        periodos: [
                            { id: 'p1', nombre: 'I Periodo', inicio: '2025-02-03', fin: '2025-04-30', porcentaje: 35 },
                            { id: 'p2', nombre: 'II Periodo', inicio: '2025-05-01', fin: '2025-07-31', porcentaje: 35 },
                            { id: 'p3', nombre: 'III Periodo', inicio: '2025-08-01', fin: '2025-11-15', porcentaje: 30 }
                        ]
                    }
                ];

                // Asignaturas con configuraci√≥n completa
                this.data.asignaturas = [
                    {
                        id: 'asig_1',
                        seccionId: 'sec_1',
                        nombre: 'Matem√°ticas',
                        porcentajes: { trabajo: 30, tareas: 20, pruebas: 30, asistencia: 10, proyecto: 10 },
                        puntosIndicador: 3,
                        tardanzasPorAusencia: 2,
                        notaMinima: 70
                    },
                    {
                        id: 'asig_2',
                        seccionId: 'sec_1',
                        nombre: 'Ciencias',
                        porcentajes: { trabajo: 25, tareas: 25, pruebas: 30, asistencia: 10, proyecto: 10 },
                        puntosIndicador: 3,
                        tardanzasPorAusencia: 2,
                        notaMinima: 70
                    },
                    {
                        id: 'asig_3',
                        seccionId: 'sec_2',
                        nombre: 'Matem√°ticas',
                        porcentajes: { trabajo: 30, tareas: 20, pruebas: 30, asistencia: 10, proyecto: 10 },
                        puntosIndicador: 3,
                        tardanzasPorAusencia: 2,
                        notaMinima: 70
                    },
                    {
                        id: 'asig_4',
                        seccionId: 'sec_3',
                        nombre: 'Estudios Sociales',
                        porcentajes: { trabajo: 20, tareas: 20, pruebas: 40, asistencia: 10, proyecto: 10 },
                        puntosIndicador: 4,
                        tardanzasPorAusencia: 3,
                        notaMinima: 70
                    }
                ];

                // Estudiantes con ACS
                this.data.estudiantes = [
                    { id: 'est_1', seccionId: 'sec_1', idSEA: '123456789', nombre: 'Mar√≠a Gonz√°lez L√≥pez', encargado1: 'Ana L√≥pez', tel1: '8888-1111', encargado2: '', tel2: '', cumple: '2013-05-15', adecuacion: 'ninguna' },
                    { id: 'est_2', seccionId: 'sec_1', idSEA: '123456790', nombre: 'Juan P√©rez Rodr√≠guez', encargado1: 'Carmen Rodr√≠guez', tel1: '8888-2222', encargado2: '', tel2: '', cumple: '2013-08-22', adecuacion: 'acs', detalleACS: 'Dislexia' },
                    { id: 'est_3', seccionId: 'sec_1', idSEA: '123456791', nombre: 'Ana Mart√≠nez Sol√≠s', encargado1: 'Pedro Mart√≠nez', tel1: '8888-3333', encargado2: '', tel2: '', cumple: '2012-12-10', adecuacion: 'ninguna' },
                    { id: 'est_4', seccionId: 'sec_1', idSEA: '123456792', nombre: 'Carlos Rodr√≠guez Vega', encargado1: 'Mar√≠a Vega', tel1: '8888-4444', encargado2: '', tel2: '', cumple: '2013-03-08', adecuacion: 'ninguna' },
                    { id: 'est_5', seccionId: 'sec_1', idSEA: '123456793', nombre: 'Laura S√°nchez Morales', encargado1: 'Luc√≠a Morales', tel1: '8888-5555', encargado2: '', tel2: '', cumple: '2013-07-19', adecuacion: 'acceso' },
                    { id: 'est_6', seccionId: 'sec_2', idSEA: '223456789', nombre: 'Pedro G√≥mez Lara', encargado1: 'Sof√≠a Lara', tel1: '8888-6666', encargado2: '', tel2: '', cumple: '2013-01-25', adecuacion: 'ninguna' },
                    { id: 'est_7', seccionId: 'sec_2', idSEA: '223456790', nombre: 'Sof√≠a Hern√°ndez Ruiz', encargado1: 'Diego Hern√°ndez', tel1: '8888-7777', encargado2: '', tel2: '', cumple: '2012-09-14', adecuacion: 'acs', detalleACS: 'TDAH' },
                    { id: 'est_8', seccionId: 'sec_3', idSEA: '323456789', nombre: 'Amalia Gil Longoria', encargado1: 'Roberto Gil', tel1: '8888-8888', encargado2: '', tel2: '', cumple: '2009-11-30', adecuacion: 'ninguna' }
                ];

                // Horario
                this.data.horario = [
                    { id: 'h1', asignaturaId: 'asig_2', dia: 1, leccion: 1 },
                    { id: 'h2', asignaturaId: 'asig_2', dia: 1, leccion: 2 },
                    { id: 'h3', asignaturaId: 'asig_1', dia: 1, leccion: 5 },
                    { id: 'h4', asignaturaId: 'asig_2', dia: 2, leccion: 1 },
                    { id: 'h5', asignaturaId: 'asig_2', dia: 2, leccion: 2 },
                    { id: 'h6', asignaturaId: 'asig_1', dia: 3, leccion: 3 },
                    { id: 'h7', asignaturaId: 'asig_3', dia: 1, leccion: 2 },
                    { id: 'h8', asignaturaId: 'asig_3', dia: 3, leccion: 2 },
                    { id: 'h9', asignaturaId: 'asig_4', dia: 4, leccion: 1 },
                    { id: 'h10', asignaturaId: 'asig_4', dia: 4, leccion: 2 }
                ];

                // Bit√°coras
                this.data.bitacoras = [
                    {
                        id: 'bit_1',
                        asignaturaId: 'asig_1',
                        fecha: new Date().toISOString().split('T')[0],
                        contenido: 'Introducci√≥n a fracciones equivalentes. Actividad con material concreto (frutas). Los estudiantes participaron activamente.',
                        recordatorio: true,
                        fechaRecordatorio: this.sumarDias(new Date(), 2)
                    }
                ];

                // Asistencias de ejemplo
                this.data.asistencias = [
                    { id: 'asis_1', asignaturaId: 'asig_2', fecha: new Date().toISOString().split('T')[0], leccion: 1, estudianteId: 'est_1', estado: 'presente', justificacion: null },
                    { id: 'asis_2', asignaturaId: 'asig_2', fecha: new Date().toISOString().split('T')[0], leccion: 1, estudianteId: 'est_2', estado: 'tardanza', justificacion: null },
                    { id: 'asis_3', asignaturaId: 'asig_2', fecha: new Date().toISOString().split('T')[0], leccion: 1, estudianteId: 'est_3', estado: 'presente', justificacion: null }
                ];

                // Indicadores de trabajo cotidiano
                this.data.evaluaciones.indicadores = [
                    {
                        id: 'ind_1',
                        asignaturaId: 'asig_1',
                        periodo: 'I',
                        nombre: 'Resuelve problemas de multiplicaci√≥n y divisi√≥n',
                        descripcion: 'Aplica algoritmos de multiplicaci√≥n y divisi√≥n en contextos cotidianos',
                        porcentaje: 30,
                        puntosMax: 30,
                        fecha: '2025-01-15'
                    },
                    {
                        id: 'ind_2',
                        asignaturaId: 'asig_1',
                        periodo: 'I',
                        nombre: 'Identifica fracciones equivalentes',
                        descripcion: 'Reconoce y genera fracciones equivalentes en diferentes contextos',
                        porcentaje: 25,
                        puntosMax: 25,
                        fecha: '2025-01-22'
                    }
                ];

                // Tareas
                this.data.evaluaciones.tareas = [
                    {
                        id: 'tar_1',
                        asignaturaId: 'asig_1',
                        periodo: 'I',
                        nombre: 'Tarea 1 - Fracciones',
                        descripcion: 'Ejercicios 1-10 p√°gina 45 del libro de texto',
                        puntosMax: 10,
                        fechaAsignacion: '2025-01-20',
                        fechaEntrega: '2025-01-22',
                        fechaDevolucion: '2025-01-28'
                    }
                ];

                // Pruebas
                this.data.evaluaciones.pruebas = [
                    {
                        id: 'pru_1',
                        asignaturaId: 'asig_1',
                        periodo: 'I',
                        nombre: 'Prueba Escrita - Unidad 1',
                        tipo: 'Escrita',
                        puntosMax: 30,
                        fecha: '2025-02-15',
                        tiempoMaximo: 2,
                        instrumento: 'R√∫brica anal√≠tica'
                    }
                ];

                // Proyectos
                this.data.evaluaciones.proyectos = [
                    {
                        id: 'pro_1',
                        asignaturaId: 'asig_1',
                        periodo: 'I',
                        nombre: 'Proyecto: Mi huerta matem√°tica',
                        descripcion: 'Dise√±o y c√°lculo de √°reas para una huerta escolar',
                        puntosMax: 10,
                        fechaInicio: '2025-02-01',
                        fechaFin: '2025-03-15',
                        etapas: [
                            { nombre: 'Definici√≥n', completada: true },
                            { nombre: 'Planificaci√≥n', completada: false },
                            { nombre: 'Ejecuci√≥n', completada: false },
                            { nombre: 'Evaluaci√≥n', completada: false }
                        ]
                    }
                ];

                // Notas de ejemplo
                this.data.evaluaciones.notas = {
                    'est_1': {
                        'ind_1': 28,
                        'tar_1': 9,
                        'pru_1': 25
                    },
                    'est_2': {
                        'ind_1': 25,
                        'tar_1': 8,
                        'pru_1': 22
                    }
                };
            },

            sumarDias(fecha, dias) {
                const result = new Date(fecha);
                result.setDate(result.getDate() + dias);
                return result.toISOString().split('T')[0];
            },

            // ==========================================
            // AUTENTICACI√ìN
            // ==========================================
            login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    this.showToast('Complete todos los campos', 'error');
                    return;
                }

                this.data.user = {
                    email: email,
                    nombre: email.split('@')[0],
                    id: 'user_' + Date.now()
                };

                localStorage.setItem('registrate_user', JSON.stringify(this.data.user));
                this.showApp();
                this.showToast('¬°Bienvenido a RegistraTe!', 'success');
            },

            register() {
                this.showToast('Cuenta creada exitosamente. Ahora puede iniciar sesi√≥n.', 'success');
            },

            logout() {
                this.data.user = null;
                localStorage.removeItem('registrate_user');
                document.getElementById('app').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                this.navigate('inicio');
            },

            showApp() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('userName').textContent = this.data.user.nombre;
                
                this.renderDashboard();
                this.renderInstituciones();
                this.renderSecciones();
                this.renderAsignaturas();
                this.renderHorario();
                this.renderBitacora();
                this.cargarSelects();
            },

            // ==========================================
            // NAVEGACI√ìN
            // ==========================================
            navigate(page) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === page) {
                        item.classList.add('active');
                    }
                });

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');

                if (page === 'asistencia') {
                    this.modoRegistroAsistencia();
                } else if (page === 'evaluaciones') {
                    this.cargarEvaluacion();
                } else if (page === 'reportes') {
                    this.cargarSelectsReportes();
                }
            },

            // ==========================================
            // DASHBOARD
            // ==========================================
            renderDashboard() {
                document.getElementById('statInstituciones').textContent = this.data.instituciones.length;
                document.getElementById('statSecciones').textContent = this.data.secciones.length;
                document.getElementById('statAsignaturas').textContent = this.data.asignaturas.length;
                document.getElementById('statEstudiantes').textContent = this.data.estudiantes.length;

                const container = document.getElementById('dashboardSecciones');
                container.innerHTML = this.data.secciones.map(sec => this.crearCardSeccion(sec)).join('');
            },

            crearCardSeccion(sec) {
                const asignaturas = this.data.asignaturas.filter(a => a.seccionId === sec.id);
                const institucion = this.data.instituciones.find(i => i.id === sec.institucionId);
                const cantEst = this.data.estudiantes.filter(e => e.seccionId === sec.id).length;
                
                return `
                    <div class="seccion-card">
                        <h3>${sec.nombre}</h3>
                        <div class="seccion-info"><strong>Instituci√≥n:</strong> ${institucion?.nombre || 'Sin instituci√≥n'}</div>
                        <div class="seccion-info"><strong>A√±o:</strong> ${sec.anio}</div>
                        <div class="seccion-info"><strong>Estudiantes:</strong> ${cantEst}</div>
                        
                        <button class="btn-ver-est" onclick="app.verEstudiantes('${sec.id}')">
                            Ver Estudiantes
                        </button>
                        
                        <div class="periodos-title">Accesos R√°pidos:</div>
                        <div class="botones-evaluacion">
                            ${asignaturas.map(asig => `
                                <button class="btn-eval btn-trabajo" onclick="app.irEvaluacionRapida('${asig.id}')" title="${asig.nombre}">
                                    ${asig.nombre.substring(0, 10)}...
                                </button>
                            `).join('')}
                            <button class="btn-eval btn-asistencia" onclick="app.irAsistenciaRapida('${sec.id}')">Asistencia</button>
                        </div>
                    </div>
                `;
            },

            // ==========================================
            // INSTITUCIONES
            // ==========================================
            renderInstituciones() {
                const container = document.getElementById('listaInstituciones');
                
                if (this.data.instituciones.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-state-icon">üèõÔ∏è</div>
                            <h3>No hay instituciones registradas</h3>
                            <p>Comience agregando su centro educativo</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.data.instituciones.map(inst => `
                    <div class="card">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                üèõÔ∏è
                            </div>
                            <div>
                                <h4 style="font-size: 16px; font-weight: 700; color: var(--gray-800);">${inst.nombre}</h4>
                                <p style="font-size: 13px; color: var(--gray-600);">${inst.codigo || 'Sin c√≥digo'}</p>
                            </div>
                        </div>
                        <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 12px;">
                            ${inst.regional || ''}<br>
                            ${inst.circuito || ''}
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-small btn-ghost" onclick="app.editarInstitucion('${inst.id}')">‚úèÔ∏è Editar</button>
                            <button class="btn btn-small btn-danger" onclick="app.eliminarInstitucion('${inst.id}')">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `).join('');

                const btnNueva = document.getElementById('btnNuevaInstitucion');
                if (btnNueva) {
                    btnNueva.style.display = this.data.instituciones.length >= 3 ? 'none' : 'flex';
                }
            },

            procesarLogoInstitucion(input) {
                const file = input.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('previewLogo').src = e.target.result;
                        document.getElementById('previewLogo').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            },

            guardarInstitucion() {
                const nombre = document.getElementById('instNombre').value;
                if (!nombre) {
                    this.showToast('El nombre es obligatorio', 'error');
                    return;
                }

                const logoPreview = document.getElementById('previewLogo');
                
                const nueva = {
                    id: 'inst_' + Date.now(),
                    nombre: nombre,
                    regional: document.getElementById('instRegional').value,
                    circuito: document.getElementById('instCircuito').value,
                    codigo: document.getElementById('instCodigo').value,
                    logo: logoPreview.style.display !== 'none' ? logoPreview.src : null
                };

                this.data.instituciones.push(nueva);
                this.closeModal('nuevaInstitucion');
                this.renderInstituciones();
                this.cargarSelects();
                this.showToast('Instituci√≥n guardada exitosamente', 'success');
                
                // Limpiar form
                document.getElementById('instNombre').value = '';
                document.getElementById('instRegional').value = '';
                document.getElementById('instCircuito').value = '';
                document.getElementById('instCodigo').value = '';
                document.getElementById('instLogo').value = '';
                document.getElementById('previewLogo').style.display = 'none';
            },

            // ==========================================
            // SECCIONES
            // ==========================================
            renderSecciones() {
                const container = document.getElementById('listaSecciones');
                
                container.innerHTML = this.data.secciones.map(sec => {
                    const institucion = this.data.instituciones.find(i => i.id === sec.institucionId);
                    const cantEst = this.data.estudiantes.filter(e => e.seccionId === sec.id).length;
                    
                    return `
                        <div class="seccion-card">
                            <h3>Secci√≥n ${sec.nombre}</h3>
                            <div class="seccion-info"><strong>Instituci√≥n:</strong> ${institucion?.nombre || 'N/A'}</div>
                            <div class="seccion-info"><strong>A√±o:</strong> ${sec.anio}</div>
                            <div class="seccion-info"><strong>Per√≠odos:</strong> ${sec.periodos.length}</div>
                            <div class="seccion-info"><strong>Estudiantes:</strong> ${cantEst}</div>
                            
                            <div style="margin-top: 12px; padding: 12px; background: var(--gray-100); border-radius: var(--radius);">
                                <div style="font-size: 12px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px;">Distribuci√≥n anual:</div>
                                ${sec.periodos.map(p => `
                                    <div style="font-size: 12px; color: var(--gray-600); display: flex; justify-content: space-between;">
                                        <span>${p.nombre}:</span>
                                        <span style="font-weight: 600;">${p.porcentaje}%</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="table-actions" style="margin-top: 16px;">
                                <button class="btn btn-small btn-ghost" onclick="app.editarSeccion('${sec.id}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-small btn-primary" onclick="app.verEstudiantes('${sec.id}')">üéì Estudiantes</button>
                                <button class="btn btn-small btn-danger" onclick="app.eliminarSeccion('${sec.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            generarCamposPeriodos() {
                const num = parseInt(document.getElementById('secNumPeriodos').value) || 3;
                const container = document.getElementById('camposPeriodos');
                
                let html = '';
                const nombresDefault = ['I Per√≠odo', 'II Per√≠odo', 'III Per√≠odo', 'IV Per√≠odo'];
                const porcentajesDefault = [40, 30, 30, 0]; // Para 3 per√≠odos: 40-30-30
                
                for (let i = 0; i < num; i++) {
                    const pctDefault = num === 3 ? porcentajesDefault[i] : Math.floor(100/num);
                    
                    html += `
                        <div style="background: var(--gray-100); padding: 16px; border-radius: var(--radius); margin-bottom: 12px;">
                            <div style="font-weight: 700; color: var(--gray-800); margin-bottom: 12px;">${nombresDefault[i] || `Per√≠odo ${i+1}`}</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fecha Inicio *</label>
                                    <input type="date" class="periodo-inicio" data-idx="${i}" required>
                                </div>
                                <div class="form-group">
                                    <label>Fecha Fin *</label>
                                    <input type="date" class="periodo-fin" data-idx="${i}" required>
                                </div>
                                <div class="form-group">
                                    <label>% en Nota Anual *</label>
                                    <input type="number" class="periodo-porcentaje" data-idx="${i}" value="${pctDefault}" min="1" max="100" required onchange="app.validarPorcentajesPeriodos()">
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                this.validarPorcentajesPeriodos();
            },

            validarPorcentajesPeriodos() {
                const inputs = document.querySelectorAll('.periodo-porcentaje');
                let total = 0;
                inputs.forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                
                const validacion = document.getElementById('validacionPeriodos');
                const btn = document.getElementById('btnGuardarSeccion');
                
                if (total === 100) {
                    validacion.innerHTML = '<span class="validacion-ok">‚úì Los porcentajes suman 100%</span>';
                    btn.disabled = false;
                } else if (total > 100) {
                    validacion.innerHTML = `<span class="validacion-error">‚úó Excede en ${total - 100}% (debe sumar exactamente 100%)</span>`;
                    btn.disabled = true;
                } else {
                    validacion.innerHTML = `<span class="validacion-warning">‚ö† Faltan ${100 - total}% para completar 100%</span>`;
                    btn.disabled = true;
                }
            },

            guardarSeccion() {
                const institucionId = document.getElementById('secInstitucion').value;
                const nombre = document.getElementById('secNombre').value;
                const anio = parseInt(document.getElementById('secAnio').value);
                
                if (!institucionId || !nombre) {
                    this.showToast('Complete los campos obligatorios', 'error');
                    return;
                }

                const periodos = [];
                const inicios = document.querySelectorAll('.periodo-inicio');
                const fines = document.querySelectorAll('.periodo-fin');
                const porcentajes = document.querySelectorAll('.periodo-porcentaje');
                
                let totalPorcentaje = 0;
                
                for (let i = 0; i < inicios.length; i++) {
                    const pct = parseInt(porcentajes[i].value) || 0;
                    totalPorcentaje += pct;
                    periodos.push({
                        id: 'p_' + Date.now() + '_' + i,
                        nombre: ['I Per√≠odo', 'II Per√≠odo', 'III Per√≠odo', 'IV Per√≠odo'][i] || `Per√≠odo ${i+1}`,
                        inicio: inicios[i].value,
                        fin: fines[i].value,
                        porcentaje: pct
                    });
                }
                
                if (totalPorcentaje !== 100) {
                    this.showToast(`La suma de porcentajes debe ser 100%. Actual: ${totalPorcentaje}%`, 'error');
                    return;
                }

                const nueva = {
                    id: 'sec_' + Date.now(),
                    institucionId,
                    nombre,
                    anio,
                    periodos
                };

                this.data.secciones.push(nueva);
                this.closeModal('nuevaSeccion');
                this.renderSecciones();
                this.renderDashboard();
                this.cargarSelects();
                this.showToast('Secci√≥n creada exitosamente', 'success');
            },

            // ==========================================
            // ASIGNATURAS
            // ==========================================
            renderAsignaturas() {
                const filtroSec = document.getElementById('filtroAsignaturaSeccion')?.value;
                const container = document.getElementById('listaAsignaturas');
                
                let asignaturas = this.data.asignaturas;
                if (filtroSec) {
                    asignaturas = asignaturas.filter(a => a.seccionId === filtroSec);
                }

                if (asignaturas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-state-icon">üìñ</div>
                            <h3>No hay asignaturas registradas</h3>
                            <p>Cree asignaturas para comenzar a evaluar</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = asignaturas.map(asig => {
                    const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                    const institucion = this.data.instituciones.find(i => i.id === seccion?.institucionId);
                    
                    return `
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div>
                                    <h4 style="font-size: 18px; font-weight: 700; color: var(--gray-800);">${asig.nombre}</h4>
                                    <p style="font-size: 13px; color: var(--gray-600);">${seccion?.nombre} ‚Ä¢ ${institucion?.nombre}</p>
                                </div>
                                <span class="badge badge-primary">Nota m√≠n: ${asig.notaMinima}</span>
                            </div>
                            
                            <div style="background: var(--gray-100); padding: 12px; border-radius: var(--radius); margin-bottom: 16px;">
                                <div style="font-size: 12px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px;">Componentes de evaluaci√≥n:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                    ${asig.porcentajes.trabajo ? `<span class="badge badge-info">Trabajo: ${asig.porcentajes.trabajo}%</span>` : ''}
                                    ${asig.porcentajes.tareas ? `<span class="badge badge-success">Tareas: ${asig.porcentajes.tareas}%</span>` : ''}
                                    ${asig.porcentajes.pruebas ? `<span class="badge badge-warning">Pruebas: ${asig.porcentajes.pruebas}%</span>` : ''}
                                    ${asig.porcentajes.asistencia ? `<span class="badge badge-danger">Asistencia: ${asig.porcentajes.asistencia}%</span>` : ''}
                                    ${asig.porcentajes.proyecto ? `<span class="badge badge-primary">Proyecto: ${asig.porcentajes.proyecto}%</span>` : ''}
                                </div>
                            </div>
                            
                            <div style="font-size: 13px; color: var(--gray-600); margin-bottom: 12px;">
                                <div>‚Ä¢ ${asig.tardanzasPorAusencia} tardanzas = 1 ausencia</div>
                                <div>‚Ä¢ Puntos por indicador: ${asig.puntosIndicador}</div>
                            </div>
                            
                            <div class="table-actions">
                                <button class="btn btn-small btn-ghost" onclick="app.editarAsignatura('${asig.id}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-small btn-danger" onclick="app.eliminarAsignatura('${asig.id}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            validarPorcentajesAsignatura() {
                const trabajo = parseInt(document.getElementById('asigPCTrabajo').value) || 0;
                const tareas = parseInt(document.getElementById('asigPCTareas').value) || 0;
                const pruebas = parseInt(document.getElementById('asigPCPruebas').value) || 0;
                const asistencia = parseInt(document.getElementById('asigPCAsistencia').value) || 0;
                const proyecto = parseInt(document.getElementById('asigPCProyecto').value) || 0;
                
                const total = trabajo + tareas + pruebas + asistencia + proyecto;
                
                document.getElementById('totalPorcentajeAsignatura').textContent = total;
                const validacion = document.getElementById('validacionPorcentaje');
                const btn = document.getElementById('btnGuardarAsignatura');
                
                if (total === 100) {
                    validacion.innerHTML = '<span class="validacion-ok">‚úì Los porcentajes son correctos</span>';
                    btn.disabled = false;
                } else if (total > 100) {
                    validacion.innerHTML = `<span class="validacion-error">‚úó Excede en ${total - 100}%</span>`;
                    btn.disabled = true;
                } else {
                    validacion.innerHTML = `<span class="validacion-warning">‚ö† Faltan ${100 - total}%</span>`;
                    btn.disabled = true;
                }
            },

            guardarAsignatura() {
                const seccionId = document.getElementById('asigSeccion').value;
                const nombre = document.getElementById('asigNombre').value;
                
                if (!seccionId || !nombre) {
                    this.showToast('Complete los campos obligatorios', 'error');
                    return;
                }

                const porcentajes = {
                    trabajo: parseInt(document.getElementById('asigPCTrabajo').value) || 0,
                    tareas: parseInt(document.getElementById('asigPCTareas').value) || 0,
                    pruebas: parseInt(document.getElementById('asigPCPruebas').value) || 0,
                    asistencia: parseInt(document.getElementById('asigPCAsistencia').value) || 0,
                    proyecto: parseInt(document.getElementById('asigPCProyecto').value) || 0
                };

                const total = Object.values(porcentajes).reduce((a, b) => a + b, 0);
                if (total !== 100) {
                    this.showToast('Los porcentajes deben sumar 100%', 'error');
                    return;
                }

                const nueva = {
                    id: 'asig_' + Date.now(),
                    seccionId,
                    nombre,
                    porcentajes,
                    puntosIndicador: parseInt(document.getElementById('asigPuntosIndicador').value) || 3,
                    tardanzasPorAusencia: parseInt(document.getElementById('asigTardanzasAusencia').value) || 2,
                    notaMinima: parseInt(document.getElementById('asigNotaMinima').value) || 70
                };

                this.data.asignaturas.push(nueva);
                this.closeModal('nuevaAsignatura');
                this.renderAsignaturas();
                this.renderDashboard();
                this.cargarSelects();
                this.showToast('Asignatura creada exitosamente', 'success');
            },

            // ==========================================
            // ESTUDIANTES
            // ==========================================
            verEstudiantes(seccionId) {
                this.data.current.seccionId = seccionId;
                this.openModal('estudiantes');
                this.renderEstudiantesModal();
            },

            renderEstudiantesModal() {
                const busqueda = document.getElementById('buscarEstudiante')?.value.toLowerCase() || '';
                const estudiantes = this.data.estudiantes.filter(e => 
                    e.seccionId === this.data.current.seccionId &&
                    (e.nombre.toLowerCase().includes(busqueda) || e.idSEA.includes(busqueda))
                );

                const tbody = document.querySelector('#tablaEstudiantesModal tbody');
                tbody.innerHTML = estudiantes.map(est => `
                    <tr>
                        <td><code style="background: var(--gray-200); padding: 2px 6px; border-radius: 4px; font-size: 12px;">${est.idSEA}</code></td>
                        <td>
                            <strong>${est.nombre}</strong>
                            ${est.adecuacion === 'acs' ? '<div style="color: var(--orange); font-size: 11px; font-weight: 600;">‚ö†Ô∏è ACS: ' + (est.detalleACS || 'Significativa') + '</div>' : ''}
                        </td>
                        <td>
                            <span class="badge ${est.adecuacion === 'acs' ? 'badge-warning' : 'badge-success'}">
                                ${this.getNombreAdecuacion(est.adecuacion)}
                            </span>
                        </td>
                        <td>
                            ${est.tel1 ? `<div style="font-size: 12px;">üìû ${est.tel1}</div>` : ''}
                            ${est.encargado1 ? `<div style="font-size: 11px; color: var(--gray-600);">${est.encargado1}</div>` : ''}
                        </td>
                        <td class="table-actions">
                            <button class="btn btn-small btn-ghost" onclick="app.contactarWhatsApp('${est.tel1}')" title="WhatsApp">üí¨</button>
                            <button class="btn btn-small btn-ghost" onclick="app.editarEstudiante('${est.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="app.eliminarEstudiante('${est.id}')" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center" style="padding: 40px; color: var(--gray-500);">No hay estudiantes registrados</td></tr>';
            },

            getNombreAdecuacion(tipo) {
                const nombres = {
                    'ninguna': 'No presenta',
                    'acceso': 'Acceso',
                    'acs': 'ACS',
                    'no_significativa': 'No significativa'
                };
                return nombres[tipo] || tipo;
            },

            cambiarTabEstudiantes(tab, btn) {
                document.querySelectorAll('#modalEstudiantes .tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                
                document.getElementById('tabListaEstudiantes').style.display = tab === 'lista' ? 'block' : 'none';
                document.getElementById('tabAgregarEstudiante').style.display = tab === 'agregar' ? 'block' : 'none';
                document.getElementById('tabExcelEstudiantes').style.display = tab === 'excel' ? 'block' : 'none';
            },

            guardarEstudiante() {
                const idSEA = document.getElementById('estId').value.trim();
                const nombre = document.getElementById('estNombre').value.trim();
                
                if (!idSEA || !nombre) {
                    this.showToast('ID SEA y Nombre son obligatorios', 'error');
                    return;
                }

                // Verificar duplicado de ID SEA en la misma secci√≥n
                const existe = this.data.estudiantes.find(e => 
                    e.seccionId === this.data.current.seccionId && 
                    e.idSEA === idSEA &&
                    e.id !== this.data.current.editingId
                );
                
                if (existe) {
                    this.showToast('Ya existe un estudiante con ese ID SEA en esta secci√≥n', 'error');
                    return;
                }

                const estudiante = {
                    id: this.data.current.editingId || 'est_' + Date.now(),
                    seccionId: this.data.current.seccionId,
                    idSEA,
                    nombre,
                    encargado1: document.getElementById('estEncargado1').value,
                    tel1: document.getElementById('estTel1').value,
                    encargado2: document.getElementById('estEncargado2').value,
                    tel2: document.getElementById('estTel2').value,
                    cumple: document.getElementById('estCumple').value,
                    adecuacion: document.getElementById('estAdecuacion').value,
                    detalleACS: document.getElementById('estAdecuacion').value === 'acs' ? document.getElementById('estDetalleACS').value : null
                };

                if (this.data.current.editingId) {
                    const idx = this.data.estudiantes.findIndex(e => e.id === estudiante.id);
                    this.data.estudiantes[idx] = estudiante;
                    this.showToast('Estudiante actualizado', 'success');
                } else {
                    this.data.estudiantes.push(estudiante);
                    this.showToast('Estudiante agregado', 'success');
                }

                this.data.current.editingId = null;
                this.limpiarFormEstudiante();
                this.renderEstudiantesModal();
                this.renderDashboard();
            },

            descargarPlantillaExcel() {
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === this.data.current.seccionId);
                const data = estudiantes.map(e => ({
                    'ID_SEA': e.idSEA,
                    'Nombre_Completo': e.nombre,
                    'Encargado_1': e.encargado1,
                    'Telefono_1': e.tel1,
                    'Encargado_2': e.encargado2,
                    'Telefono_2': e.tel2,
                    'Fecha_Nacimiento': e.cumple,
                    'Adecuacion': e.adecuacion,
                    'Detalle_ACS': e.detalleACS || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Estudiantes");
                XLSX.writeFile(wb, `Plantilla_Estudiantes_${this.data.current.seccionId}.xlsx`);
                this.showToast('Plantilla descargada', 'success');
            },

            procesarExcelEstudiantes(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        let agregados = 0;
                        let actualizados = 0;

                        jsonData.forEach(row => {
                            const idSEA = String(row['ID_SEA'] || row['idSEA'] || '').trim();
                            const nombre = String(row['Nombre_Completo'] || row['nombre'] || '').trim();
                            
                            if (!idSEA || !nombre) return;

                            const existente = this.data.estudiantes.find(e => 
                                e.seccionId === this.data.current.seccionId && e.idSEA === idSEA
                            );

                            const estudianteData = {
                                id: existente ? existente.id : 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                seccionId: this.data.current.seccionId,
                                idSEA,
                                nombre,
                                encargado1: String(row['Encargado_1'] || row['encargado1'] || ''),
                                tel1: String(row['Telefono_1'] || row['tel1'] || ''),
                                encargado2: String(row['Encargado_2'] || row['encargado2'] || ''),
                                tel2: String(row['Telefono_2'] || row['tel2'] || ''),
                                cumple: String(row['Fecha_Nacimiento'] || row['cumple'] || ''),
                                adecuacion: String(row['Adecuacion'] || row['adecuacion'] || 'ninguna'),
                                detalleACS: String(row['Detalle_ACS'] || row['detalleACS'] || '')
                            };

                            if (existente) {
                                const idx = this.data.estudiantes.findIndex(e => e.id === existente.id);
                                this.data.estudiantes[idx] = estudianteData;
                                actualizados++;
                            } else {
                                this.data.estudiantes.push(estudianteData);
                                agregados++;
                            }
                        });

                        this.showToast(`Importaci√≥n completada: ${agregados} agregados, ${actualizados} actualizados`, 'success');
                        this.renderEstudiantesModal();
                        this.renderDashboard();
                    } catch (error) {
                        this.showToast('Error al procesar el archivo: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
                input.value = '';
            },

            // ==========================================
            // HORARIO
            // ==========================================
            renderHorario() {
                const mostrarInst = document.getElementById('mostrarInstitucionHorario')?.checked || false;
                const maxLecciones = this.data.config.maxLecciones;
                const dias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
                
                const grid = document.getElementById('horarioGrid');
                grid.innerHTML = '<div class="horario-header">Lecci√≥n</div>' + 
                    dias.map(d => `<div class="horario-header">${d}</div>`).join('');

                for (let lec = 1; lec <= maxLecciones; lec++) {
                    grid.innerHTML += `<div class="horario-leccion">${lec}</div>`;
                    
                    for (let dia = 1; dia <= 5; dia++) {
                        const clase = this.data.horario.find(h => h.dia === dia && h.leccion === lec);
                        
                        if (clase) {
                            const asig = this.data.asignaturas.find(a => a.id === clase.asignaturaId);
                            const sec = this.data.secciones.find(s => s.id === asig?.seccionId);
                            const inst = mostrarInst ? this.data.instituciones.find(i => i.id === sec?.institucionId) : null;
                            
                            const tipoClass = this.getTipoAsignaturaClass(asig?.nombre);
                            
                            grid.innerHTML += `
                                <div class="horario-celda ${tipoClass}" onclick="app.editarLeccionHorario('${clase.id}')">
                                    <div class="horario-materia">${asig?.nombre || 'Sin nombre'}</div>
                                    <div class="horario-seccion">${sec?.nombre || ''}</div>
                                    ${inst ? `<div class="horario-inst">${inst.nombre}</div>` : ''}
                                </div>
                            `;
                        } else {
                            grid.innerHTML += `
                                <div class="horario-celda vacio" onclick="app.seleccionarCeldaHorario(${dia}, ${lec})">
                                    +
                                </div>
                            `;
                        }
                    }
                }
            },

            getTipoAsignaturaClass(nombre) {
                if (!nombre) return '';
                const lower = nombre.toLowerCase();
                if (lower.includes('matem√°tica')) return 'matematicas';
                if (lower.includes('ciencia')) return 'ciencias';
                if (lower.includes('espa√±ol') || lower.includes('lengua')) return 'espanol';
                if (lower.includes('social') || lower.includes('c√≠vica')) return 'sociales';
                if (lower.includes('ingl√©s') || lower.includes('ingles')) return 'ingles';
                return '';
            },

            seleccionarCeldaHorario(dia, leccion) {
                document.getElementById('horarioDia').value = dia;
                
                const selectLeccion = document.getElementById('horarioLeccionNum');
                selectLeccion.innerHTML = '';
                for (let i = 1; i <= this.data.config.maxLecciones; i++) {
                    selectLeccion.innerHTML += `<option value="${i}" ${i === leccion ? 'selected' : ''}>Lecci√≥n ${i}</option>`;
                }
                
                const selectAsig = document.getElementById('horarioAsignatura');
                selectAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');
                
                this.openModal('agregarLeccionHorario');
            },

            guardarLeccionHorario() {
                const asignaturaId = document.getElementById('horarioAsignatura').value;
                const dia = parseInt(document.getElementById('horarioDia').value);
                const leccion = parseInt(document.getElementById('horarioLeccionNum').value);
                
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura', 'error');
                    return;
                }

                const existe = this.data.horario.find(h => h.dia === dia && h.leccion === leccion);
                if (existe) {
                    existe.asignaturaId = asignaturaId;
                } else {
                    this.data.horario.push({
                        id: 'h_' + Date.now(),
                        asignaturaId,
                        dia,
                        leccion
                    });
                }

                this.closeModal('agregarLeccionHorario');
                this.renderHorario();
                this.showToast('Horario actualizado', 'success');
            },

            // ==========================================
            // BIT√ÅCORA
            // ==========================================
            renderBitacora() {
                const filtroAsig = document.getElementById('filtroBitacoraAsignatura')?.value;
                const busqueda = document.getElementById('buscarBitacora')?.value.toLowerCase() || '';
                
                let bitacoras = this.data.bitacoras;
                
                if (filtroAsig) {
                    bitacoras = bitacoras.filter(b => b.asignaturaId === filtroAsig);
                }
                if (busqueda) {
                    bitacoras = bitacoras.filter(b => 
                        b.contenido.toLowerCase().includes(busqueda)
                    );
                }

                // Ordenar por fecha descendente
                bitacoras.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                const container = document.getElementById('listaBitacoras');
                
                if (bitacoras.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <h3>No hay bit√°coras registradas</h3>
                            <p>Registre sus actividades de clase</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = bitacoras.map(bit => {
                    const asig = this.data.asignaturas.find(a => a.id === bit.asignaturaId);
                    const esRecordatorio = bit.recordatorio && new Date(bit.fechaRecordatorio) >= new Date();
                    
                    return `
                        <div class="bitacora-card ${esRecordatorio ? 'recordatorio' : ''}">
                            <div class="bitacora-header">
                                <div class="bitacora-titulo">
                                    ${esRecordatorio ? 'üîî ' : ''}${asig?.nombre || 'Sin asignatura'}
                                </div>
                                <div class="bitacora-fecha">üìÖ ${this.formatearFecha(bit.fecha)}</div>
                            </div>
                            <div class="bitacora-contenido">${bit.contenido}</div>
                            ${esRecordatorio ? `
                                <div style="margin-top: 12px; padding: 8px 12px; background: #fff3cd; border-radius: var(--radius); font-size: 12px; color: #856404;">
                                    ‚è∞ Recordatorio programado: ${this.formatearFecha(bit.fechaRecordatorio)}
                                </div>
                            ` : ''}
                            <div class="bitacora-acciones">
                                <button class="btn btn-small btn-ghost" onclick="app.editarBitacora('${bit.id}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-small btn-danger" onclick="app.eliminarBitacora('${bit.id}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            toggleRecordatorio() {
                const checkbox = document.getElementById('bitRecordatorio');
                const campo = document.getElementById('campoFechaRecordatorio');
                campo.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    document.getElementById('bitFechaRecordatorio').value = this.sumarDias(new Date(), 7);
                }
            },

            guardarBitacora() {
                const asignaturaId = document.getElementById('bitAsignatura').value;
                const fecha = document.getElementById('bitFecha').value;
                const contenido = document.getElementById('bitContenido').value;
                const recordatorio = document.getElementById('bitRecordatorio').checked;
                const fechaRecordatorio = recordatorio ? document.getElementById('bitFechaRecordatorio').value : null;
                
                if (!asignaturaId || !fecha || !contenido) {
                    this.showToast('Complete los campos obligatorios', 'error');
                    return;
                }

                const nueva = {
                    id: 'bit_' + Date.now(),
                    asignaturaId,
                    fecha,
                    contenido,
                    recordatorio,
                    fechaRecordatorio
                };

                this.data.bitacoras.push(nueva);
                this.closeModal('nuevaBitacora');
                this.renderBitacora();
                this.actualizarNotificaciones();
                this.showToast('Bit√°cora guardada', 'success');
            },

            descargarBitacoras() {
                const filtroAsig = document.getElementById('filtroBitacoraAsignatura')?.value;
                let bitacoras = this.data.bitacoras;
                if (filtroAsig) {
                    bitacoras = bitacoras.filter(b => b.asignaturaId === filtroAsig);
                }

                let html = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Bit√°coras - RegistraTe</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            h1 { color: #0d7377; }
                            .bitacora { margin-bottom: 30px; border-bottom: 1px solid #ccc; padding-bottom: 20px; }
                            .fecha { color: #666; font-size: 14px; }
                            .asignatura { font-weight: bold; color: #0d7377; }
                        </style>
                    </head>
                    <body>
                        <h1>Bit√°coras de Clase</h1>
                        <p>Generado el ${new Date().toLocaleDateString('es-ES')}</p>
                        <hr>
                `;

                bitacoras.forEach(bit => {
                    const asig = this.data.asignaturas.find(a => a.id === bit.asignaturaId);
                    html += `
                        <div class="bitacora">
                            <div class="asignatura">${asig?.nombre || 'Sin asignatura'}</div>
                            <div class="fecha">${this.formatearFecha(bit.fecha)}</div>
                            <p>${bit.contenido}</p>
                            ${bit.recordatorio ? `<p><em>Recordatorio: ${this.formatearFecha(bit.fechaRecordatorio)}</em></p>` : ''}
                        </div>
                    `;
                });

                html += '</body></html>';

                const blob = new Blob([html], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Bitacoras.doc';
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('Documento Word descargado', 'success');
            },

            // ==========================================
            // ASISTENCIA
            // ==========================================
            modoRegistroAsistencia() {
                document.getElementById('modoRegistroAsistencia').style.display = 'block';
                document.getElementById('modoReporteAsistencia').style.display = 'none';
                this.renderCalendarioAsistencia();
                this.cargarSelectsAsistencia();
            },

            modoReporteAsistencia() {
                document.getElementById('modoRegistroAsistencia').style.display = 'none';
                document.getElementById('modoReporteAsistencia').style.display = 'block';
                this.cargarSelectsReporteAsistencia();
            },

            cargarSelectsAsistencia() {
                const selectSec = document.getElementById('asistenciaSeccion');
                selectSec.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.secciones.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            },

            cargarSelectsReporteAsistencia() {
                const selectAsig = document.getElementById('reporteAsistenciaAsignatura');
                selectAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');
            },

            renderCalendarioAsistencia() {
                const fecha = this.data.current.mesCalendario;
                const mesNombre = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                document.getElementById('calendarioMes').textContent = mesNombre.charAt(0).toUpperCase() + mesNombre.slice(1);
                
                const grid = document.getElementById('calendarioGrid');
                grid.innerHTML = '';
                
                const diasSemana = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie'];
                diasSemana.forEach(dia => {
                    grid.innerHTML += `<div class="calendario-dia-header">${dia}</div>`;
                });
                
                const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
                let diaSemana = primerDia.getDay() || 7;
                diaSemana = diaSemana === 0 ? 7 : diaSemana;
                
                for (let i = 1; i < diaSemana; i++) {
                    grid.innerHTML += '<div></div>';
                }
                
                const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
                const hoy = new Date().toISOString().split('T')[0];
                
                for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                    const fechaStr = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                    const diaSemanaActual = new Date(fecha.getFullYear(), fecha.getMonth(), dia).getDay();
                    
                    if (diaSemanaActual === 0 || diaSemanaActual === 6) continue;
                    
                    const asistenciasDia = this.data.asistencias.filter(a => a.fecha === fechaStr);
                    const completado = asistenciasDia.length > 0;
                    const esHoy = fechaStr === hoy;
                    
                    grid.innerHTML += `
                        <div class="calendario-dia ${esHoy ? 'hoy' : ''} ${completado ? 'completo' : 'incompleto'}" 
                             onclick="app.seleccionarDiaAsistencia('${fechaStr}')">
                            <div class="calendario-dia-numero">${dia}</div>
                            <div class="calendario-dia-estado">${completado ? '‚úì' : '‚úó'}</div>
                        </div>
                    `;
                }
            },

            cambiarMes(delta) {
                this.data.current.mesCalendario.setMonth(
                    this.data.current.mesCalendario.getMonth() + delta
                );
                this.renderCalendarioAsistencia();
            },

            seleccionarDiaAsistencia(fecha) {
                this.data.current.fechaAsistencia = fecha;
                document.getElementById('fechaSeleccionadaTexto').textContent = this.formatearFecha(fecha);
                document.getElementById('panelRegistroAsistencia').style.display = 'block';
                
                this.cargarSelectsAsistencia();
                document.getElementById('asistenciaAsignatura').innerHTML = '<option value="">Todas</option>';
                document.getElementById('asistenciaLeccion').innerHTML = '<option value="">Seleccionar...</option>';
                document.getElementById('listaAsistenciaEstudiantes').style.display = 'none';
                
                document.getElementById('panelRegistroAsistencia').scrollIntoView({ behavior: 'smooth' });
            },

            cargarAsignaturasAsistencia() {
                const seccionId = document.getElementById('asistenciaSeccion').value;
                if (!seccionId) return;
                
                const asigs = this.data.asignaturas.filter(a => a.seccionId === seccionId);
                const selectAsig = document.getElementById('asistenciaAsignatura');
                selectAsig.innerHTML = '<option value="">Todas</option>' +
                    asigs.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
                
                this.cargarLeccionesDia();
            },

            cargarLeccionesDia() {
                const seccionId = document.getElementById('asistenciaSeccion').value;
                const asignaturaId = document.getElementById('asistenciaAsignatura').value;
                
                if (!seccionId) return;
                
                // Obtener lecciones del horario para esta secci√≥n/asignatura
                let leccionesDisponibles = [];
                if (asignaturaId) {
                    leccionesDisponibles = this.data.horario
                        .filter(h => h.asignaturaId === asignaturaId)
                        .map(h => h.leccion);
                } else {
                    const asigs = this.data.asignaturas.filter(a => a.seccionId === seccionId);
                    const asigIds = asigs.map(a => a.id);
                    leccionesDisponibles = this.data.horario
                        .filter(h => asigIds.includes(h.asignaturaId))
                        .map(h => h.leccion);
                }
                
                leccionesDisponibles = [...new Set(leccionesDisponibles)].sort((a, b) => a - b);
                
                if (leccionesDisponibles.length === 0) {
                    leccionesDisponibles = [1, 2, 3, 4, 5, 6, 7]; // Default
                }
                
                const selectLeccion = document.getElementById('asistenciaLeccion');
                selectLeccion.innerHTML = '<option value="">Seleccionar...</option>' +
                    leccionesDisponibles.map(l => `<option value="${l}">Lecci√≥n ${l}</option>`).join('');
            },

            cargarListaAsistencia() {
                const seccionId = document.getElementById('asistenciaSeccion').value;
                const leccion = parseInt(document.getElementById('asistenciaLeccion').value);
                
                if (!seccionId || !leccion) {
                    this.showToast('Seleccione secci√≥n y lecci√≥n', 'error');
                    return;
                }
                
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccionId);
                
                const container = document.getElementById('listaAsistenciaEstudiantes');
                container.style.display = 'block';
                
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4 style="font-size: 16px; font-weight: 700;">Lista de Asistencia - Lecci√≥n ${leccion}</h4>
                        <button class="btn btn-primary btn-small" onclick="app.guardarAsistencia(${leccion})">
                            üíæ Guardar Asistencia
                        </button>
                    </div>
                    ${estudiantes.map(est => {
                        const asistenciaExistente = this.data.asistencias.find(a => 
                            a.fecha === this.data.current.fechaAsistencia &&
                            a.leccion === leccion &&
                            a.estudianteId === est.id
                        );
                        const estado = asistenciaExistente?.estado || 'presente';
                        
                        return `
                            <div class="asistencia-estudiante" data-est-id="${est.id}">
                                <div class="estudiante-info">
                                    <div class="estudiante-avatar">${est.nombre.charAt(0)}</div>
                                    <div>
                                        <div class="estudiante-nombre">${est.nombre}</div>
                                        ${est.adecuacion === 'acs' ? '<div class="estudiante-acs">‚ö†Ô∏è ACS</div>' : ''}
                                    </div>
                                </div>
                                <div class="asistencia-opciones">
                                    <button class="asistencia-btn presente ${estado === 'presente' ? 'active' : ''}" 
                                            onclick="app.cambiarEstadoAsistencia(this, 'presente')">Presente</button>
                                    <button class="asistencia-btn ausente-j ${estado === 'ausente_j' ? 'active' : ''}" 
                                            onclick="app.cambiarEstadoAsistencia(this, 'ausente_j')">A.J.</button>
                                    <button class="asistencia-btn ausente-i ${estado === 'ausente_i' ? 'active' : ''}" 
                                            onclick="app.cambiarEstadoAsistencia(this, 'ausente_i')">A.I.</button>
                                    <button class="asistencia-btn tardanza ${estado === 'tardanza' ? 'active' : ''}" 
                                            onclick="app.cambiarEstadoAsistencia(this, 'tardanza')">Tardanza</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            },

            cambiarEstadoAsistencia(btn, estado) {
                const container = btn.closest('.asistencia-opciones');
                container.querySelectorAll('.asistencia-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            },

            guardarAsistencia(leccion) {
                const asignaturaId = document.getElementById('asistenciaAsignatura').value || 
                    this.data.asignaturas.find(a => a.seccionId === document.getElementById('asistenciaSeccion').value)?.id;
                
                const filas = document.querySelectorAll('.asistencia-estudiante');
                
                filas.forEach(fila => {
                    const estudianteId = fila.dataset.estId;
                    const estado = fila.querySelector('.asistencia-btn.active')?.dataset.estado || 'presente';
                    
                    const existente = this.data.asistencias.find(a => 
                        a.fecha === this.data.current.fechaAsistencia &&
                        a.leccion === leccion &&
                        a.estudianteId === estudianteId
                    );
                    
                    if (existente) {
                        existente.estado = estado;
                    } else {
                        this.data.asistencias.push({
                            id: 'asis_' + Date.now() + '_' + estudianteId,
                            asignaturaId,
                            fecha: this.data.current.fechaAsistencia,
                            leccion,
                            estudianteId,
                            estado,
                            justificacion: null
                        });
                    }
                });
                
                this.showToast('Asistencia guardada correctamente', 'success');
                this.renderCalendarioAsistencia();
            },

            renderReporteAsistencia() {
                const asignaturaId = document.getElementById('reporteAsistenciaAsignatura').value;
                const periodo = document.getElementById('reporteAsistenciaPeriodo').value;
                const busqueda = document.getElementById('buscarReporteAsistencia')?.value.toLowerCase() || '';
                
                if (!asignaturaId) {
                    document.querySelector('#tablaReporteAsistencia tbody').innerHTML = '';
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                // Filtrar por b√∫squeda
                const estudiantesFiltrados = estudiantes.filter(e => 
                    e.nombre.toLowerCase().includes(busqueda) || 
                    e.idSEA.includes(busqueda)
                );

                // Calcular estad√≠sticas de asistencia
                const tbody = document.querySelector('#tablaReporteAsistencia tbody');
                tbody.innerHTML = estudiantesFiltrados.map(est => {
                    const asistenciasEst = this.data.asistencias.filter(a => 
                        a.estudianteId === est.id && 
                        a.asignaturaId === asignaturaId
                    );

                    const tardanzas = asistenciasEst.filter(a => a.estado === 'tardanza').length;
                    const ausenciasJ = asistenciasEst.filter(a => a.estado === 'ausente_j').length;
                    const ausenciasI = asistenciasEst.filter(a => a.estado === 'ausente_i').length;
                    
                    const ausenciasPorTardanza = Math.floor(tardanzas / asig.tardanzasPorAusencia);
                    const totalAusenciasInjustificadas = ausenciasI + ausenciasPorTardanza;
                    
                    // Calcular d√≠as h√°biles del per√≠odo (simplificado)
                    const diasHabiles = 60; // Aproximado
                    const porcentajeAsistencia = ((diasHabiles - totalAusenciasInjustificadas) / diasHabiles * 100).toFixed(1);
                    
                    return `
                        <tr>
                            <td><code>${est.idSEA}</code></td>
                            <td><strong>${est.nombre}</strong>${est.adecuacion === 'acs' ? ' <span style="color: var(--orange); font-size: 11px;">(ACS)</span>' : ''}</td>
                            <td class="text-center">${ausenciasJ}</td>
                            <td class="text-center">${tardanzas}</td>
                            <td class="text-center">${ausenciasPorTardanza}</td>
                            <td class="text-center">${ausenciasI}</td>
                            <td class="text-center"><strong>${totalAusenciasInjustificadas}</strong></td>
                            <td class="text-center ${porcentajeAsistencia < 85 ? 'text-danger' : 'text-success'}">${porcentajeAsistencia}%</td>
                        </tr>
                    `;
                }).join('');
            },

            descargarReporteAsistencia(formato) {
                const asignaturaId = document.getElementById('reporteAsistenciaAsignatura').value;
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const periodo = document.getElementById('reporteAsistenciaPeriodo').value;
                
                const data = [];
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                estudiantes.forEach(est => {
                    const asistenciasEst = this.data.asistencias.filter(a => 
                        a.estudianteId === est.id && a.asignaturaId === asignaturaId
                    );
                    
                    const tardanzas = asistenciasEst.filter(a => a.estado === 'tardanza').length;
                    const ausenciasJ = asistenciasEst.filter(a => a.estado === 'ausente_j').length;
                    const ausenciasI = asistenciasEst.filter(a => a.estado === 'ausente_i').length;
                    const ausenciasPorTardanza = Math.floor(tardanzas / asig.tardanzasPorAusencia);
                    const totalAusenciasInjustificadas = ausenciasI + ausenciasPorTardanza;
                    
                    data.push({
                        'ID_SEA': est.idSEA,
                        'Nombre': est.nombre,
                        'Ausencias_Justificadas': ausenciasJ,
                        'Tardanzas': tardanzas,
                        'Ausencias_por_Tardanza': ausenciasPorTardanza,
                        'Ausencias_Injustificadas_Directas': ausenciasI,
                        'Total_Ausencias_Injustificadas': totalAusenciasInjustificadas
                    });
                });

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Asistencia");
                XLSX.writeFile(wb, `Asistencia_${asig.nombre}_${seccion.nombre}_${periodo}.xlsx`);
                this.showToast('Reporte de asistencia descargado', 'success');
            },

            // ==========================================
            // EVALUACIONES
            // ==========================================
            cambiarTabEvaluacion(tipo, btn) {
                document.querySelectorAll('#page-evaluaciones .tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                this.data.current.tabEvaluacion = tipo;
                this.cargarEvaluacion();
            },

            cargarEvaluacion() {
                const tipo = this.data.current.tabEvaluacion;
                const container = document.getElementById('contenidoEvaluacion');
                
                // Verificar si hay asignatura seleccionada
                const asignaturaId = document.getElementById('evalAsignatura')?.value;
                if (!asignaturaId) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <h3>Seleccione una asignatura</h3>
                            <p>Debe seleccionar una asignatura para configurar la evaluaci√≥n</p>
                        </div>
                    `;
                    return;
                }

                if (tipo === 'trabajo') {
                    this.renderTrabajoCotidiano(container);
                } else if (tipo === 'tareas') {
                    this.renderTareas(container);
                } else if (tipo === 'pruebas') {
                    this.renderPruebas(container);
                } else if (tipo === 'proyecto') {
                    this.renderProyecto(container);
                }
            },

            renderTrabajoCotidiano(container) {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const indicadores = this.data.evaluaciones.indicadores.filter(i => 
                    i.asignaturaId === asignaturaId && i.periodo === periodo
                );
                
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig?.seccionId);
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion?.id);
                const estudiantesACS = estudiantes.filter(e => e.adecuacion === 'acs');
                const estudiantesRegulares = estudiantes.filter(e => e.adecuacion !== 'acs');

                // Verificar alertas MEP
                const alertas = [];
                if (indicadores.length === 0) {
                    alertas.push('No hay indicadores de logro configurados para este per√≠odo');
                }
                
                const alertContainer = document.getElementById('alertasMEP');
                if (alertas.length > 0) {
                    alertContainer.innerHTML = '‚ö†Ô∏è ' + alertas.join(' | ');
                    alertContainer.style.display = 'flex';
                } else {
                    alertContainer.style.display = 'none';
                }

                let html = `
                    <div class="indicadores-section">
                        <div class="indicadores-header">
                            <h3>üìã Indicadores de Logro</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small btn-ghost" onclick="app.agregarIndicadorSimultaneo()">
                                    ‚ö° Agregar a M√∫ltiples
                                </button>
                                <button class="btn btn-small btn-primary" onclick="app.abrirModalIndicador()">
                                    ‚ûï Nuevo Indicador
                                </button>
                            </div>
                        </div>
                `;
                
                if (indicadores.length === 0) {
                    html += `<div class="empty-state" style="padding: 40px;"><p>No hay indicadores configurados. Agregue indicadores de logro.</p></div>`;
                } else {
                    html += indicadores.map(ind => `
                        <div class="indicador-card">
                            <div class="indicador-header">
                                <div class="indicador-titulo">${ind.nombre}</div>
                                <div class="indicador-porcentaje">${ind.porcentaje}%</div>
                            </div>
                            <div class="indicador-descripcion">${ind.descripcion}</div>
                            <div class="indicador-meta">
                                <span>üìÖ ${this.formatearFecha(ind.fecha)}</span>
                                <span>üéØ M√°x: ${ind.puntosMax} pts</span>
                            </div>
                            <div class="indicador-acciones">
                                <button class="btn btn-small btn-ghost" onclick="app.editarIndicador('${ind.id}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-small btn-danger" onclick="app.eliminarIndicador('${ind.id}')">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                html += `</div>`;

                // Tabla de calificaci√≥n
                if (indicadores.length > 0) {
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">üìù Registro de Notas - Estudiantes Regulares</div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Estudiante</th>
                                            ${indicadores.map(i => `<th>${i.nombre.substring(0, 15)}...<br><small>Max: ${i.puntosMax}</small></th>`).join('')}
                                            <th>Promedio<br>Componente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${estudiantesRegulares.map(est => {
                                            const notasEst = this.data.evaluaciones.notas[est.id] || {};
                                            let sumaPonderada = 0;
                                            let sumaPorcentajes = 0;
                                            
                                            return `
                                                <tr>
                                                    <td><strong>${est.nombre}</strong></td>
                                                    ${indicadores.map(ind => {
                                                        const nota = notasEst[ind.id] || '';
                                                        const porcentajeInd = (nota / ind.puntosMax * 100) * (ind.porcentaje / 100);
                                                        if (nota) {
                                                            sumaPonderada += porcentajeInd;
                                                            sumaPorcentajes += ind.porcentaje;
                                                        }
                                                        return `
                                                            <td>
                                                                <div style="display: flex; align-items: center; gap: 4px;">
                                                                    <input type="number" 
                                                                           class="nota-input ${nota ? 'saved' : ''}" 
                                                                           value="${nota}"
                                                                           min="0" 
                                                                           max="${ind.puntosMax}"
                                                                           placeholder="0-${ind.puntosMax}"
                                                                           onchange="app.guardarNotaTrabajo(this, '${est.id}', '${ind.id}', ${ind.puntosMax})">
                                                                    <span class="save-status" id="status-${est.id}-${ind.id}"></span>
                                                                </div>
                                                            </td>
                                                        `;
                                                    }).join('')}
                                                    <td><strong class="text-info">${sumaPorcentajes > 0 ? (sumaPonderada / sumaPorcentajes * 100).toFixed(1) : '--'}</strong></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    // Secci√≥n ACS separada
                    if (estudiantesACS.length > 0) {
                        html += `
                            <div class="card" style="margin-top: 24px; border-left: 4px solid var(--orange);">
                                <div class="card-header">
                                    <div class="card-title">‚ö†Ô∏è Estudiantes con Adecuaci√≥n Curricular Significativa (ACS)</div>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Estudiante</th>
                                                ${indicadores.map(i => `<th>${i.nombre.substring(0, 15)}...<br><small>Max: ${i.puntosMax}</small></th>`).join('')}
                                                <th>Promedio<br>Componente</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${estudiantesACS.map(est => {
                                                const notasEst = this.data.evaluaciones.notas[est.id] || {};
                                                let sumaPonderada = 0;
                                                let sumaPorcentajes = 0;
                                                
                                                return `
                                                    <tr class="fila-acs">
                                                        <td>
                                                            <strong>${est.nombre}</strong>
                                                            <div style="font-size: 11px; color: var(--orange); font-weight: 600;">${est.detalleACS || 'ACS'}</div>
                                                        </td>
                                                        ${indicadores.map(ind => {
                                                            const nota = notasEst[ind.id] || '';
                                                            const porcentajeInd = (nota / ind.puntosMax * 100) * (ind.porcentaje / 100);
                                                            if (nota) {
                                                                sumaPonderada += porcentajeInd;
                                                                sumaPorcentajes += ind.porcentaje;
                                                            }
                                                            return `
                                                                <td>
                                                                    <div style="display: flex; align-items: center; gap: 4px;">
                                                                        <input type="number" 
                                                                               class="nota-input ${nota ? 'saved' : ''}" 
                                                                               style="border-color: var(--orange);"
                                                                               value="${nota}"
                                                                               min="0" 
                                                                               max="${ind.puntosMax}"
                                                                               placeholder="0-${ind.puntosMax}"
                                                                               onchange="app.guardarNotaTrabajo(this, '${est.id}', '${ind.id}', ${ind.puntosMax})">
                                                                        <span class="save-status" id="status-${est.id}-${ind.id}"></span>
                                                                    </div>
                                                                </td>
                                                            `;
                                                        }).join('')}
                                                        <td><strong class="text-warning">${sumaPorcentajes > 0 ? (sumaPonderada / sumaPorcentajes * 100).toFixed(1) : '--'}</strong></td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                }
                
                container.innerHTML = html;
            },

            guardarNotaTrabajo(input, estudianteId, indicadorId, puntosMax) {
                const statusSpan = document.getElementById(`status-${estudianteId}-${indicadorId}`);
                const valor = parseFloat(input.value);
                
                // Validar rango
                if (valor < 0 || valor > puntosMax) {
                    input.classList.add('error');
                    input.classList.remove('saved');
                    if (statusSpan) statusSpan.textContent = '‚úó';
                    this.showToast(`La nota debe estar entre 0 y ${puntosMax}`, 'error');
                    return;
                }
                
                // Estado guardando
                input.classList.add('saving');
                input.classList.remove('error', 'saved');
                if (statusSpan) statusSpan.textContent = 'üîÑ';
                
                // Simular guardado
                setTimeout(() => {
                    // Guardar en estructura de datos
                    if (!this.data.evaluaciones.notas[estudianteId]) {
                        this.data.evaluaciones.notas[estudianteId] = {};
                    }
                    this.data.evaluaciones.notas[estudianteId][indicadorId] = valor;
                    
                    input.classList.remove('saving');
                    input.classList.add('saved');
                    if (statusSpan) statusSpan.textContent = '‚úì';
                    
                    // Recalcular promedios
                    this.renderTrabajoCotidiano(document.getElementById('contenidoEvaluacion'));
                }, 500);
            },

            renderTareas(container) {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const tareas = this.data.evaluaciones.tareas.filter(t => 
                    t.asignaturaId === asignaturaId && t.periodo === periodo
                );
                
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                
                // Verificar m√≠nimo 3 tareas
                const alertContainer = document.getElementById('alertasMEP');
                if (tareas.length < 3) {
                    alertContainer.innerHTML = `‚ö†Ô∏è MEP 2026: Debe configurar m√≠nimo 3 tareas por per√≠odo. Actualmente tiene ${tareas.length}.`;
                    alertContainer.style.display = 'flex';
                } else {
                    alertContainer.style.display = 'none';
                }

                let html = `
                    <div class="indicadores-section">
                        <div class="indicadores-header">
                            <h3>üìö Tareas del Per√≠odo</h3>
                            <button class="btn btn-small btn-primary" onclick="app.abrirModalTarea()">
                                ‚ûï Nueva Tarea
                            </button>
                        </div>
                `;
                
                if (tareas.length === 0) {
                    html += `<div class="empty-state" style="padding: 40px;"><p>No hay tareas configuradas. Agregue al menos 3 tareas.</p></div>`;
                } else {
                    html += `<div class="grid-2">` + tareas.map(tar => {
                        // Validar plazos MEP
                        const fechaAsignacion = new Date(tar.fechaAsignacion);
                        const fechaEntrega = new Date(tar.fechaEntrega);
                        const fechaDevolucion = new Date(tar.fechaDevolucion);
                        
                        const diasEntrega = Math.ceil((fechaEntrega - fechaAsignacion) / (1000 * 60 * 60 * 24));
                        const diasDevolucion = Math.ceil((fechaDevolucion - fechaAsignacion) / (1000 * 60 * 60 * 24));
                        
                        const claseEntrega = diasEntrega >= 2 ? 'validacion-ok' : 'validacion-error';
                        const claseDevolucion = diasDevolucion <= 8 ? 'validacion-ok' : 'validacion-error';
                        
                        return `
                            <div class="indicador-card">
                                <div class="indicador-header">
                                    <div class="indicador-titulo">${tar.nombre}</div>
                                    <div class="indicador-porcentaje">${tar.puntosMax} pts</div>
                                </div>
                                <div class="indicador-descripcion">${tar.descripcion}</div>
                                <div class="indicador-meta">
                                    <span>üìÖ Asignaci√≥n: ${this.formatearFecha(tar.fechaAsignacion)}</span>
                                    <span>üì• Entrega: ${this.formatearFecha(tar.fechaEntrega)} <span class="${claseEntrega}">(${diasEntrega} d√≠as)</span></span>
                                    <span>üì§ Devoluci√≥n: ${this.formatearFecha(tar.fechaDevolucion)} <span class="${claseDevolucion}">(${diasDevolucion} d√≠as h√°biles)</span></span>
                                </div>
                                <div class="indicador-acciones">
                                    <button class="btn btn-small btn-ghost" onclick="app.editarTarea('${tar.id}')">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-small btn-primary" onclick="app.ingresarNotasTarea('${tar.id}')">üìù Notas</button>
                                    <button class="btn btn-small btn-danger" onclick="app.eliminarTarea('${tar.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('') + `</div>`;
                }
                
                html += `</div>`;
                container.innerHTML = html;
            },

            renderPruebas(container) {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const pruebas = this.data.evaluaciones.pruebas.filter(p => 
                    p.asignaturaId === asignaturaId && p.periodo === periodo
                );

                let html = `
                    <div class="indicadores-section">
                        <div class="indicadores-header">
                            <h3>üìù Pruebas del Per√≠odo</h3>
                            <button class="btn btn-small btn-primary" onclick="app.abrirModalPrueba()">
                                ‚ûï Nueva Prueba
                            </button>
                        </div>
                `;
                
                if (pruebas.length === 0) {
                    html += `<div class="empty-state" style="padding: 40px;"><p>No hay pruebas configuradas.</p></div>`;
                } else {
                    html += `<div class="grid-2">` + pruebas.map(pru => `
                        <div class="indicador-card">
                            <div class="indicador-header">
                                <div class="indicador-titulo">${pru.nombre}</div>
                                <div class="indicador-porcentaje">${pru.tipo}</div>
                            </div>
                            <div class="indicador-descripcion">
                                <strong>Puntos m√°ximos:</strong> ${pru.puntosMax}<br>
                                <strong>Tiempo m√°ximo:</strong> ${pru.tiempoMaximo} lecciones<br>
                                <strong>Instrumento:</strong> ${pru.instrumento}
                            </div>
                            <div class="indicador-meta">
                                <span>üìÖ Fecha: ${this.formatearFecha(pru.fecha)}</span>
                            </div>
                            <div class="indicador-acciones">
                                <button class="btn btn-small btn-ghost" onclick="app.editarPrueba('${pru.id}')">‚úèÔ∏è Editar</button>
                                <button class="btn btn-small btn-primary" onclick="app.ingresarNotasPrueba('${pru.id}')">üìù Notas</button>
                                <button class="btn btn-small btn-danger" onclick="app.eliminarPrueba('${pru.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('') + `</div>`;
                }
                
                html += `</div>`;
                container.innerHTML = html;
            },

            renderProyecto(container) {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const proyectos = this.data.evaluaciones.proyectos.filter(p => 
                    p.asignaturaId === asignaturaId && p.periodo === periodo
                );

                let html = `
                    <div class="indicadores-section">
                        <div class="indicadores-header">
                            <h3>üéØ Proyectos del Per√≠odo</h3>
                            <button class="btn btn-small btn-primary" onclick="app.abrirModalProyecto()">
                                ‚ûï Nuevo Proyecto
                            </button>
                        </div>
                        <div style="background: #e3f2fd; padding: 12px; border-radius: var(--radius); margin-bottom: 20px; font-size: 13px;">
                            <strong>‚ÑπÔ∏è Informaci√≥n MEP 2026:</strong> El proyecto se eval√∫a por desempe√±o en todo el proceso, NO por etapas. 
                            La nota m√≠nima es 1 solo si no entrega ninguna etapa, previa comunicaci√≥n al encargado.
                        </div>
                `;
                
                if (proyectos.length === 0) {
                    html += `<div class="empty-state" style="padding: 40px;"><p>No hay proyectos configurados.</p></div>`;
                } else {
                    html += proyectos.map(pro => {
                        const etapasCompletadas = pro.etapas.filter(e => e.completada).length;
                        const progreso = (etapasCompletadas / pro.etapas.length * 100).toFixed(0);
                        
                        return `
                            <div class="indicador-card">
                                <div class="indicador-header">
                                    <div class="indicador-titulo">${pro.nombre}</div>
                                    <div class="indicador-porcentaje">${pro.puntosMax} pts</div>
                                </div>
                                <div class="indicador-descripcion">${pro.descripcion}</div>
                                <div style="margin: 16px 0;">
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                        <span>Progreso de etapas</span>
                                        <span>${progreso}%</span>
                                    </div>
                                    <div style="background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div style="background: var(--success); height: 100%; width: ${progreso}%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div class="indicador-meta">
                                    <span>üìÖ Inicio: ${this.formatearFecha(pro.fechaInicio)}</span>
                                    <span>üèÅ Fin: ${this.formatearFecha(pro.fechaFin)}</span>
                                </div>
                                <div style="margin-top: 12px;">
                                    <strong>Etapas:</strong>
                                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                        ${pro.etapas.map((etapa, idx) => `
                                            <span class="badge ${etapa.completada ? 'badge-success' : 'badge-warning'}" 
                                                  style="cursor: pointer;"
                                                  onclick="app.toggleEtapaProyecto('${pro.id}', ${idx})">
                                                ${etapa.completada ? '‚úì' : '‚óã'} ${etapa.nombre}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="indicador-acciones" style="margin-top: 16px;">
                                    <button class="btn btn-small btn-ghost" onclick="app.editarProyecto('${pro.id}')">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-small btn-primary" onclick="app.ingresarNotasProyecto('${pro.id}')">üìù Notas Finales</button>
                                    <button class="btn btn-small btn-danger" onclick="app.eliminarProyecto('${pro.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                html += `</div>`;
                container.innerHTML = html;
            },

            // ==========================================
            // C√ÅLCULOS DE NOTAS
            // ==========================================
            calcularNotaComponente(puntosObtenidos, puntosTotales) {
                if (!puntosTotales) return 0;
                return (puntosObtenidos * 100) / puntosTotales;
            },

            calcularNotaPeriodo(estudianteId, asignaturaId, periodo) {
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                if (!asig) return 0;
                
                const notasEst = this.data.evaluaciones.notas[estudianteId] || {};
                let notaFinal = 0;
                
                // Trabajo Cotidiano
                if (asig.porcentajes.trabajo > 0) {
                    const indicadores = this.data.evaluaciones.indicadores.filter(i => 
                        i.asignaturaId === asignaturaId && i.periodo === periodo
                    );
                    let sumaIndicadores = 0;
                    let pesoTotal = 0;
                    indicadores.forEach(ind => {
                        const nota = notasEst[ind.id] || 0;
                        const porcentajeInd = (nota / ind.puntosMax * 100);
                        sumaIndicadores += porcentajeInd * (ind.porcentaje / 100);
                        pesoTotal += ind.porcentaje;
                    });
                    const notaTrabajo = pesoTotal > 0 ? sumaIndicadores / pesoTotal * 100 : 0;
                    notaFinal += notaTrabajo * (asig.porcentajes.trabajo / 100);
                }
                
                // Tareas
                if (asig.porcentajes.tareas > 0) {
                    const tareas = this.data.evaluaciones.tareas.filter(t => 
                        t.asignaturaId === asignaturaId && t.periodo === periodo
                    );
                    let sumaTareas = 0;
                    let countTareas = 0;
                    tareas.forEach(tar => {
                        const nota = notasEst[tar.id] || 0;
                        sumaTareas += (nota / tar.puntosMax * 100);
                        countTareas++;
                    });
                    const notaTareas = countTareas > 0 ? sumaTareas / countTareas : 0;
                    notaFinal += notaTareas * (asig.porcentajes.tareas / 100);
                }
                
                // Pruebas
                if (asig.porcentajes.pruebas > 0) {
                    const pruebas = this.data.evaluaciones.pruebas.filter(p => 
                        p.asignaturaId === asignaturaId && p.periodo === periodo
                    );
                    let sumaPruebas = 0;
                    let countPruebas = 0;
                    pruebas.forEach(pru => {
                        const nota = notasEst[pru.id] || 0;
                        sumaPruebas += (nota / pru.puntosMax * 100);
                        countPruebas++;
                    });
                    const notaPruebas = countPruebas > 0 ? sumaPruebas / countPruebas : 0;
                    notaFinal += notaPruebas * (asig.porcentajes.pruebas / 100);
                }
                
                // Asistencia
                if (asig.porcentajes.asistencia > 0) {
                    const asistenciasEst = this.data.asistencias.filter(a => 
                        a.estudianteId === estudianteId && 
                        a.asignaturaId === asignaturaId
                    );
                    const tardanzas = asistenciasEst.filter(a => a.estado === 'tardanza').length;
                    const ausenciasI = asistenciasEst.filter(a => a.estado === 'ausente_i').length;
                    const ausenciasPorTardanza = Math.floor(tardanzas / asig.tardanzasPorAusencia);
                    const totalAusencias = ausenciasI + ausenciasPorTardanza;
                    
                    // Calcular porcentaje de asistencia (simplificado)
                    const diasHabiles = 60; // Aproximado para el per√≠odo
                    const porcentajeAsistencia = Math.max(0, ((diasHabiles - totalAusencias) / diasHabiles * 100));
                    
                    // Convertir a nota (100% asistencia = 100, cada falta resta proporcionalmente)
                    const notaAsistencia = Math.min(100, porcentajeAsistencia);
                    notaFinal += notaAsistencia * (asig.porcentajes.asistencia / 100);
                }
                
                // Proyecto
                if (asig.porcentajes.proyecto > 0) {
                    const proyectos = this.data.evaluaciones.proyectos.filter(p => 
                        p.asignaturaId === asignaturaId && p.periodo === periodo
                    );
                    let sumaProyectos = 0;
                    let countProyectos = 0;
                    proyectos.forEach(pro => {
                        const nota = notasEst[pro.id] || 0;
                        sumaProyectos += (nota / pro.puntosMax * 100);
                        countProyectos++;
                    });
                    const notaProyecto = countProyectos > 0 ? sumaProyectos / countProyectos : 0;
                    notaFinal += notaProyecto * (asig.porcentajes.proyecto / 100);
                }
                
                return Math.round(notaFinal * 10) / 10;
            },

            calcularNotaAnual(estudianteId, asignaturaId) {
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                
                let notaAnual = 0;
                seccion.periodos.forEach(periodo => {
                    const notaPeriodo = this.calcularNotaPeriodo(estudianteId, asignaturaId, periodo.id);
                    notaAnual += notaPeriodo * (periodo.porcentaje / 100);
                });
                
                return Math.round(notaAnual * 10) / 10;
            },

            // ==========================================
            // REPORTES
            // ==========================================
            cargarSelectsReportes() {
                // Reporte Per√≠odo
                const repPerAsig = document.getElementById('repPeriodoAsignatura');
                repPerAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');

                // Reporte Anual
                const repAnualAsig = document.getElementById('repAnualAsignatura');
                repAnualAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');

                // Reporte Individual
                const repIndAsig = document.getElementById('repIndAsignatura');
                repIndAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');

                // Reporte Eximidos
                const repEximAsig = document.getElementById('repEximAsignatura');
                repEximAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                    this.data.asignaturas.map(a => {
                        const sec = this.data.secciones.find(s => s.id === a.seccionId);
                        return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                    }).join('');
            },

            generarReportePeriodo() {
                const asignaturaId = document.getElementById('repPeriodoAsignatura').value;
                const periodoIdx = document.getElementById('repPeriodoPeriodo').value;
                
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const periodo = seccion.periodos.find(p => p.id === 'p' + (['I', 'II', 'III'].indexOf(periodoIdx) + 1)) || seccion.periodos[0];
                
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                let html = `
                    <div class="reporte-oficial" style="padding: 20px; max-width: 100%;">
                        <div class="reporte-membrete">
                            <div class="reporte-logo-mep">
                                <div class="escudo">üèõÔ∏è</div>
                                <div>
                                    <h4>Ministerio de Educaci√≥n P√∫blica<br>Costa Rica</h4>
                                    <small>${asig.regional || 'Direcci√≥n Regional'}</small>
                                </div>
                            </div>
                            <div class="reporte-inst">
                                <h4>${this.data.instituciones.find(i => i.id === seccion.institucionId)?.nombre || 'Instituci√≥n'}</h4>
                                <small>Circuito: ${this.data.instituciones.find(i => i.id === seccion.institucionId)?.circuito || 'N/A'}</small>
                            </div>
                        </div>
                        
                        <div class="reporte-titulo">
                            <h2>Reporte de Notas - ${periodo.nombre}</h2>
                            <p>Asignatura: ${asig.nombre} | Secci√≥n: ${seccion.nombre} | A√±o: ${seccion.anio}</p>
                        </div>
                        
                        <table class="reporte-tabla">
                            <thead>
                                <tr>
                                    <th>ID SEA</th>
                                    <th>Estudiante</th>
                                    ${asig.porcentajes.trabajo > 0 ? '<th>Trabajo<br>Cotidiano</th>' : ''}
                                    ${asig.porcentajes.tareas > 0 ? '<th>Tareas</th>' : ''}
                                    ${asig.porcentajes.pruebas > 0 ? '<th>Pruebas</th>' : ''}
                                    ${asig.porcentajes.asistencia > 0 ? '<th>Asistencia</th>' : ''}
                                    ${asig.porcentajes.proyecto > 0 ? '<th>Proyecto</th>' : ''}
                                    <th>Nota Final<br>Per√≠odo</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                estudiantes.forEach(est => {
                    const notaFinal = this.calcularNotaPeriodo(est.id, asignaturaId, periodo.id);
                    const notasEst = this.data.evaluaciones.notas[est.id] || {};
                    
                    html += `
                        <tr>
                            <td>${est.idSEA}</td>
                            <td><strong>${est.nombre}</strong>${est.adecuacion === 'acs' ? ' <span style="color: #fd7e14;">(ACS)</span>' : ''}</td>
                            ${asig.porcentajes.trabajo > 0 ? `<td>${this.calcularNotaComponenteTrabajo(est.id, asignaturaId, periodo.id).toFixed(1)}</td>` : ''}
                            ${asig.porcentajes.tareas > 0 ? `<td>${this.calcularNotaComponenteTareas(est.id, asignaturaId, periodo.id).toFixed(1)}</td>` : ''}
                            ${asig.porcentajes.pruebas > 0 ? `<td>${this.calcularNotaComponentePruebas(est.id, asignaturaId, periodo.id).toFixed(1)}</td>` : ''}
                            ${asig.porcentajes.asistencia > 0 ? `<td>${this.calcularNotaComponenteAsistencia(est.id, asignaturaId).toFixed(1)}</td>` : ''}
                            ${asig.porcentajes.proyecto > 0 ? `<td>${this.calcularNotaComponenteProyecto(est.id, asignaturaId, periodo.id).toFixed(1)}</td>` : ''}
                            <td style="font-weight: bold; ${notaFinal >= asig.notaMinima ? 'color: #28a745;' : 'color: #dc3545;'}">${notaFinal.toFixed(1)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; font-size: 12px; color: var(--gray-600);">
                            <p><strong>Nota:</strong> Nota m√≠nima para aprobar: ${asig.notaMinima} | Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES')}</p>
                        </div>
                    </div>
                `;

                document.getElementById('contenidoReportePeriodo').innerHTML = html;
                document.getElementById('btnDescargarCSV').style.display = 'inline-flex';
            },

            calcularNotaComponenteTrabajo(estudianteId, asignaturaId, periodoId) {
                const indicadores = this.data.evaluaciones.indicadores.filter(i => 
                    i.asignaturaId === asignaturaId && i.periodo === periodoId
                );
                const notasEst = this.data.evaluaciones.notas[estudianteId] || {};
                
                let suma = 0;
                let peso = 0;
                indicadores.forEach(ind => {
                    const nota = notasEst[ind.id] || 0;
                    suma += (nota / ind.puntosMax * 100) * (ind.porcentaje / 100);
                    peso += ind.porcentaje;
                });
                
                return peso > 0 ? suma / peso * 100 : 0;
            },

            calcularNotaComponenteTareas(estudianteId, asignaturaId, periodoId) {
                const tareas = this.data.evaluaciones.tareas.filter(t => 
                    t.asignaturaId === asignaturaId && t.periodo === periodoId
                );
                const notasEst = this.data.evaluaciones.notas[estudianteId] || {};
                
                let suma = 0;
                let count = 0;
                tareas.forEach(tar => {
                    const nota = notasEst[tar.id] || 0;
                    suma += (nota / tar.puntosMax * 100);
                    count++;
                });
                
                return count > 0 ? suma / count : 0;
            },

            calcularNotaComponentePruebas(estudianteId, asignaturaId, periodoId) {
                const pruebas = this.data.evaluaciones.pruebas.filter(p => 
                    p.asignaturaId === asignaturaId && p.periodo === periodoId
                );
                const notasEst = this.data.evaluaciones.notas[estudianteId] || {};
                
                let suma = 0;
                let count = 0;
                pruebas.forEach(pru => {
                    const nota = notasEst[pru.id] || 0;
                    suma += (nota / pru.puntosMax * 100);
                    count++;
                });
                
                return count > 0 ? suma / count : 0;
            },

            calcularNotaComponenteAsistencia(estudianteId, asignaturaId) {
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const asistenciasEst = this.data.asistencias.filter(a => 
                    a.estudianteId === estudianteId && 
                    a.asignaturaId === asignaturaId
                );
                
                const tardanzas = asistenciasEst.filter(a => a.estado === 'tardanza').length;
                const ausenciasI = asistenciasEst.filter(a => a.estado === 'ausente_i').length;
                const ausenciasPorTardanza = Math.floor(tardanzas / asig.tardanzasPorAusencia);
                const totalAusencias = ausenciasI + ausenciasPorTardanza;
                
                const diasHabiles = 60;
                return Math.max(0, ((diasHabiles - totalAusencias) / diasHabiles * 100));
            },

            calcularNotaComponenteProyecto(estudianteId, asignaturaId, periodoId) {
                const proyectos = this.data.evaluaciones.proyectos.filter(p => 
                    p.asignaturaId === asignaturaId && p.periodo === periodoId
                );
                const notasEst = this.data.evaluaciones.notas[estudianteId] || {};
                
                let suma = 0;
                let count = 0;
                proyectos.forEach(pro => {
                    const nota = notasEst[pro.id] || 0;
                    suma += (nota / pro.puntosMax * 100);
                    count++;
                });
                
                return count > 0 ? suma / count : 0;
            },

            descargarCSVPeriodo() {
                const asignaturaId = document.getElementById('repPeriodoAsignatura').value;
                const periodoIdx = document.getElementById('repPeriodoPeriodo').value;
                
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const periodo = seccion.periodos.find(p => p.id === 'p' + (['I', 'II', 'III'].indexOf(periodoIdx) + 1)) || seccion.periodos[0];
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                let csv = 'ID_SEA,Nombre_Completo,';
                if (asig.porcentajes.trabajo > 0) csv += 'Trabajo_Cotidiano,';
                if (asig.porcentajes.tareas > 0) csv += 'Tareas,';
                if (asig.porcentajes.pruebas > 0) csv += 'Pruebas,';
                if (asig.porcentajes.asistencia > 0) csv += 'Asistencia,';
                if (asig.porcentajes.proyecto > 0) csv += 'Proyecto,';
                csv += 'Nota_Final_Periodo\n';
                
                estudiantes.forEach(est => {
                    const notaFinal = this.calcularNotaPeriodo(est.id, asignaturaId, periodo.id);
                    csv += `${est.idSEA},"${est.nombre}",`;
                    if (asig.porcentajes.trabajo > 0) csv += `${this.calcularNotaComponenteTrabajo(est.id, asignaturaId, periodo.id).toFixed(1)},`;
                    if (asig.porcentajes.tareas > 0) csv += `${this.calcularNotaComponenteTareas(est.id, asignaturaId, periodo.id).toFixed(1)},`;
                    if (asig.porcentajes.pruebas > 0) csv += `${this.calcularNotaComponentePruebas(est.id, asignaturaId, periodo.id).toFixed(1)},`;
                    if (asig.porcentajes.asistencia > 0) csv += `${this.calcularNotaComponenteAsistencia(est.id, asignaturaId).toFixed(1)},`;
                    if (asig.porcentajes.proyecto > 0) csv += `${this.calcularNotaComponenteProyecto(est.id, asignaturaId, periodo.id).toFixed(1)},`;
                    csv += `${notaFinal.toFixed(1)}\n`;
                });
                
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Notas_${asig.nombre}_${seccion.nombre}_${periodo.nombre}.csv`;
                link.click();
                this.showToast('CSV descargado correctamente', 'success');
            },

            generarReporteAnual() {
                const asignaturaId = document.getElementById('repAnualAsignatura').value;
                const filtro = document.getElementById('repAnualFiltro').value;
                
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                
                let estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                // Calcular notas anuales
                const datosEstudiantes = estudiantes.map(est => {
                    const notasPeriodos = seccion.periodos.map(p => ({
                        periodo: p.nombre,
                        porcentaje: p.porcentaje,
                        nota: this.calcularNotaPeriodo(est.id, asignaturaId, p.id)
                    }));
                    const notaAnual = this.calcularNotaAnual(est.id, asignaturaId);
                    return { ...est, notasPeriodos, notaAnual };
                });
                
                // Aplicar filtro
                if (filtro === 'aprobados') {
                    datosEstudiantes = datosEstudiantes.filter(e => e.notaAnual >= asig.notaMinima);
                } else if (filtro === 'reprobados') {
                    datosEstudiantes = datosEstudiantes.filter(e => e.notaAnual < asig.notaMinima);
                }
                
                let html = `
                    <div class="reporte-oficial" style="padding: 20px; max-width: 100%;">
                        <div class="reporte-membrete">
                            <div class="reporte-logo-mep">
                                <div class="escudo">üèõÔ∏è</div>
                                <div>
                                    <h4>Ministerio de Educaci√≥n P√∫blica<br>Costa Rica</h4>
                                </div>
                            </div>
                            <div class="reporte-inst">
                                <h4>${this.data.instituciones.find(i => i.id === seccion.institucionId)?.nombre || 'Instituci√≥n'}</h4>
                            </div>
                        </div>
                        
                        <div class="reporte-titulo">
                            <h2>Reporte Anual de Notas</h2>
                            <p>Asignatura: ${asig.nombre} | Secci√≥n: ${seccion.nombre} | A√±o: ${seccion.anio}</p>
                        </div>
                        
                        <table class="reporte-tabla">
                            <thead>
                                <tr>
                                    <th>ID SEA</th>
                                    <th>Estudiante</th>
                                    ${seccion.periodos.map(p => `<th>${p.nombre}<br>(${p.porcentaje}%)</th>`).join('')}
                                    <th>Nota Anual</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                datosEstudiantes.forEach(est => {
                    const estado = est.notaAnual >= asig.notaMinima ? 
                        '<span style="color: #28a745; font-weight: bold;">APROBADO</span>' : 
                        '<span style="color: #dc3545; font-weight: bold;">REPROBADO</span>';
                    
                    html += `
                        <tr>
                            <td>${est.idSEA}</td>
                            <td><strong>${est.nombre}</strong>${est.adecuacion === 'acs' ? ' <span style="color: #fd7e14;">(ACS)</span>' : ''}</td>
                            ${est.notasPeriodos.map(np => `<td>${np.nota.toFixed(1)}</td>`).join('')}
                            <td style="font-weight: bold; font-size: 16px;">${est.notaAnual.toFixed(1)}</td>
                            <td>${estado}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('contenidoReporteAnual').innerHTML = html;
                document.getElementById('btnDescargarExcelAnual').style.display = 'inline-flex';
            },

            descargarExcelAnual() {
                const asignaturaId = document.getElementById('repAnualAsignatura').value;
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                const data = estudiantes.map(est => {
                    const row = {
                        'ID_SEA': est.idSEA,
                        'Nombre': est.nombre,
                        'Nota_Anual': this.calcularNotaAnual(est.id, asignaturaId).toFixed(1),
                        'Estado': this.calcularNotaAnual(est.id, asignaturaId) >= asig.notaMinima ? 'APROBADO' : 'REPROBADO'
                    };
                    
                    seccion.periodos.forEach(p => {
                        row[p.nombre] = this.calcularNotaPeriodo(est.id, asignaturaId, p.id).toFixed(1);
                    });
                    
                    return row;
                });
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Notas Anuales");
                XLSX.writeFile(wb, `Notas_Anual_${asig.nombre}_${seccion.nombre}.xlsx`);
                this.showToast('Excel descargado correctamente', 'success');
            },

            cargarEstudiantesReporteIndividual() {
                const asignaturaId = document.getElementById('repIndAsignatura').value;
                if (!asignaturaId) return;
                
                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                const selectEst = document.getElementById('repIndEstudiante');
                selectEst.innerHTML = '<option value="">Seleccionar...</option>' +
                    estudiantes.map(e => `<option value="${e.id}">${e.nombre} (${e.idSEA})</option>`).join('');
            },

            generarReporteIndividual() {
                const asignaturaId = document.getElementById('repIndAsignatura').value;
                const estudianteId = document.getElementById('repIndEstudiante').value;
                
                if (!asignaturaId || !estudianteId) {
                    this.showToast('Seleccione asignatura y estudiante', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const estudiante = this.data.estudiantes.find(e => e.id === estudianteId);
                const institucion = this.data.instituciones.find(i => i.id === seccion.institucionId);
                
                // Preparar datos para el gr√°fico
                const notasPeriodos = seccion.periodos.map(p => ({
                    periodo: p.nombre,
                    nota: this.calcularNotaPeriodo(estudianteId, asignaturaId, p.id)
                }));
                
                const notaAnual = this.calcularNotaAnual(estudianteId, asignaturaId);
                
                let html = `
                    <div id="reporteIndividualPDF" class="reporte-oficial" style="padding: 30px; max-width: 100%;">
                        <div class="reporte-membrete">
                            <div class="reporte-logo-mep">
                                <div class="escudo">üèõÔ∏è</div>
                                <div>
                                    <h4>Ministerio de Educaci√≥n P√∫blica<br>Costa Rica</h4>
                                    <small>${institucion?.regional || ''}</small>
                                </div>
                            </div>
                            <div class="reporte-inst">
                                <h4>${institucion?.nombre || 'Instituci√≥n'}</h4>
                                <small>Circuito: ${institucion?.circuito || 'N/A'}</small>
                            </div>
                        </div>
                        
                        <div class="reporte-titulo">
                            <h2>Informe Individual de Rendimiento</h2>
                            <p>A√±o Lectivo: ${seccion.anio}</p>
                        </div>
                        
                        <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <h4 style="margin-bottom: 15px; color: var(--primary);">Datos del Estudiante</h4>
                            <div class="grid-2" style="gap: 10px;">
                                <div><strong>Nombre:</strong> ${estudiante.nombre}</div>
                                <div><strong>ID SEA:</strong> ${estudiante.idSEA}</div>
                                <div><strong>Secci√≥n:</strong> ${seccion.nombre}</div>
                                <div><strong>Asignatura:</strong> ${asig.nombre}</div>
                                ${estudiante.adecuacion !== 'ninguna' ? `<div style="color: var(--orange);"><strong>Adecuaci√≥n:</strong> ${this.getNombreAdecuacion(estudiante.adecuacion)}${estudiante.detalleACS ? ' - ' + estudiante.detalleACS : ''}</div>` : ''}
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 15px;">Desglose por Per√≠odos</h4>
                        <table class="reporte-tabla">
                            <thead>
                                <tr>
                                    <th>Per√≠odo</th>
                                    <th>Ponderaci√≥n</th>
                                    <th>Nota Obtenida</th>
                                    <th>Aporte a Nota Anual</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${notasPeriodos.map(np => `
                                    <tr>
                                        <td>${np.periodo}</td>
                                        <td>${seccion.periodos.find(p => p.nombre === np.periodo)?.porcentaje}%</td>
                                        <td>${np.nota.toFixed(1)}</td>
                                        <td>${(np.nota * (seccion.periodos.find(p => p.nombre === np.periodo)?.porcentaje / 100)).toFixed(1)}</td>
                                    </tr>
                                `).join('')}
                                <tr style="font-weight: bold; background: #e3f2fd;">
                                    <td colspan="3" style="text-align: right;">NOTA ANUAL:</td>
                                    <td style="font-size: 18px; ${notaAnual >= asig.notaMinima ? 'color: #28a745;' : 'color: #dc3545;'}">${notaAnual.toFixed(1)}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px;">Gr√°fico de Rendimiento</h4>
                            <canvas id="chartIndividual" width="400" height="200"></canvas>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--gray-300);">
                            <div class="grid-2">
                                <div style="text-align: center;">
                                    <div style="border-top: 1px solid #000; margin-top: 50px; padding-top: 10px;">
                                        Firma del Docente
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="border-top: 1px solid #000; margin-top: 50px; padding-top: 10px;">
                                        Firma del Encargado
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; font-size: 11px; color: var(--gray-600); text-align: center;">
                            Documento generado el ${new Date().toLocaleDateString('es-ES')} mediante RegistraTe - Sistema de Gesti√≥n Educativa MEP
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="app.descargarPDFIndividual()">üìÑ Descargar PDF</button>
                    </div>
                `;

                document.getElementById('previewReporteIndividual').innerHTML = html;
                
                // Crear gr√°fico
                setTimeout(() => {
                    const ctx = document.getElementById('chartIndividual').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: notasPeriodos.map(np => np.periodo),
                            datasets: [{
                                label: 'Nota del Per√≠odo',
                                data: notasPeriodos.map(np => np.nota),
                                backgroundColor: notasPeriodos.map(np => np.nota >= asig.notaMinima ? '#28a745' : '#dc3545'),
                                borderColor: notasPeriodos.map(np => np.nota >= asig.notaMinima ? '#1e7e34' : '#bd2130'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 10
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }, 100);
            },

            descargarPDFIndividual() {
                const element = document.getElementById('reporteIndividualPDF');
                const opt = {
                    margin: 10,
                    filename: 'Reporte_Individual.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(element).save();
                this.showToast('Generando PDF...', 'success');
            },

            generarReporteEximidos() {
                const asignaturaId = document.getElementById('repEximAsignatura').value;
                
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                const seccion = this.data.secciones.find(s => s.id === asig.seccionId);
                const estudiantes = this.data.estudiantes.filter(e => e.seccionId === seccion.id);
                
                // Evaluar criterios de eximici√≥n
                const datosEximicion = estudiantes.map(est => {
                    const notasPeriodos = seccion.periodos.map((p, idx) => ({
                        periodo: p.nombre,
                        nota: this.calcularNotaPeriodo(est.id, asignaturaId, p.id),
                        esPrimero: idx === 0
                    }));
                    
                    // Criterio 1: ‚â•90 en primer per√≠odo
                    const criterio1 = notasPeriodos[0]?.nota >= 90;
                    
                    // Criterio 2: ‚â•90 en todos los per√≠odos previos + ‚â•90 en componentes del √∫ltimo
                    const notasPrevias = notasPeriodos.slice(0, -1);
                    const ultimoPeriodo = notasPeriodos[notasPeriodos.length - 1];
                    const criterio2 = notasPrevias.every(np => np.nota >= 90) && ultimoPeriodo.nota >= 90;
                    
                    const esEximido = criterio1 || criterio2;
                    const notaFinal = this.calcularNotaAnual(est.id, asignaturaId);
                    
                    return {
                        ...est,
                        notasPeriodos,
                        esEximido,
                        criterio1,
                        criterio2,
                        notaFinal
                    };
                });
                
                let html = `
                    <div class="reporte-oficial" style="padding: 20px; max-width: 100%;">
                        <div class="reporte-membrete">
                            <div class="reporte-logo-mep">
                                <div class="escudo">üèõÔ∏è</div>
                                <div>
                                    <h4>Ministerio de Educaci√≥n P√∫blica<br>Costa Rica</h4>
                                </div>
                            </div>
                            <div class="reporte-inst">
                                <h4>${this.data.instituciones.find(i => i.id === seccion.institucionId)?.nombre || 'Instituci√≥n'}</h4>
                            </div>
                        </div>
                        
                        <div class="reporte-titulo">
                            <h2>Reporte de Estudiantes Eximidos</h2>
                            <p>Asignatura: ${asig.nombre} | Secci√≥n: ${seccion.nombre}</p>
                            <p style="font-size: 12px; margin-top: 10px;">
                                <strong>Criterios:</strong> ‚â•90 en primer per√≠odo O (‚â•90 en todos los per√≠odos previos + ‚â•90 en √∫ltimo per√≠odo)
                            </p>
                        </div>
                        
                        <table class="reporte-tabla">
                            <thead>
                                <tr>
                                    <th>ID SEA</th>
                                    <th>Estudiante</th>
                                    ${seccion.periodos.map(p => `<th>${p.nombre}</th>`).join('')}
                                    <th>Nota Anual</th>
                                    <th>Condici√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                datosEximicion.forEach(est => {
                    const condicion = est.esEximido ? 
                        '<span style="color: #28a745; font-weight: bold; padding: 4px 12px; background: #d4edda; border-radius: 20px;">EXIMIDO</span>' : 
                        '<span style="color: #dc3545; font-weight: bold; padding: 4px 12px; background: #f8d7da; border-radius: 20px;">NO EXIMIDO</span>';
                    
                    html += `
                        <tr style="${est.esEximido ? 'background: #f0fff4;' : ''}">
                            <td>${est.idSEA}</td>
                            <td><strong>${est.nombre}</strong></td>
                            ${est.notasPeriodos.map(np => `
                                <td style="${np.nota >= 90 ? 'color: #28a745; font-weight: bold;' : ''}">${np.nota.toFixed(1)}</td>
                            `).join('')}
                            <td style="font-weight: bold;">${est.notaFinal.toFixed(1)}</td>
                            <td>${condicion}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; font-size: 13px;">
                            <strong>Resumen:</strong> 
                            ${datosEximicion.filter(e => e.esEximido).length} estudiantes eximidos de ${datosEximicion.length} totales
                            (${((datosEximicion.filter(e => e.esEximido).length / datosEximicion.length) * 100).toFixed(1)}%)
                        </div>
                    </div>
                `;

                document.getElementById('contenidoReporteEximidos').innerHTML = html;
            },

            // ==========================================
            // MODALES DE CONFIGURACI√ìN
            // ==========================================
            abrirModalIndicador() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                if (!asignaturaId) {
                    this.showToast('Seleccione una asignatura primero', 'error');
                    return;
                }

                const asig = this.data.asignaturas.find(a => a.id === asignaturaId);
                
                document.getElementById('bodyConfigEvaluacion').innerHTML = `
                    <div class="form-section">
                        <div class="form-section-title">üìã Nuevo Indicador de Logro</div>
                        <div class="form-group">
                            <label>Nombre del Indicador *</label>
                            <input type="text" id="indNombre" placeholder="Ej: Resuelve problemas de multiplicaci√≥n">
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="indDescripcion" rows="3" placeholder="Describa el indicador..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Porcentaje dentro del componente (%)</label>
                                <input type="number" id="indPorcentaje" placeholder="Ej: 25" min="1" max="100">
                            </div>
                            <div class="form-group">
                                <label>Puntos M√°ximos</label>
                                <input type="number" id="indPuntosMax" placeholder="Ej: 25" value="${asig.puntosIndicador * 10}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Fecha de evaluaci√≥n</label>
                            <input type="date" id="indFecha" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="app.guardarIndicador()">Guardar Indicador</button>
                `;
                
                this.openModal('configEvaluacion');
            },

            guardarIndicador() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const nombre = document.getElementById('indNombre').value;
                if (!nombre) {
                    this.showToast('El nombre es obligatorio', 'error');
                    return;
                }

                const nuevo = {
                    id: 'ind_' + Date.now(),
                    asignaturaId,
                    periodo,
                    nombre,
                    descripcion: document.getElementById('indDescripcion').value,
                    porcentaje: parseInt(document.getElementById('indPorcentaje').value) || 25,
                    puntosMax: parseInt(document.getElementById('indPuntosMax').value) || 30,
                    fecha: document.getElementById('indFecha').value
                };

                this.data.evaluaciones.indicadores.push(nuevo);
                this.closeModal('configEvaluacion');
                this.cargarEvaluacion();
                this.showToast('Indicador guardado', 'success');
            },

            abrirModalTarea() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const hoy = new Date().toISOString().split('T')[0];
                const fechaEntrega = this.sumarDias(new Date(), 3);
                const fechaDevolucion = this.sumarDias(new Date(), 10);

                document.getElementById('bodyConfigEvaluacion').innerHTML = `
                    <div class="form-section">
                        <div class="form-section-title">üìö Nueva Tarea</div>
                        <div class="form-group">
                            <label>Nombre de la Tarea *</label>
                            <input type="text" id="tarNombre" placeholder="Ej: Tarea 1 - Fracciones">
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="tarDescripcion" rows="2" placeholder="Descripci√≥n de la tarea..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Puntos M√°ximos</label>
                                <input type="number" id="tarPuntosMax" value="10" min="1">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Asignaci√≥n *</label>
                                <input type="date" id="tarFechaAsignacion" value="${hoy}" onchange="app.validarFechasTarea()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de Entrega *</label>
                                <input type="date" id="tarFechaEntrega" value="${fechaEntrega}" onchange="app.validarFechasTarea()">
                                <small id="valEntrega" style="font-size: 11px;"></small>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Devoluci√≥n *</label>
                                <input type="date" id="tarFechaDevolucion" value="${fechaDevolucion}" onchange="app.validarFechasTarea()">
                                <small id="valDevolucion" style="font-size: 11px;"></small>
                            </div>
                        </div>
                        <div id="alertaTarea" class="alert-mep" style="display: none; margin-top: 10px;"></div>
                    </div>
                    <button class="btn btn-primary" onclick="app.guardarTarea()">Guardar Tarea</button>
                `;
                
                this.openModal('configEvaluacion');
                this.validarFechasTarea();
            },

            validarFechasTarea() {
                const asignacion = new Date(document.getElementById('tarFechaAsignacion').value);
                const entrega = new Date(document.getElementById('tarFechaEntrega').value);
                const devolucion = new Date(document.getElementById('tarFechaDevolucion').value);
                
                const diasEntrega = Math.ceil((entrega - asignacion) / (1000 * 60 * 60 * 24));
                const diasDevolucion = Math.ceil((devolucion - asignacion) / (1000 * 60 * 60 * 24));
                
                const valEntrega = document.getElementById('valEntrega');
                const valDevolucion = document.getElementById('valDevolucion');
                const alerta = document.getElementById('alertaTarea');
                
                // Validar entrega (m√≠nimo 2 d√≠as naturales)
                if (diasEntrega < 2) {
                    valEntrega.innerHTML = '<span class="validacion-error">‚úó Deben ser m√≠nimo 2 d√≠as naturales</span>';
                } else {
                    valEntrega.innerHTML = '<span class="validacion-ok">‚úì Cumple requisito</span>';
                }
                
                // Validar devoluci√≥n (m√°ximo 8 d√≠as h√°biles)
                if (diasDevolucion > 8) {
                    valDevolucion.innerHTML = '<span class="validacion-error">‚úó Excede 8 d√≠as h√°biles</span>';
                    alerta.innerHTML = '‚ö†Ô∏è <strong>Alerta MEP:</strong> La fecha de devoluci√≥n excede los 8 d√≠as h√°biles permitidos.';
                    alerta.style.display = 'flex';
                } else {
                    valDevolucion.innerHTML = '<span class="validacion-ok">‚úì Dentro del l√≠mite</span>';
                    alerta.style.display = 'none';
                }
            },

            guardarTarea() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const nombre = document.getElementById('tarNombre').value;
                if (!nombre) {
                    this.showToast('El nombre es obligatorio', 'error');
                    return;
                }

                const nueva = {
                    id: 'tar_' + Date.now(),
                    asignaturaId,
                    periodo,
                    nombre,
                    descripcion: document.getElementById('tarDescripcion').value,
                    puntosMax: parseInt(document.getElementById('tarPuntosMax').value) || 10,
                    fechaAsignacion: document.getElementById('tarFechaAsignacion').value,
                    fechaEntrega: document.getElementById('tarFechaEntrega').value,
                    fechaDevolucion: document.getElementById('tarFechaDevolucion').value
                };

                this.data.evaluaciones.tareas.push(nueva);
                this.closeModal('configEvaluacion');
                this.cargarEvaluacion();
                this.showToast('Tarea guardada', 'success');
            },

            abrirModalPrueba() {
                document.getElementById('bodyConfigEvaluacion').innerHTML = `
                    <div class="form-section">
                        <div class="form-section-title">üìù Nueva Prueba</div>
                        <div class="form-group">
                            <label>Nombre de la Prueba *</label>
                            <input type="text" id="pruNombre" placeholder="Ej: Prueba Escrita - Unidad 1">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo *</label>
                                <select id="pruTipo">
                                    <option value="Escrita">Escrita</option>
                                    <option value="Oral">Oral</option>
                                    <option value="Pr√°ctica">Pr√°ctica/Ejecuci√≥n</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Puntos M√°ximos</label>
                                <input type="number" id="pruPuntosMax" value="30" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha *</label>
                                <input type="date" id="pruFecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Tiempo M√°ximo (lecciones)</label>
                                <input type="number" id="pruTiempoMax" value="2" min="1" max="3">
                                <small>M√°ximo 2 lecciones (3 si estudiante tiene apoyos educativos)</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Instrumento de Evaluaci√≥n</label>
                            <select id="pruInstrumento">
                                <option value="R√∫brica anal√≠tica">R√∫brica anal√≠tica</option>
                                <option value="Escala de desempe√±o">Escala de desempe√±o</option>
                                <option value="Lista de cotejo">Lista de cotejo</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="app.guardarPrueba()">Guardar Prueba</button>
                `;
                
                this.openModal('configEvaluacion');
            },

            guardarPrueba() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const nombre = document.getElementById('pruNombre').value;
                if (!nombre) {
                    this.showToast('El nombre es obligatorio', 'error');
                    return;
                }

                const nueva = {
                    id: 'pru_' + Date.now(),
                    asignaturaId,
                    periodo,
                    nombre,
                    tipo: document.getElementById('pruTipo').value,
                    puntosMax: parseInt(document.getElementById('pruPuntosMax').value) || 30,
                    fecha: document.getElementById('pruFecha').value,
                    tiempoMaximo: parseInt(document.getElementById('pruTiempoMax').value) || 2,
                    instrumento: document.getElementById('pruInstrumento').value
                };

                this.data.evaluaciones.pruebas.push(nueva);
                this.closeModal('configEvaluacion');
                this.cargarEvaluacion();
                this.showToast('Prueba guardada', 'success');
            },

            abrirModalProyecto() {
                document.getElementById('bodyConfigEvaluacion').innerHTML = `
                    <div class="form-section">
                        <div class="form-section-title">üéØ Nuevo Proyecto</div>
                        <div class="form-group">
                            <label>Nombre del Proyecto *</label>
                            <input type="text" id="proNombre" placeholder="Ej: Mi huerta matem√°tica">
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <textarea id="proDescripcion" rows="3" placeholder="Descripci√≥n del proyecto..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Puntos M√°ximos</label>
                                <input type="number" id="proPuntosMax" value="10" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de Inicio</label>
                                <input type="date" id="proFechaInicio" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Finalizaci√≥n</label>
                                <input type="date" id="proFechaFin" value="${this.sumarDias(new Date(), 30)}">
                            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: var(--radius); margin-top: 10px; font-size: 13px;">
                            <strong>‚ÑπÔ∏è Nota MEP:</strong> El proyecto incluye autom√°ticamente las 4 etapas: Definici√≥n, Planificaci√≥n, Ejecuci√≥n y Evaluaci√≥n.
                            No se asigna porcentaje por etapa, solo calificaci√≥n final por desempe√±o en todo el proceso.
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="app.guardarProyecto()">Guardar Proyecto</button>
                `;
                
                this.openModal('configEvaluacion');
            },

            guardarProyecto() {
                const asignaturaId = document.getElementById('evalAsignatura').value;
                const periodo = document.getElementById('evalPeriodo').value;
                
                const nombre = document.getElementById('proNombre').value;
                if (!nombre) {
                    this.showToast('El nombre es obligatorio', 'error');
                    return;
                }

                const nuevo = {
                    id: 'pro_' + Date.now(),
                    asignaturaId,
                    periodo,
                    nombre,
                    descripcion: document.getElementById('proDescripcion').value,
                    puntosMax: parseInt(document.getElementById('proPuntosMax').value) || 10,
                    fechaInicio: document.getElementById('proFechaInicio').value,
                    fechaFin: document.getElementById('proFechaFin').value,
                    etapas: [
                        { nombre: 'Definici√≥n', completada: false },
                        { nombre: 'Planificaci√≥n', completada: false },
                        { nombre: 'Ejecuci√≥n', completada: false },
                        { nombre: 'Evaluaci√≥n', completada: false }
                    ]
                };

                this.data.evaluaciones.proyectos.push(nuevo);
                this.closeModal('configEvaluacion');
                this.cargarEvaluacion();
                this.showToast('Proyecto guardado', 'success');
            },

            toggleEtapaProyecto(proyectoId, etapaIdx) {
                const proyecto = this.data.evaluaciones.proyectos.find(p => p.id === proyectoId);
                if (proyecto) {
                    proyecto.etapas[etapaIdx].completada = !proyecto.etapas[etapaIdx].completada;
                    this.cargarEvaluacion();
                }
            },

            // ==========================================
            // UTILIDADES Y HELPERS
            // ==========================================
            openModal(modal) {
                const el = document.getElementById('modal' + modal.charAt(0).toUpperCase() + modal.slice(1));
                if (el) el.classList.add('active');
            },

            closeModal(modal) {
                const el = document.getElementById('modal' + modal.charAt(0).toUpperCase() + modal.slice(1));
                if (el) el.classList.remove('active');
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ', warning: '‚ö†' };
                const titles = { success: '√âxito', error: 'Error', info: 'Informaci√≥n', warning: 'Atenci√≥n' };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <div class="toast-content">
                        <div class="toast-title">${titles[type]}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },

            formatearFecha(fechaStr) {
                if (!fechaStr) return '';
                const [anio, mes, dia] = fechaStr.split('-');
                return `${dia}/${mes}/${anio}`;
            },

            cargarSelects() {
                // Instituciones en modales
                const selectsInst = document.querySelectorAll('#secInstitucion, #filtroAsignaturaSeccion');
                selectsInst.forEach(select => {
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Seleccionar...</option>' +
                            this.data.instituciones.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
                        select.value = currentVal;
                    }
                });

                // Secciones en asignaturas
                const selectSecAsig = document.getElementById('asigSeccion');
                if (selectSecAsig) {
                    selectSecAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                        this.data.secciones.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
                }

                // Asignaturas en bit√°cora
                const selectBitAsig = document.getElementById('bitAsignatura');
                if (selectBitAsig) {
                    selectBitAsig.innerHTML = '<option value="">Seleccionar...</option>' +
                        this.data.asignaturas.map(a => {
                            const sec = this.data.secciones.find(s => s.id === a.seccionId);
                            return `<option value="${a.id}">${a.nombre} - ${sec?.nombre}</option>`;
                        }).join('');
                }

                // Filtro bit√°cora
                const filtroBitAsig = document.getElementById('filtroBitacoraAsignatura');
                if (filtroBitAsig) {
                    filtroBitAsig.innerHTML = '<option value="">Todas</option>' +
                        this.data.asignaturas.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
                }

                // Evaluaci√≥n asignaturas
                const evalAsig = document.getElementById('evalAsignatura');
                if (evalAsig) {
                    evalAsig.innerHTML = '<option value="">Seleccionar asignatura...</option>' +
                        this.data.asignaturas.map(a => {
                            const sec = this.data.secciones.find(s => s.id === a.seccionId);
                            return `<option value="${a.id}">${a.nombre} / ${sec?.nombre}</option>`;
                        }).join('');
                }
            },

            actualizarNotificaciones() {
                const hoy = new Date().toISOString().split('T')[0];
                const recordatorios = this.data.bitacoras.filter(b => {
                    if (!b.recordatorio || !b.fechaRecordatorio) return false;
                    return b.fechaRecordatorio === hoy;
                });
                
                const badge = document.getElementById('notifBadge');
                if (recordatorios.length > 0) {
                    badge.textContent = recordatorios.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            },

            showNotifications() {
                const hoy = new Date().toISOString().split('T')[0];
                const recordatorios = this.data.bitacoras.filter(b => 
                    b.recordatorio && b.fechaRecordatorio === hoy
                );
                
                if (recordatorios.length === 0) {
                    this.showToast('No hay recordatorios para hoy', 'info');
                    return;
                }
                
                const lista = recordatorios.map(r => {
                    const asig = this.data.asignaturas.find(a => a.id === r.asignaturaId);
                    return `‚Ä¢ ${asig?.nombre}: ${r.contenido.substring(0, 50)}...`;
                }).join('\n');
                
                alert('Recordatorios de hoy:\n\n' + lista);
            },

            checkPWA() {
                if ('serviceWorker' in navigator) {
                    setTimeout(() => {
                        const btn = document.getElementById('installBtn');
                        if (btn) btn.style.display = 'flex';
                    }, 2000);
                }
            },

            installPWA() {
                this.showToast('Para instalar: use el men√∫ del navegador > Agregar a inicio', 'info');
            },

            syncData() {
                this.showToast('Sincronizando datos...', 'info');
                setTimeout(() => {
                    this.showToast('Datos sincronizados correctamente', 'success');
                }, 1500);
            },

            irEvaluacionRapida(asignaturaId) {
                document.getElementById('evalAsignatura').value = asignaturaId;
                this.navigate('evaluaciones');
                this.cargarEvaluacion();
            },

            irAsistenciaRapida(seccionId) {
                this.navigate('asistencia');
                this.modoRegistroAsistencia();
                setTimeout(() => {
                    document.getElementById('asistenciaSeccion').value = seccionId;
                    this.cargarAsignaturasAsistencia();
                }, 100);
            },

            // Placeholders para funciones adicionales
            editarIndicador(id) { this.showToast('Editar indicador: ' + id, 'info'); },
            eliminarIndicador(id) { 
                if (confirm('¬øEliminar este indicador?')) {
                    this.data.evaluaciones.indicadores = this.data.evaluaciones.indicadores.filter(i => i.id !== id);
                    this.cargarEvaluacion();
                    this.showToast('Indicador eliminado', 'success');
                }
            },
            agregarIndicadorSimultaneo() { this.showToast('Funci√≥n: Agregar a m√∫ltiples asignaturas', 'info'); },
            editarTarea(id) { this.showToast('Editar tarea: ' + id, 'info'); },
            eliminarTarea(id) { 
                if (confirm('¬øEliminar esta tarea?')) {
                    this.data.evaluaciones.tareas = this.data.evaluaciones.tareas.filter(t => t.id !== id);
                    this.cargarEvaluacion();
                    this.showToast('Tarea eliminada', 'success');
                }
            },
            ingresarNotasTarea(id) { 
                this.showToast('Abriendo ingreso de notas para tarea...', 'info');
                // Aqu√≠ se abrir√≠a un modal para ingresar notas
            },
            editarPrueba(id) { this.showToast('Editar prueba: ' + id, 'info'); },
            eliminarPrueba(id) { 
                if (confirm('¬øEliminar esta prueba?')) {
                    this.data.evaluaciones.pruebas = this.data.evaluaciones.pruebas.filter(p => p.id !== id);
                    this.cargarEvaluacion();
                    this.showToast('Prueba eliminada', 'success');
                }
            },
            ingresarNotasPrueba(id) { this.showToast('Abriendo ingreso de notas para prueba...', 'info'); },
            editarProyecto(id) { this.showToast('Editar proyecto: ' + id, 'info'); },
            eliminarProyecto(id) { 
                if (confirm('¬øEliminar este proyecto?')) {
                    this.data.evaluaciones.proyectos = this.data.evaluaciones.proyectos.filter(p => p.id !== id);
                    this.cargarEvaluacion();
                    this.showToast('Proyecto eliminado', 'success');
                }
            },
            ingresarNotasProyecto(id) { this.showToast('Abriendo ingreso de notas para proyecto...', 'info'); },
            
            editarInstitucion(id) { this.showToast('Editar instituci√≥n ' + id, 'info'); },
            eliminarInstitucion(id) { 
                if (confirm('¬øEliminar instituci√≥n? Se perder√°n todos los datos asociados.')) {
                    this.data.instituciones = this.data.instituciones.filter(i => i.id !== id);
                    this.renderInstituciones();
                    this.showToast('Instituci√≥n eliminada', 'success');
                }
            },
            editarSeccion(id) { this.showToast('Editar secci√≥n ' + id, 'info'); },
            eliminarSeccion(id) { 
                if (confirm('¬øEliminar secci√≥n? Se perder√°n estudiantes y evaluaciones.')) {
                    this.data.secciones = this.data.secciones.filter(s => s.id !== id);
                    this.renderSecciones();
                    this.renderDashboard();
                    this.showToast('Secci√≥n eliminada', 'success');
                }
            },
            editarAsignatura(id) { this.showToast('Editar asignatura ' + id, 'info'); },
            eliminarAsignatura(id) { 
                if (confirm('¬øEliminar asignatura?')) {
                    this.data.asignaturas = this.data.asignaturas.filter(a => a.id !== id);
                    this.renderAsignaturas();
                    this.showToast('Asignatura eliminada', 'success');
                }
            },
            editarEstudiante(id) {
                const est = this.data.estudiantes.find(e => e.id === id);
                if (est) {
                    this.data.current.editingId = id;
                    document.getElementById('estId').value = est.idSEA;
                    document.getElementById('estNombre').value = est.nombre;
                    document.getElementById('estEncargado1').value = est.encargado1;
                    document.getElementById('estTel1').value = est.tel1;
                    document.getElementById('estEncargado2').value = est.encargado2;
                    document.getElementById('estTel2').value = est.tel2;
                    document.getElementById('estCumple').value = est.cumple;
                    document.getElementById('estAdecuacion').value = est.adecuacion;
                    
                    const campoACS = document.getElementById('campoDetalleACS');
                    if (est.adecuacion === 'acs') {
                        campoACS.style.display = 'block';
                        document.getElementById('estDetalleACS').value = est.detalleACS || '';
                    } else {
                        campoACS.style.display = 'none';
                    }
                    
                    this.cambiarTabEstudiantes('agregar', document.querySelector('#modalEstudiantes .tab:nth-child(2)'));
                }
            },
            eliminarEstudiante(id) {
                if (confirm('¬øEliminar estudiante?')) {
                    this.data.estudiantes = this.data.estudiantes.filter(e => e.id !== id);
                    this.renderEstudiantesModal();
                    this.renderDashboard();
                    this.showToast('Estudiante eliminado', 'success');
                }
            },
            contactarWhatsApp(tel) {
                if (!tel) {
                    this.showToast('No hay tel√©fono registrado', 'warning');
                    return;
                }
                const numeroLimpio = tel.replace(/\D/g, '');
                window.open(`https://wa.me/506${numeroLimpio}`, '_blank');
            },
            limpiarFormEstudiante() {
                document.getElementById('estId').value = '';
                document.getElementById('estNombre').value = '';
                document.getElementById('estEncargado1').value = '';
                document.getElementById('estTel1').value = '';
                document.getElementById('estEncargado2').value = '';
                document.getElementById('estTel2').value = '';
                document.getElementById('estCumple').value = '';
                document.getElementById('estAdecuacion').value = 'ninguna';
                document.getElementById('estDetalleACS').value = '';
                document.getElementById('campoDetalleACS').style.display = 'none';
            },
            editarBitacora(id) { this.showToast('Editar bit√°cora ' + id, 'info'); },
            eliminarBitacora(id) {
                if (confirm('¬øEliminar bit√°cora?')) {
                    this.data.bitacoras = this.data.bitacoras.filter(b => b.id !== id);
                    this.renderBitacora();
                    this.showToast('Bit√°cora eliminada', 'success');
                }
            },
            editarLeccionHorario(id) { this.showToast('Editar lecci√≥n: ' + id, 'info'); },
            guardarConfigHorario() {
                this.data.config.maxLecciones = parseInt(document.getElementById('configMaxLecciones').value) || 7;
                this.data.config.unidocente = document.getElementById('configUnidocente').checked;
                this.closeModal('configHorario');
                this.renderHorario();
                this.showToast('Configuraci√≥n guardada', 'success');
            }
        };

        // Iniciar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
