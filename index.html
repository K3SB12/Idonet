<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral Gesti√≥n Docente ¬∑ MEP</title>
    <style>
        /* ===== SISTEMA DE DISE√ëO INSTITUCIONAL MEP ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }

        :root {
            /* Paleta institucional MEP */
            --mep-verde-profundo: #0B3B2F;
            --mep-verde-claro: #A7C1B0;
            --mep-gris-fondo: #F4F7F5;
            --mep-texto-oscuro: #1E2B28;
            --mep-borde: #C0CFC5;
            --mep-sombra: rgba(11, 59, 47, 0.12);
            --mep-alerta: #D32F2F;
            --mep-exito: #2E7D32;
            --mep-advertencia: #ED6C02;
            
            /* Modo claro (default) */
            --bg-primary: var(--mep-gris-fondo);
            --bg-sidebar: var(--mep-verde-profundo);
            --text-primary: var(--mep-texto-oscuro);
            --text-sidebar: #FFFFFF;
            --card-bg: #FFFFFF;
            --border-color: var(--mep-borde);
            --button-primary: var(--mep-verde-profundo);
            --button-secondary: var(--mep-verde-claro);
            --hover-overlay: rgba(255, 255, 255, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1A2A24;
                --bg-sidebar: #0F2A20;
                --text-primary: #E0EDE7;
                --text-sidebar: #FFFFFF;
                --card-bg: #26362F;
                --border-color: #3D5E51;
                --button-primary: #1F5E4F;
                --button-secondary: #3D5E51;
                --hover-overlay: rgba(255, 255, 255, 0.15);
            }
        }

        body {
            display: flex;
            min-height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* ===== BARRA LATERAL FIJA ===== */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            color: var(--text-sidebar);
            padding: 2rem 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px var(--mep-sombra);
            z-index: 100;
        }

        .sidebar-header {
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--mep-verde-claro);
            margin-bottom: 1.5rem;
        }

        .sidebar-header h1 {
            font-size: 1.4rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
            display: block;
            margin-top: 0.5rem;
        }

        .nav-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-sidebar);
            padding: 1rem 1.2rem;
            text-align: left;
            font-size: 1rem;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 4px solid transparent;
        }

        .nav-btn:hover {
            background: var(--hover-overlay);
        }

        .nav-btn.active {
            background: var(--bg-primary);
            color: var(--mep-verde-profundo);
            border-left: 4px solid var(--mep-verde-claro);
            font-weight: 600;
            box-shadow: -4px 0 10px rgba(0,0,0,0.05);
        }

        .dark .nav-btn.active {
            color: var(--text-sidebar);
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        /* ===== PESTA√ëAS ===== */
        .pestana {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .pestana.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== COMPONENTES UI ===== */
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 8px 24px var(--mep-sombra);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--mep-verde-claro);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--mep-verde-profundo);
        }

        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        input, select, textarea {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 0.8rem 1.2rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--mep-verde-profundo);
            box-shadow: 0 0 0 3px rgba(11, 59, 47, 0.1);
        }

        .btn {
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 0.8rem 2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            border: 1px solid transparent;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: var(--button-secondary);
            color: var(--mep-texto-oscuro);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 0.5rem 1.2rem;
            font-size: 0.85rem;
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        /* ===== TABLAS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th {
            background: var(--mep-verde-claro);
            color: var(--mep-texto-oscuro);
            font-weight: 600;
            padding: 1rem;
            text-align: left;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* ===== BADGES Y ALERTAS ===== */
        .badge {
            display: inline-block;
            padding: 0.25rem 1rem;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--mep-exito);
            color: white;
        }

        .badge-warning {
            background: var(--mep-advertencia);
            color: white;
        }

        .badge-error {
            background: var(--mep-alerta);
            color: white;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border-left: 6px solid;
        }

        .alert-warning {
            background: rgba(237, 108, 2, 0.1);
            border-left-color: var(--mep-advertencia);
        }

        .alert-success {
            background: rgba(46, 125, 80, 0.1);
            border-left-color: var(--mep-exito);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1rem;
            }
            
            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav-btn {
                border-radius: 12px;
            }
            
            .nav-btn.active {
                border-left: 4px solid var(--mep-verde-claro);
            }
        }

        /* ===== UTILIDADES ===== */
        .text-center { text-align: center; }
        .mt-4 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 1rem; }
        .w-100 { width: 100%; }
        .d-flex { display: flex; }
        .gap-2 { gap: 1rem; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
    </style>
</head>
<body>
    <!-- BARRA LATERAL FIJA -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>Sistema Integral<br>Gesti√≥n Docente</h1>
            <small>Ministerio de Educaci√≥n P√∫blica ¬∑ Costa Rica</small>
        </div>
        <nav>
            <button class="nav-btn active" data-pestana="config">
                <span>‚öôÔ∏è</span> 1. CONFIGURACI√ìN
            </button>
            <button class="nav-btn" data-pestana="grupos">
                <span>üë•</span> 2. GRUPOS Y ESTUDIANTES
            </button>
            <button class="nav-btn" data-pestana="componentes">
                <span>üìä</span> 3. COMPONENTES
            </button>
            <button class="nav-btn" data-pestana="instrumentos">
                <span>üìã</span> 4. INSTRUMENTOS
            </button>
            <button class="nav-btn" data-pestana="asistencia">
                <span>üìÜ</span> 5. ASISTENCIA
            </button>
            <button class="nav-btn" data-pestana="bitacora">
                <span>üìì</span> 6. BIT√ÅCORA
            </button>
            <button class="nav-btn" data-pestana="reportes">
                <span>üìà</span> 7. REPORTES
            </button>
            <button class="nav-btn" data-pestana="acta">
                <span>üìú</span> 8. ACTA FINAL
            </button>
            <button class="nav-btn" data-pestana="respaldo">
                <span>üíæ</span> 9. RESPALDO
            </button>
        </nav>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
        <!-- PESTA√ëA 1: CONFIGURACI√ìN GENERAL -->
        <section id="pestana-config" class="pestana active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Configuraci√≥n General MEP</h2>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Centro Educativo</label>
                        <input type="text" id="centro-nombre" placeholder="Ej: Liceo de Costa Rica">
                    </div>
                    <div class="form-group">
                        <label>Modalidad</label>
                        <select id="centro-modalidad">
                            <option value="Primaria">Primaria</option>
                            <option value="Secundaria" selected>Secundaria</option>
                            <option value="Preescolar">Preescolar</option>
                        </select>
                    </div>
                </div>

                <div class="grid-3 mt-4">
                    <div class="form-group">
                        <label>Periodo activo</label>
                        <select id="periodo-activo">
                            <option value="I">I Periodo</option>
                            <option value="II">II Periodo</option>
                            <option value="III">III Periodo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>A√±o lectivo</label>
                        <input type="number" id="anio-lectivo" value="2025" min="2020" max="2030">
                    </div>
                </div>

                <h3 class="mt-4 mb-2">üìä Porcentajes de evaluaci√≥n</h3>
                <div class="grid-4">
                    <div class="form-group">
                        <label>Trabajo cotidiano (%)</label>
                        <input type="number" id="porc-tc" value="30" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>Proyecto (%)</label>
                        <input type="number" id="porc-proy" value="20" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>Prueba (%)</label>
                        <input type="number" id="porc-prueba" value="30" min="0" max="100" step="1">
                    </div>
                    <div class="form-group">
                        <label>Tareas (%)</label>
                        <input type="number" id="porc-tareas" value="20" min="0" max="100" step="1">
                    </div>
                </div>

                <div class="d-flex align-center gap-2 mt-4">
                    <span class="badge" id="suma-porcentajes">Suma: 100% ‚úÖ</span>
                    <span id="validacion-porcentajes" class="badge badge-success">V√°lido</span>
                </div>

                <div class="toolbar">
                    <button class="btn" id="guardar-configuracion">üíæ Guardar configuraci√≥n</button>
                    <button class="btn btn-secondary" id="cargar-configuracion">üìÇ Cargar configuraci√≥n</button>
                    <button class="btn btn-outline" id="restablecer-sistema">‚ö†Ô∏è Restablecer sistema</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üè´ Centros educativos registrados</h3>
                </div>
                <div class="table-container">
                    <table id="tabla-centros">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Modalidad</th>
                                <th>Periodo activo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="centros-list">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 2: GRUPOS Y ESTUDIANTES -->
        <section id="pestana-grupos" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Gesti√≥n de Grupos y Estudiantes</h2>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Nuevo grupo</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="nuevo-grupo" placeholder="Ej: 7-1, 2B, 5A">
                            <button class="btn btn-small" id="btn-agregar-grupo">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Seleccionar grupo</label>
                        <select id="selector-grupo">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-secondary" id="importar-csv-estudiantes">üì§ Importar CSV</button>
                    <button class="btn btn-secondary" id="exportar-csv-estudiantes">üì• Exportar CSV</button>
                    <button class="btn" id="agregar-estudiante">‚ûï Nuevo estudiante</button>
                </div>

                <div class="table-container mt-4">
                    <table id="tabla-estudiantes">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre completo</th>
                                <th>Identificaci√≥n</th>
                                <th>Tel√©fono</th>
                                <th>Correo</th>
                                <th>ACS</th>
                                <th>Adec. no sign.</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="estudiantes-list">
                            <!-- Datos din√°micos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 3: REGISTRO DE COMPONENTES -->
        <section id="pestana-componentes" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìä Registro de Componentes y Calificaciones</h2>
                </div>

                <div class="grid-3">
                    <div class="form-group">
                        <label>Grupo</label>
                        <select id="comp-grupo">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estudiante</label>
                        <select id="comp-estudiante">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Periodo</label>
                        <select id="comp-periodo">
                            <option value="I">I Periodo</option>
                            <option value="II">II Periodo</option>
                            <option value="III">III Periodo</option>
                        </select>
                    </div>
                </div>

                <div class="grid-4 mt-4">
                    <div class="form-group">
                        <label>Trabajo cotidiano</label>
                        <input type="number" id="nota-tc" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Proyecto</label>
                        <input type="number" id="nota-proy" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Prueba</label>
                        <input type="number" id="nota-prueba" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Tareas</label>
                        <input type="number" id="nota-tareas" step="0.1" min="0" max="100">
                    </div>
                </div>

                <div class="grid-2 mt-4">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="comp-acs"> Estudiante con ACS
                        </label>
                    </div>
                    <div class="form-group">
                        <label>F√≥rmula ACS personalizada</label>
                        <input type="text" id="formula-acs" value="tc*0.25 + proy*0.25 + prueba*0.25 + tareas*0.25">
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn" id="calcular-promedio">üßÆ Calcular promedio</button>
                    <button class="btn btn-secondary" id="guardar-calificaciones">üíæ Guardar calificaciones</button>
                </div>

                <div class="card mt-4" id="resultado-calculo" style="display: none;">
                    <h3>Resultado del c√°lculo</h3>
                    <p id="promedio-calculado"></p>
                    <p id="estado-calculo"></p>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 4: INSTRUMENTOS -->
        <section id="pestana-instrumentos" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Instrumentos de Evaluaci√≥n</h2>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Tipo de instrumento</label>
                        <select id="instrumento-tipo">
                            <option value="lista_cotejo">Lista de cotejo</option>
                            <option value="rubrica">R√∫brica anal√≠tica</option>
                            <option value="escala">Escala de desempe√±o</option>
                            <option value="prueba">Prueba estructurada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nombre del instrumento</label>
                        <input type="text" id="instrumento-nombre">
                    </div>
                </div>

                <div class="form-group">
                    <label>¬øPara estudiantes con ACS?</label>
                    <input type="checkbox" id="instrumento-acs">
                </div>

                <div id="indicadores-container">
                    <h3>Indicadores</h3>
                    <div id="indicadores-list"></div>
                    <button class="btn btn-secondary btn-small mt-2" id="agregar-indicador">‚ûï Agregar indicador</button>
                </div>

                <div class="toolbar mt-4">
                    <button class="btn" id="guardar-instrumento">üíæ Guardar plantilla</button>
                    <button class="btn btn-secondary" id="duplicar-instrumento">üìë Duplicar</button>
                    <button class="btn btn-secondary" id="asignar-grupo">üë• Asignar a grupo</button>
                </div>

                <div class="table-container mt-4">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>ACS</th>
                                <th>Indicadores</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="instrumentos-list"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 5: ASISTENCIA -->
        <section id="pestana-asistencia" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìÜ Control de Asistencia</h2>
                </div>

                <div class="grid-3">
                    <div class="form-group">
                        <label>Grupo</label>
                        <select id="asis-grupo"></select>
                    </div>
                    <div class="form-group">
                        <label>Mes</label>
                        <select id="asis-mes">
                            <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                            <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                            <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Setiembre</option>
                            <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>A√±o</label>
                        <input type="number" id="asis-anio" value="2025">
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-secondary" id="marcar-presente">‚úÖ P (Presente)</button>
                    <button class="btn btn-secondary" id="marcar-ausente">‚ùå A (Ausente)</button>
                    <button class="btn btn-secondary" id="marcar-justificada">üìù J (Justificada)</button>
                    <button class="btn btn-secondary" id="marcar-tardia">‚è∞ T (Tard√≠a)</button>
                </div>

                <div class="table-container mt-4">
                    <table id="tabla-asistencia">
                        <thead>
                            <tr>
                                <th>Estudiante</th>
                                <th>Estado</th>
                                <th>% Asistencia</th>
                            </tr>
                        </thead>
                        <tbody id="asistencia-list"></tbody>
                    </table>
                </div>

                <div class="toolbar mt-4">
                    <button class="btn" id="reporte-ausentismo">üìä Generar reporte ausentismo</button>
                    <button class="btn btn-secondary" id="exportar-asistencia-pdf">PDF</button>
                    <button class="btn btn-secondary" id="exportar-asistencia-csv">CSV</button>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 6: BIT√ÅCORA DOCENTE -->
        <section id="pestana-bitacora" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìì Bit√°cora Docente (DUA)</h2>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="bitacora-fecha">
                    </div>
                    <div class="form-group">
                        <label>Tema</label>
                        <input type="text" id="bitacora-tema">
                    </div>
                </div>

                <div class="form-group">
                    <label>Actividad</label>
                    <textarea id="bitacora-actividad" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="bitacora-observaciones" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Ajustes DUA</label>
                    <textarea id="bitacora-dua" rows="2" placeholder="Ej: Adaptaciones, materiales, apoyos..."></textarea>
                </div>

                <div class="toolbar">
                    <button class="btn" id="agregar-bitacora">‚ûï Agregar registro</button>
                    <button class="btn btn-secondary" id="exportar-bitacora-word">üì• Word</button>
                    <button class="btn btn-secondary" id="exportar-bitacora-pdf">üì• PDF</button>
                </div>

                <div class="table-container mt-4">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tema</th>
                                <th>Actividad</th>
                                <th>Observaciones</th>
                                <th>Ajustes DUA</th>
                            </tr>
                        </thead>
                        <tbody id="bitacora-list"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PESTA√ëA 7: REPORTES POR PERIODO -->
        <section id="pestana-reportes" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìà Reportes Acad√©micos por Periodo</h2>
                </div>

                <div class="grid-3">
                    <div class="form-group">
                        <label>Grupo</label>
                        <select id="reporte-grupo"></select>
                    </div>
                    <div class="form-group">
                        <label>Periodo</label>
                        <select id="reporte-periodo">
                            <option value="I">I Periodo</option>
                            <option value="II">II Periodo</option>
                            <option value="III">III Periodo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>A√±o</label>
                        <input type="number" id="reporte-anio" value="2025">
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn" id="generar-reporte">üìä Generar reporte</button>
                    <button class="btn btn-secondary" id="exportar-reporte-pdf">PDF</button>
                    <button class="btn btn-secondary" id="exportar-reporte-word">Word</button>
                    <button class="btn btn-secondary" id="exportar-reporte-csv">CSV</button>
                </div>

                <div id="reporte-contenido" class="mt-4"></div>
            </div>
        </section>

        <!-- PESTA√ëA 8: ACTA FINAL -->
        <section id="pestana-acta" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìú Acta Final de Evaluaci√≥n</h2>
                </div>

                <div class="grid-3">
                    <div class="form-group">
                        <label>Grupo</label>
                        <select id="acta-grupo"></select>
                    </div>
                    <div class="form-group">
                        <label>A√±o lectivo</label>
                        <input type="number" id="acta-anio" value="2025">
                    </div>
                </div>

                <div class="alert alert-warning" id="acta-validacion"></div>

                <div class="toolbar">
                    <button class="btn" id="consolidar-acta">üìã Consolidar acta</button>
                    <button class="btn btn-secondary" id="exportar-acta-pdf">PDF</button>
                    <button class="btn btn-secondary" id="exportar-acta-word">Word</button>
                </div>

                <div id="acta-contenido" class="mt-4"></div>
            </div>
        </section>

        <!-- PESTA√ëA 9: RESPALDO GLOBAL -->
        <section id="pestana-respaldo" class="pestana">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üíæ Respaldo y Exportaci√≥n Global</h2>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>Exportar datos</h3>
                        <div class="toolbar">
                            <button class="btn w-100" id="exportar-json">üì¶ Exportar todo (JSON)</button>
                            <button class="btn btn-secondary w-100" id="exportar-masivo-csv">üì§ Exportaci√≥n masiva CSV</button>
                            <button class="btn btn-secondary w-100" id="generar-copia-seguridad">üíø Generar copia seguridad</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Importar respaldo</h3>
                        <div class="form-group">
                            <label>Seleccionar archivo JSON</label>
                            <input type="file" id="importar-json" accept=".json">
                        </div>
                        <button class="btn w-100" id="restaurar-respaldo">üîÑ Restaurar sistema</button>
                    </div>
                </div>

                <div class="card mt-4">
                    <h3>üìä Diagn√≥stico del sistema</h3>
                    <button class="btn btn-secondary" id="ejecutar-diagnostico">üîç Ejecutar diagn√≥stico completo</button>
                    <div id="diagnostico-resultado" class="mt-4"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // =========================================================================
        // SISTEMA INTEGRAL DE GESTI√ìN DOCENTE MEP - ARQUITECTURA POR CAPAS
        // VERSI√ìN 2.0 - COMPLETAMENTE FUNCIONAL
        // =========================================================================

        (function() {
            "use strict";

            // =========================================================================
            // CAPA 3: MODELO DE DATOS (CORE)
            // =========================================================================
            const ModeloMEP = {
                version: "2.0",
                centros: [],
                configuraciones: [],
                grupos: [],
                estudiantes: [],
                calificaciones: [],
                instrumentos: [],
                asistencia: [],
                bitacora: [],
                periodos: [],
                respaldos: []
            };

            // =========================================================================
            // CAPA 3: REPOSITORIO (PERSISTENCIA)
            // =========================================================================
            const Repositorio = {
                // Claves de localStorage
                KEYS: {
                    CENTROS: 'mep_centros_v2',
                    CONFIG: 'mep_config_v2',
                    GRUPOS: 'mep_grupos_v2',
                    ESTUDIANTES: 'mep_estudiantes_v2',
                    CALIFICACIONES: 'mep_calificaciones_v2',
                    INSTRUMENTOS: 'mep_instrumentos_v2',
                    ASISTENCIA: 'mep_asistencia_v2',
                    BITACORA: 'mep_bitacora_v2',
                    PERIODOS: 'mep_periodos_v2'
                },

                // Cargar todo desde localStorage
                cargarTodo: function() {
                    try {
                        ModeloMEP.centros = JSON.parse(localStorage.getItem(this.KEYS.CENTROS)) || [];
                        ModeloMEP.configuraciones = JSON.parse(localStorage.getItem(this.KEYS.CONFIG)) || [];
                        ModeloMEP.grupos = JSON.parse(localStorage.getItem(this.KEYS.GRUPOS)) || [];
                        ModeloMEP.estudiantes = JSON.parse(localStorage.getItem(this.KEYS.ESTUDIANTES)) || [];
                        ModeloMEP.calificaciones = JSON.parse(localStorage.getItem(this.KEYS.CALIFICACIONES)) || [];
                        ModeloMEP.instrumentos = JSON.parse(localStorage.getItem(this.KEYS.INSTRUMENTOS)) || [];
                        ModeloMEP.asistencia = JSON.parse(localStorage.getItem(this.KEYS.ASISTENCIA)) || [];
                        ModeloMEP.bitacora = JSON.parse(localStorage.getItem(this.KEYS.BITACORA)) || [];
                        ModeloMEP.periodos = JSON.parse(localStorage.getItem(this.KEYS.PERIODOS)) || [];

                        // Datos iniciales si est√° vac√≠o
                        if (ModeloMEP.centros.length === 0) {
                            this.inicializarDatosDemo();
                        }
                    } catch (e) {
                        console.error("Error cargando datos:", e);
                        this.inicializarDatosDemo();
                    }
                },

                inicializarDatosDemo: function() {
                    const centroId = this.generarId();
                    ModeloMEP.centros = [{
                        id: centroId,
                        nombre: "Liceo Experimental",
                        modalidad: "Secundaria",
                        codigo: "MEP-001",
                        activo: true
                    }];

                    ModeloMEP.configuraciones = [{
                        id: this.generarId(),
                        centroId: centroId,
                        periodo: "I",
                        a√±o: 2025,
                        porcentajes: {
                            trabajoCotidiano: 30,
                            proyecto: 20,
                            prueba: 30,
                            tareas: 20
                        },
                        formulaACS: "tc*0.25 + proy*0.25 + prueba*0.25 + tareas*0.25",
                        activo: true
                    }];

                    ModeloMEP.grupos = [{
                        id: this.generarId(),
                        centroId: centroId,
                        nombre: "7-1",
                        nivel: "S√©timo",
                        a√±o: 2025,
                        periodoActivo: "I"
                    }];

                    ModeloMEP.periodos = [
                        { id: this.generarId(), centroId: centroId, a√±o: 2025, periodo: "I", estado: "abierto", validado: false },
                        { id: this.generarId(), centroId: centroId, a√±o: 2025, periodo: "II", estado: "pendiente", validado: false },
                        { id: this.generarId(), centroId: centroId, a√±o: 2025, periodo: "III", estado: "pendiente", validado: false }
                    ];

                    this.guardarTodo();
                },

                guardarTodo: function() {
                    localStorage.setItem(this.KEYS.CENTROS, JSON.stringify(ModeloMEP.centros));
                    localStorage.setItem(this.KEYS.CONFIG, JSON.stringify(ModeloMEP.configuraciones));
                    localStorage.setItem(this.KEYS.GRUPOS, JSON.stringify(ModeloMEP.grupos));
                    localStorage.setItem(this.KEYS.ESTUDIANTES, JSON.stringify(ModeloMEP.estudiantes));
                    localStorage.setItem(this.KEYS.CALIFICACIONES, JSON.stringify(ModeloMEP.calificaciones));
                    localStorage.setItem(this.KEYS.INSTRUMENTOS, JSON.stringify(ModeloMEP.instrumentos));
                    localStorage.setItem(this.KEYS.ASISTENCIA, JSON.stringify(ModeloMEP.asistencia));
                    localStorage.setItem(this.KEYS.BITACORA, JSON.stringify(ModeloMEP.bitacora));
                    localStorage.setItem(this.KEYS.PERIODOS, JSON.stringify(ModeloMEP.periodos));
                },

                generarId: function() {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2);
                },

                // M√©todos espec√≠ficos
                getConfiguracionActiva: function(centroId, periodo, a√±o) {
                    return ModeloMEP.configuraciones.find(c => 
                        c.centroId === centroId && 
                        c.periodo === periodo && 
                        c.a√±o === a√±o &&
                        c.activo === true
                    );
                },

                getEstudiantesPorGrupo: function(grupoId) {
                    return ModeloMEP.estudiantes.filter(e => e.grupoId === grupoId && e.activo !== false);
                },

                getCalificacionEstudiante: function(estudianteId, periodo, a√±o) {
                    return ModeloMEP.calificaciones.find(c => 
                        c.estudianteId === estudianteId && 
                        c.periodo === periodo && 
                        c.a√±o === a√±o
                    );
                },

                guardarCalificacion: function(calificacion) {
                    const index = ModeloMEP.calificaciones.findIndex(c => c.id === calificacion.id);
                    if (index >= 0) {
                        ModeloMEP.calificaciones[index] = calificacion;
                    } else {
                        ModeloMEP.calificaciones.push(calificacion);
                    }
                    this.guardarTodo();
                }
            };

            // =========================================================================
            // CAPA 2: MOTOR DE C√ÅLCULO (REGLAS MEP)
            // =========================================================================
            const MotorCalculo = {
                validarPorcentajes: function(tc, proy, pru, tar) {
                    const suma = (tc || 0) + (proy || 0) + (pru || 0) + (tar || 0);
                    return suma === 100 && 
                           tc >= 0 && tc <= 100 &&
                           proy >= 0 && proy <= 100 &&
                           pru >= 0 && pru <= 100 &&
                           tar >= 0 && tar <= 100;
                },

                calcularPromedioEstandar: function(notas, porcentajes) {
                    const { trabajoCotidiano, proyecto, prueba, tareas } = notas;
                    const { trabajoCotidiano: pTC, proyecto: pProy, prueba: pPru, tareas: pTar } = porcentajes;
                    
                    if ([trabajoCotidiano, proyecto, prueba, tareas].some(n => n === null || n === undefined || n === '')) {
                        throw new Error("Notas incompletas");
                    }

                    return (
                        (parseFloat(trabajoCotidiano) * pTC / 100) +
                        (parseFloat(proyecto) * pProy / 100) +
                        (parseFloat(prueba) * pPru / 100) +
                        (parseFloat(tareas) * pTar / 100)
                    ).toFixed(2);
                },

                calcularPromedioACS: function(notas, formula) {
                    const tc = parseFloat(notas.trabajoCotidiano) || 0;
                    const proy = parseFloat(notas.proyecto) || 0;
                    const prueba = parseFloat(notas.prueba) || 0;
                    const tareas = parseFloat(notas.tareas) || 0;

                    // Sanitizar f√≥rmula (solo caracteres seguros)
                    const formulaLimpia = formula.replace(/[^0-9\s\+\-\*\/\(\)\.tcproypruebatareas]/g, '');
                    
                    try {
                        // Evaluar de forma segura
                        const resultado = eval(formulaLimpia);
                        return resultado.toFixed(2);
                    } catch (e) {
                        console.error("Error evaluando f√≥rmula ACS:", e);
                        return null;
                    }
                },

                determinarEstado: function(promedio) {
                    const prom = parseFloat(promedio);
                    if (prom >= 65) return "APROBADO";
                    if (prom >= 50) return "CONVOCATORIA";
                    return "REPROBADO";
                },

                validarPeriodoCompleto: function(grupoId, periodo, a√±o) {
                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const calificaciones = ModeloMEP.calificaciones.filter(c => 
                        c.periodo === periodo && c.a√±o === a√±o
                    );

                    for (let estudiante of estudiantes) {
                        const cal = calificaciones.find(c => c.estudianteId === estudiante.id);
                        if (!cal) return false;
                        
                        const notas = cal.notas;
                        if (notas.trabajoCotidiano === null || 
                            notas.proyecto === null || 
                            notas.prueba === null || 
                            notas.tareas === null) {
                            return false;
                        }
                    }
                    return true;
                }
            };

            // =========================================================================
            // CAPA 2: VALIDADOR
            // =========================================================================
            const Validador = {
                email: function(email) {
                    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return regex.test(email);
                },

                telefono: function(tel) {
                    const regex = /^[0-9+\-\s]{8,}$/;
                    return regex.test(tel);
                },

                duplicadoEstudiante: function(identificacion, grupoId, excludeId = null) {
                    return ModeloMEP.estudiantes.some(e => 
                        e.identificacion === identificacion && 
                        e.grupoId === grupoId &&
                        e.id !== excludeId &&
                        e.activo !== false
                    );
                },

                antesDeCerrarPeriodo: function(grupoId, periodo, a√±o) {
                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const sinCalificar = [];

                    for (let est of estudiantes) {
                        const cal = ModeloMEP.calificaciones.find(c => 
                            c.estudianteId === est.id && 
                            c.periodo === periodo && 
                            c.a√±o === a√±o
                        );

                        if (!cal) {
                            sinCalificar.push(est);
                            continue;
                        }

                        const notas = cal.notas;
                        if (notas.trabajoCotidiano === null || 
                            notas.proyecto === null || 
                            notas.prueba === null || 
                            notas.tareas === null) {
                            sinCalificar.push(est);
                        }
                    }

                    return {
                        valido: sinCalificar.length === 0,
                        estudiantesPendientes: sinCalificar,
                        mensaje: sinCalificar.length === 0 
                            ? "‚úÖ Periodo listo para cerrar" 
                            : `‚ö†Ô∏è ${sinCalificar.length} estudiante(s) sin calificar`
                    };
                },

                integridadReferencial: function() {
                    const errores = [];

                    // Validar estudiantes con grupos existentes
                    ModeloMEP.estudiantes.forEach(est => {
                        if (!ModeloMEP.grupos.some(g => g.id === est.grupoId)) {
                            errores.push(`Estudiante ${est.nombreCompleto} (${est.id}) tiene grupo inexistente`);
                        }
                    });

                    // Validar calificaciones con estudiantes existentes
                    ModeloMEP.calificaciones.forEach(cal => {
                        if (!ModeloMEP.estudiantes.some(e => e.id === cal.estudianteId)) {
                            errores.push(`Calificaci√≥n ${cal.id} referenciando estudiante inexistente`);
                        }
                    });

                    return errores;
                }
            };

            // =========================================================================
            // CAPA 1: CONTROLADOR DE UI Y RENDERIZADO
            // =========================================================================
            const UI = {
                // Inicializaci√≥n
                init: function() {
                    this.cargarDatos();
                    this.configurarNavegacion();
                    this.configurarEventos();
                    this.actualizarSelectores();
                    this.renderizarTodo();
                    this.actualizarSumaPorcentajes();
                },

                cargarDatos: function() {
                    Repositorio.cargarTodo();
                },

                configurarNavegacion: function() {
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            
                            document.querySelectorAll('.pestana').forEach(p => p.classList.remove('active'));
                            document.getElementById(`pestana-${btn.dataset.pestana}`).classList.add('active');
                        });
                    });
                },

                configurarEventos: function() {
                    // Eventos de configuraci√≥n
                    document.getElementById('guardar-configuracion').addEventListener('click', () => this.guardarConfiguracion());
                    document.getElementById('cargar-configuracion').addEventListener('click', () => this.cargarConfiguracion());
                    document.getElementById('restablecer-sistema').addEventListener('click', () => this.restablecerSistema());
                    
                    ['porc-tc', 'porc-proy', 'porc-prueba', 'porc-tareas'].forEach(id => {
                        document.getElementById(id).addEventListener('input', () => this.actualizarSumaPorcentajes());
                    });

                    // Grupos y estudiantes
                    document.getElementById('btn-agregar-grupo').addEventListener('click', () => this.agregarGrupo());
                    document.getElementById('selector-grupo').addEventListener('change', () => this.renderizarEstudiantes());
                    document.getElementById('agregar-estudiante').addEventListener('click', () => this.agregarEstudiante());
                    document.getElementById('exportar-csv-estudiantes').addEventListener('click', () => this.exportarEstudiantesCSV());
                    document.getElementById('importar-csv-estudiantes').addEventListener('click', () => this.importarEstudiantesCSV());

                    // Componentes
                    document.getElementById('comp-grupo').addEventListener('change', () => this.actualizarSelectEstudiantes());
                    document.getElementById('calcular-promedio').addEventListener('click', () => this.calcularPromedio());
                    document.getElementById('guardar-calificaciones').addEventListener('click', () => this.guardarCalificaciones());

                    // Bit√°cora
                    document.getElementById('agregar-bitacora').addEventListener('click', () => this.agregarBitacora());

                    // Diagn√≥stico
                    document.getElementById('ejecutar-diagnostico').addEventListener('click', () => this.ejecutarDiagnostico());

                    // Respaldos
                    document.getElementById('exportar-json').addEventListener('click', () => this.exportarJSON());
                    document.getElementById('restaurar-respaldo').addEventListener('click', () => this.restaurarRespaldo());

                    // Acta final
                    document.getElementById('consolidar-acta').addEventListener('click', () => this.consolidarActa());

                    // Reportes
                    document.getElementById('generar-reporte').addEventListener('click', () => this.generarReporte());
                },

                actualizarSumaPorcentajes: function() {
                    const tc = parseInt(document.getElementById('porc-tc').value) || 0;
                    const proy = parseInt(document.getElementById('porc-proy').value) || 0;
                    const pru = parseInt(document.getElementById('porc-prueba').value) || 0;
                    const tar = parseInt(document.getElementById('porc-tareas').value) || 0;
                    
                    const suma = tc + proy + pru + tar;
                    const span = document.getElementById('suma-porcentajes');
                    const validacion = document.getElementById('validacion-porcentajes');
                    
                    span.textContent = `Suma: ${suma}% ${suma === 100 ? '‚úÖ' : '‚ùå'}`;
                    
                    if (suma === 100) {
                        validacion.textContent = 'V√°lido';
                        validacion.className = 'badge badge-success';
                    } else {
                        validacion.textContent = 'Debe sumar 100%';
                        validacion.className = 'badge badge-error';
                    }
                },

                guardarConfiguracion: function() {
                    const tc = parseInt(document.getElementById('porc-tc').value);
                    const proy = parseInt(document.getElementById('porc-proy').value);
                    const pru = parseInt(document.getElementById('porc-prueba').value);
                    const tar = parseInt(document.getElementById('porc-tareas').value);

                    if (!MotorCalculo.validarPorcentajes(tc, proy, pru, tar)) {
                        alert('‚ùå Los porcentajes deben sumar exactamente 100%');
                        return;
                    }

                    const config = {
                        id: Repositorio.generarId(),
                        centroId: ModeloMEP.centros[0]?.id || 'temp',
                        periodo: document.getElementById('periodo-activo').value,
                        a√±o: parseInt(document.getElementById('anio-lectivo').value),
                        porcentajes: {
                            trabajoCotidiano: tc,
                            proyecto: proy,
                            prueba: pru,
                            tareas: tar
                        },
                        formulaACS: document.getElementById('formula-acs')?.value || "tc*0.25+proy*0.25+prueba*0.25+tareas*0.25",
                        activo: true
                    };

                    ModeloMEP.configuraciones.push(config);
                    Repositorio.guardarTodo();
                    alert('‚úÖ Configuraci√≥n guardada exitosamente');
                },

                cargarConfiguracion: function() {
                    const config = ModeloMEP.configuraciones[ModeloMEP.configuraciones.length - 1];
                    if (config) {
                        document.getElementById('porc-tc').value = config.porcentajes.trabajoCotidiano;
                        document.getElementById('porc-proy').value = config.porcentajes.proyecto;
                        document.getElementById('porc-prueba').value = config.porcentajes.prueba;
                        document.getElementById('porc-tareas').value = config.porcentajes.tareas;
                        document.getElementById('periodo-activo').value = config.periodo;
                        this.actualizarSumaPorcentajes();
                    }
                },

                restablecerSistema: function() {
                    if (confirm('‚ö†Ô∏è ¬øEst√° seguro de restablecer todo el sistema? Se perder√°n todos los datos.')) {
                        localStorage.clear();
                        location.reload();
                    }
                },

                actualizarSelectores: function() {
                    // Grupos
                    const selectores = ['selector-grupo', 'comp-grupo', 'asis-grupo', 'reporte-grupo', 'acta-grupo'];
                    selectores.forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = '<option value="">-- Seleccione --</option>';
                            ModeloMEP.grupos.forEach(grupo => {
                                select.innerHTML += `<option value="${grupo.id}">${grupo.nombre}</option>`;
                            });
                        }
                    });
                },

                renderizarTodo: function() {
                    this.renderizarCentros();
                    this.renderizarEstudiantes();
                    this.renderizarBitacora();
                    this.renderizarInstrumentos();
                },

                renderizarCentros: function() {
                    const tbody = document.getElementById('centros-list');
                    if (!tbody) return;

                    tbody.innerHTML = ModeloMEP.centros.map(centro => `
                        <tr>
                            <td>${centro.nombre}</td>
                            <td>${centro.modalidad}</td>
                            <td>${ModeloMEP.periodos.find(p => p.centroId === centro.id && p.estado === 'abierto')?.periodo || 'Ninguno'}</td>
                            <td>
                                <button class="btn btn-small btn-secondary" onclick="UI.seleccionarCentro('${centro.id}')">Seleccionar</button>
                            </td>
                        </tr>
                    `).join('');
                },

                renderizarEstudiantes: function() {
                    const grupoId = document.getElementById('selector-grupo')?.value;
                    if (!grupoId) return;

                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const tbody = document.getElementById('estudiantes-list');
                    
                    tbody.innerHTML = estudiantes.map((est, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td contenteditable="true" data-id="${est.id}" data-field="nombreCompleto">${est.nombreCompleto || ''}</td>
                            <td contenteditable="true" data-id="${est.id}" data-field="identificacion">${est.identificacion || ''}</td>
                            <td contenteditable="true" data-id="${est.id}" data-field="telefonoEncargado">${est.telefonoEncargado || ''}</td>
                            <td contenteditable="true" data-id="${est.id}" data-field="email">${est.email || ''}</td>
                            <td><input type="checkbox" ${est.tieneACS ? 'checked' : ''} data-id="${est.id}" class="acs-check"></td>
                            <td><input type="checkbox" ${est.tieneAdecuacionNoSignificativa ? 'checked' : ''} data-id="${est.id}" class="adec-check"></td>
                            <td contenteditable="true" data-id="${est.id}" data-field="observaciones">${est.observaciones || ''}</td>
                            <td>
                                <button class="btn btn-small btn-outline" onclick="UI.eliminarEstudiante('${est.id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');

                    // Eventos para edici√≥n inline
                    tbody.querySelectorAll('[contenteditable="true"]').forEach(el => {
                        el.addEventListener('blur', (e) => {
                            const id = e.target.dataset.id;
                            const field = e.target.dataset.field;
                            const value = e.target.innerText;
                            
                            const estudiante = ModeloMEP.estudiantes.find(e => e.id === id);
                            if (estudiante) {
                                estudiante[field] = value;
                                Repositorio.guardarTodo();
                            }
                        });
                    });

                    // Eventos para checkboxes
                    tbody.querySelectorAll('.acs-check').forEach(cb => {
                        cb.addEventListener('change', (e) => {
                            const id = e.target.dataset.id;
                            const estudiante = ModeloMEP.estudiantes.find(e => e.id === id);
                            if (estudiante) {
                                estudiante.tieneACS = e.target.checked;
                                Repositorio.guardarTodo();
                            }
                        });
                    });

                    tbody.querySelectorAll('.adec-check').forEach(cb => {
                        cb.addEventListener('change', (e) => {
                            const id = e.target.dataset.id;
                            const estudiante = ModeloMEP.estudiantes.find(e => e.id === id);
                            if (estudiante) {
                                estudiante.tieneAdecuacionNoSignificativa = e.target.checked;
                                Repositorio.guardarTodo();
                            }
                        });
                    });
                },

                agregarGrupo: function() {
                    const nombre = document.getElementById('nuevo-grupo').value.trim();
                    if (!nombre) return alert('Ingrese un nombre para el grupo');

                    const nuevoGrupo = {
                        id: Repositorio.generarId(),
                        centroId: ModeloMEP.centros[0]?.id,
                        nombre: nombre,
                        nivel: nombre.split('-')[0] || nombre,
                        a√±o: parseInt(document.getElementById('anio-lectivo').value) || 2025,
                        periodoActivo: "I"
                    };

                    ModeloMEP.grupos.push(nuevoGrupo);
                    Repositorio.guardarTodo();
                    this.actualizarSelectores();
                    document.getElementById('nuevo-grupo').value = '';
                },

                agregarEstudiante: function() {
                    const grupoId = document.getElementById('selector-grupo').value;
                    if (!grupoId) return alert('Seleccione un grupo primero');

                    const nuevoEstudiante = {
                        id: Repositorio.generarId(),
                        centroId: ModeloMEP.centros[0]?.id,
                        grupoId: grupoId,
                        numeroLista: Repositorio.getEstudiantesPorGrupo(grupoId).length + 1,
                        nombreCompleto: "Nuevo Estudiante",
                        identificacion: "",
                        telefonoEncargado: "",
                        email: "",
                        tieneACS: false,
                        tieneAdecuacionNoSignificativa: false,
                        observaciones: "",
                        activo: true
                    };

                    ModeloMEP.estudiantes.push(nuevoEstudiante);
                    Repositorio.guardarTodo();
                    this.renderizarEstudiantes();
                },

                eliminarEstudiante: function(id) {
                    if (confirm('¬øEliminar este estudiante?')) {
                        const index = ModeloMEP.estudiantes.findIndex(e => e.id === id);
                        if (index >= 0) {
                            ModeloMEP.estudiantes.splice(index, 1);
                            Repositorio.guardarTodo();
                            this.renderizarEstudiantes();
                        }
                    }
                },

                exportarEstudiantesCSV: function() {
                    const grupoId = document.getElementById('selector-grupo').value;
                    if (!grupoId) return alert('Seleccione un grupo');

                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const grupo = ModeloMEP.grupos.find(g => g.id === grupoId);

                    let csv = "N√∫mero,Nombre,Identificaci√≥n,Tel√©fono,Correo,ACS,Adecuaci√≥n,Observaciones\n";
                    estudiantes.forEach((est, i) => {
                        csv += `${i+1},"${est.nombreCompleto || ''}","${est.identificacion || ''}","${est.telefonoEncargado || ''}","${est.email || ''}",${est.tieneACS ? 'S√≠' : 'No'},${est.tieneAdecuacionNoSignificativa ? 'S√≠' : 'No'},"${(est.observaciones || '').replace(/"/g, '""')}"\n`;
                    });

                    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `estudiantes_${grupo.nombre}_${new Date().toISOString().slice(0,10)}.csv`;
                    link.click();
                },

                importarEstudiantesCSV: function() {
                    alert('Funcionalidad: Seleccione un archivo CSV con el formato adecuado');
                    // Implementaci√≥n completa requerir√≠a FileReader
                },

                actualizarSelectEstudiantes: function() {
                    const grupoId = document.getElementById('comp-grupo').value;
                    const select = document.getElementById('comp-estudiante');
                    if (!grupoId) return;

                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    select.innerHTML = '<option value="">-- Seleccione --</option>';
                    estudiantes.forEach(est => {
                        select.innerHTML += `<option value="${est.id}">${est.nombreCompleto}</option>`;
                    });
                },

                calcularPromedio: function() {
                    const estudianteId = document.getElementById('comp-estudiante').value;
                    const periodo = document.getElementById('comp-periodo').value;
                    
                    if (!estudianteId) return alert('Seleccione un estudiante');

                    const notas = {
                        trabajoCotidiano: document.getElementById('nota-tc').value,
                        proyecto: document.getElementById('nota-proy').value,
                        prueba: document.getElementById('nota-prueba').value,
                        tareas: document.getElementById('nota-tareas').value
                    };

                    const config = ModeloMEP.configuraciones.find(c => c.periodo === periodo && c.activo) 
                        || ModeloMEP.configuraciones[0];

                    if (!config) return alert('No hay configuraci√≥n para este periodo');

                    try {
                        let promedio;
                        const estudiante = ModeloMEP.estudiantes.find(e => e.id === estudianteId);

                        if (estudiante?.tieneACS) {
                            const formula = document.getElementById('formula-acs').value;
                            promedio = MotorCalculo.calcularPromedioACS(notas, formula);
                        } else {
                            promedio = MotorCalculo.calcularPromedioEstandar(notas, config.porcentajes);
                        }

                        document.getElementById('resultado-calculo').style.display = 'block';
                        document.getElementById('promedio-calculado').innerHTML = `<strong>Promedio:</strong> ${promedio}`;
                        document.getElementById('estado-calculo').innerHTML = `<strong>Estado:</strong> ${MotorCalculo.determinarEstado(promedio)}`;
                    } catch (e) {
                        alert('Error calculando promedio: ' + e.message);
                    }
                },

                guardarCalificaciones: function() {
                    const estudianteId = document.getElementById('comp-estudiante').value;
                    const periodo = document.getElementById('comp-periodo').value;
                    const a√±o = parseInt(document.getElementById('anio-lectivo').value);

                    if (!estudianteId) return alert('Seleccione un estudiante');

                    const calificacion = {
                        id: Repositorio.generarId(),
                        estudianteId: estudianteId,
                        grupoId: document.getElementById('comp-grupo').value,
                        configuracionId: ModeloMEP.configuraciones.find(c => c.periodo === periodo)?.id,
                        periodo: periodo,
                        a√±o: a√±o,
                        notas: {
                            trabajoCotidiano: document.getElementById('nota-tc').value || null,
                            proyecto: document.getElementById('nota-proy').value || null,
                            prueba: document.getElementById('nota-prueba').value || null,
                            tareas: document.getElementById('nota-tareas').value || null
                        },
                        ultimaModificacion: new Date().toISOString()
                    };

                    Repositorio.guardarCalificacion(calificacion);
                    alert('‚úÖ Calificaciones guardadas');
                },

                agregarBitacora: function() {
                    const registro = {
                        id: Repositorio.generarId(),
                        centroId: ModeloMEP.centros[0]?.id,
                        fecha: document.getElementById('bitacora-fecha').value,
                        tema: document.getElementById('bitacora-tema').value,
                        actividad: document.getElementById('bitacora-actividad').value,
                        observaciones: document.getElementById('bitacora-observaciones').value,
                        ajustesDUA: [document.getElementById('bitacora-dua').value],
                        fechaRegistro: new Date().toISOString()
                    };

                    if (!registro.fecha || !registro.tema) {
                        return alert('Fecha y tema son obligatorios');
                    }

                    ModeloMEP.bitacora.push(registro);
                    Repositorio.guardarTodo();
                    this.renderizarBitacora();
                    
                    // Limpiar campos
                    document.getElementById('bitacora-fecha').value = '';
                    document.getElementById('bitacora-tema').value = '';
                    document.getElementById('bitacora-actividad').value = '';
                    document.getElementById('bitacora-observaciones').value = '';
                    document.getElementById('bitacora-dua').value = '';
                },

                renderizarBitacora: function() {
                    const tbody = document.getElementById('bitacora-list');
                    if (!tbody) return;

                    tbody.innerHTML = ModeloMEP.bitacora.slice(-10).reverse().map(reg => `
                        <tr>
                            <td>${reg.fecha}</td>
                            <td>${reg.tema}</td>
                            <td>${reg.actividad || ''}</td>
                            <td>${reg.observaciones || ''}</td>
                            <td>${reg.ajustesDUA?.[0] || ''}</td>
                        </tr>
                    `).join('');
                },

                renderizarInstrumentos: function() {
                    // Implementaci√≥n b√°sica
                },

                ejecutarDiagnostico: function() {
                    const resultados = [];
                    
                    // 1. Validar centros
                    resultados.push(ModeloMEP.centros.length > 0 ? '‚úÖ Centros: OK' : '‚ùå Centros: No hay centros');
                    
                    // 2. Validar grupos
                    resultados.push(ModeloMEP.grupos.length > 0 ? '‚úÖ Grupos: OK' : '‚ùå Grupos: No hay grupos');
                    
                    // 3. Validar estudiantes
                    resultados.push(ModeloMEP.estudiantes.length > 0 ? '‚úÖ Estudiantes: OK' : '‚ö†Ô∏è Estudiantes: No hay estudiantes');
                    
                    // 4. Validar configuraci√≥n
                    resultados.push(ModeloMEP.configuraciones.length > 0 ? '‚úÖ Configuraci√≥n: OK' : '‚ùå Configuraci√≥n: No hay configuraci√≥n');
                    
                    // 5. Validar integridad referencial
                    const errores = Validador.integridadReferencial();
                    resultados.push(errores.length === 0 ? '‚úÖ Integridad: OK' : `‚ö†Ô∏è Integridad: ${errores.length} error(es)`);
                    
                    // 6. Validar periodos
                    const periodosAbiertos = ModeloMEP.periodos.filter(p => p.estado === 'abierto').length;
                    resultados.push(`üìä Periodos abiertos: ${periodosAbiertos}`);

                    const div = document.getElementById('diagnostico-resultado');
                    div.innerHTML = `
                        <div class="card">
                            <h4>Resultado del diagn√≥stico</h4>
                            <ul>
                                ${resultados.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                            <p class="mt-2">Sistema: ${errores.length === 0 ? '‚úÖ Estable' : '‚ö†Ô∏è Requiere atenci√≥n'}</p>
                        </div>
                    `;
                },

                exportarJSON: function() {
                    const data = {
                        version: "2.0",
                        fecha: new Date().toISOString(),
                        centros: ModeloMEP.centros,
                        configuraciones: ModeloMEP.configuraciones,
                        grupos: ModeloMEP.grupos,
                        estudiantes: ModeloMEP.estudiantes,
                        calificaciones: ModeloMEP.calificaciones,
                        instrumentos: ModeloMEP.instrumentos,
                        asistencia: ModeloMEP.asistencia,
                        bitacora: ModeloMEP.bitacora,
                        periodos: ModeloMEP.periodos
                    };

                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `respaldo_mep_${new Date().toISOString().slice(0,10)}.json`;
                    link.click();
                },

                restaurarRespaldo: function() {
                    const file = document.getElementById('importar-json').files[0];
                    if (!file) return alert('Seleccione un archivo JSON');

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (confirm('¬øRestaurar este respaldo? Se perder√°n los datos actuales.')) {
                                ModeloMEP.centros = data.centros || [];
                                ModeloMEP.configuraciones = data.configuraciones || [];
                                ModeloMEP.grupos = data.grupos || [];
                                ModeloMEP.estudiantes = data.estudiantes || [];
                                ModeloMEP.calificaciones = data.calificaciones || [];
                                ModeloMEP.instrumentos = data.instrumentos || [];
                                ModeloMEP.asistencia = data.asistencia || [];
                                ModeloMEP.bitacora = data.bitacora || [];
                                ModeloMEP.periodos = data.periodos || [];
                                
                                Repositorio.guardarTodo();
                                location.reload();
                            }
                        } catch (e) {
                            alert('Error: Archivo JSON inv√°lido');
                        }
                    };
                    reader.readAsText(file);
                },

                consolidarActa: function() {
                    const grupoId = document.getElementById('acta-grupo').value;
                    const a√±o = parseInt(document.getElementById('acta-anio').value);

                    if (!grupoId) return alert('Seleccione un grupo');

                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const validacion = Validador.antesDeCerrarPeriodo(grupoId, "III", a√±o);
                    
                    document.getElementById('acta-validacion').innerHTML = validacion.mensaje;

                    if (!validacion.valido) {
                        return;
                    }

                    // Generar acta simplificada
                    let html = '<div class="card"><h3>Acta Final de Evaluaci√≥n</h3><table class="table"><tr><th>Estudiante</th><th>I Periodo</th><th>II Periodo</th><th>III Periodo</th><th>Promedio</th><th>Estado</th></tr>';

                    estudiantes.forEach(est => {
                        const calI = ModeloMEP.calificaciones.find(c => c.estudianteId === est.id && c.periodo === "I" && c.a√±o === a√±o);
                        const calII = ModeloMEP.calificaciones.find(c => c.estudianteId === est.id && c.periodo === "II" && c.a√±o === a√±o);
                        const calIII = ModeloMEP.calificaciones.find(c => c.estudianteId === est.id && c.periodo === "III" && c.a√±o === a√±o);

                        const promI = calI?.promedioCalculado ? parseFloat(calI.promedioCalculado) : 0;
                        const promII = calII?.promedioCalculado ? parseFloat(calII.promedioCalculado) : 0;
                        const promIII = calIII?.promedioCalculado ? parseFloat(calIII.promedioCalculado) : 0;
                        
                        const promedioAnual = ((promI + promII + promIII) / 3).toFixed(2);
                        const estado = MotorCalculo.determinarEstado(promedioAnual);

                        html += `<tr>
                            <td>${est.nombreCompleto}</td>
                            <td>${promI || '-'}</td>
                            <td>${promII || '-'}</td>
                            <td>${promIII || '-'}</td>
                            <td><strong>${promedioAnual}</strong></td>
                            <td><span class="badge ${estado === 'APROBADO' ? 'badge-success' : estado === 'CONVOCATORIA' ? 'badge-warning' : 'badge-error'}">${estado}</span></td>
                        </tr>`;
                    });

                    html += '</table></div>';
                    document.getElementById('acta-contenido').innerHTML = html;
                },

                generarReporte: function() {
                    const grupoId = document.getElementById('reporte-grupo').value;
                    const periodo = document.getElementById('reporte-periodo').value;
                    const a√±o = parseInt(document.getElementById('reporte-anio').value);

                    if (!grupoId) return alert('Seleccione un grupo');

                    const estudiantes = Repositorio.getEstudiantesPorGrupo(grupoId);
                    const grupo = ModeloMEP.grupos.find(g => g.id === grupoId);

                    let html = `<div class="card">
                        <h3>Reporte de Calificaciones - ${grupo.nombre} - ${periodo} Periodo ${a√±o}</h3>
                        <table class="table">
                            <tr>
                                <th>Estudiante</th>
                                <th>Trabajo Cotidiano</th>
                                <th>Proyecto</th>
                                <th>Prueba</th>
                                <th>Tareas</th>
                                <th>Promedio</th>
                                <th>Estado</th>
                            </tr>`;

                    estudiantes.forEach(est => {
                        const cal = ModeloMEP.calificaciones.find(c => 
                            c.estudianteId === est.id && 
                            c.periodo === periodo && 
                            c.a√±o === a√±o
                        );

                        if (cal) {
                            const promedio = cal.promedioCalculado || MotorCalculo.calcularPromedioEstandar(cal.notas, 
                                ModeloMEP.configuraciones.find(c => c.periodo === periodo)?.porcentajes || 
                                { trabajoCotidiano: 30, proyecto: 20, prueba: 30, tareas: 20 });
                            
                            html += `<tr>
                                <td>${est.nombreCompleto}</td>
                                <td>${cal.notas.trabajoCotidiano || '-'}</td>
                                <td>${cal.notas.proyecto || '-'}</td>
                                <td>${cal.notas.prueba || '-'}</td>
                                <td>${cal.notas.tareas || '-'}</td>
                                <td><strong>${promedio}</strong></td>
                                <td><span class="badge ${parseFloat(promedio) >= 65 ? 'badge-success' : parseFloat(promedio) >= 50 ? 'badge-warning' : 'badge-error'}">${MotorCalculo.determinarEstado(promedio)}</span></td>
                            </tr>`;
                        }
                    });

                    html += '</table></div>';
                    document.getElementById('reporte-contenido').innerHTML = html;
                }
            };

            // =========================================================================
            // INICIALIZACI√ìN DEL SISTEMA
            // =========================================================================
            document.addEventListener('DOMContentLoaded', () => {
                window.UI = UI;
                UI.init();
            });
        })();
    </script>
</body>
</html>
